

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Metamorph Application Program Interface Overview &mdash; Rampart 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Rampart 0.1.0 documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Rampart
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <!-- Local TOC -->
                <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Metamorph Application Program Interface Overview</a><ul>
<li><a class="reference internal" href="#technical-description">Technical Description</a></li>
<li><a class="reference internal" href="#some-search-examples-and-explanations">Some Search Examples and Explanations</a></li>
<li><a class="reference internal" href="#potential-applications">Potential Applications</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-programmers-interface-overview">The Programmers’ Interface Overview</a><ul>
<li><a class="reference internal" href="#the-metamorph-3-api-package">The Metamorph 3 API Package</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metamorph-3-api-functions">Metamorph 3 API functions</a><ul>
<li><a class="reference internal" href="#apicp-variable-definitions">APICP Variable Definitions</a></li>
<li><a class="reference internal" href="#application-notes">Application Notes</a></li>
<li><a class="reference internal" href="#query-processing-and-equivalence-lookup">Query processing and Equivalence lookup</a></li>
<li><a class="reference internal" href="#equivalence-editing-callbacks">Equivalence editing callbacks</a></li>
<li><a class="reference internal" href="#user-equivalence-file-maintenance">User equivalence file maintenance</a></li>
<li><a class="reference internal" href="#edit-commands">Edit commands:</a></li>
<li><a class="reference internal" href="#reprogramming-the-within-operator">Reprogramming the Within Operator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#low-level-pattern-matchers">Low level Pattern Matchers</a></li>
<li><a class="reference internal" href="#windows-addendum">Windows Addendum</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rampart</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Metamorph Application Program Interface Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/api3.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="metamorph-application-program-interface-overview">
<h1>Metamorph Application Program Interface Overview<a class="headerlink" href="#metamorph-application-program-interface-overview" title="Permalink to this headline">¶</a></h1>
<p><em>“Build the power of Metamorph into your application”</em></p>
<p>Metamorph is the only REAL concept based text retrieval product on the
market today. In its stand-alone form it acts as a research assistant
that provides its user with an easy query interface while under the hood
it is performing some of the most complex text search techniques in the
field.</p>
<p><em>What is a Metamorph Search?</em></p>
<p>Metamorph searches for some combination of “lexical sets” within the
bounds of two lexical delimiters. The idea of using set logic is very
important to the way the software works.</p>
<p>When people communicate to each other they rarely use exactly the same
vocabulary when trying to communicate a common idea. Typically, concepts
are communicated by stringing combinations of abstract meanings together
to form a concise idea. For example, if you were trying communicate the
idea of a “nice person” to someone else you might use any of the
following forms:</p>
<ul class="simple">
<li><p>nice guy</p></li>
<li><p>pleasing chap</p></li>
<li><p>agreeable character</p></li>
<li><p>excellent human being</p></li>
<li><p>exceptionally fine person</p></li>
</ul>
<p>While there are subtle differences in each of these phrases, the
underlying concept is the same. It is also worth noting that by
themselves the individual words in each phrase carry little indication
of the whole idea. In a much larger sense, people string these types of
concepts to form heuristically larger and more complex communications.
One ordering of heuristic classifications might be as follows:</p>
<ul class="simple">
<li><p>morpheme (a small token that can be built into a word)</p></li>
<li><p>word</p></li>
<li><p>phrase</p></li>
<li><p>clause</p></li>
<li><p>sentence</p></li>
<li><p>paragraph</p></li>
<li><p>chapter</p></li>
<li><p>book</p></li>
<li><p>collection</p></li>
</ul>
<p>If you are searching for a concept within a body of text, you are
actually searching for an intersection in meaning of your idea of what
you are searching for with/and the body of information you are
searching. Metamorph performs this search operation for you
automatically.</p>
<p>Within Metamorph if you perform the query: <em>Are there power struggles in
the Near East?</em></p>
<p>Metamorph will find the individual “important” terms within your query.
Then, it will look these terms up in a thesaurus that contains over
250,000 associations and it will expand each term to the set of things
that mean approximately the same thing:</p>
<dl class="simple">
<dt>power:</dt><dd><p>ability, jurisdiction, regency, sovereignty, ascendency, justice,
restraint, sway, authority, kingship, scepter, electrify, carte
blanche, leadership, skill, clutches, majesty, strength, command,
mastership, suction, control, mastery, superiority, domination,
militarism, supremacy, dominion, monarchy, vigor, efficiency,
nuclear, fission, weight, electricity, omnipotence, acquisition,
energy, persuasiveness, capability, force, potency, faculty,
hegemony, predominance, function, imperialism, preponderance, might,
influence, pressure, reign,</p>
</dd>
<dt>struggle:</dt><dd><p>battle, contest, combat, flounder, competition, strive, conflict,
effort, exertion, experience, fight, scuffle, strife, attempt, cash,
endeavor, flight, oppose, agonize, compete</p>
</dd>
<dt>Near East:</dt><dd><p>Israel, Jordan, Lebanon, Saudi Arabia, Syria, Turkey, Kuwait,
Iran, Iraq</p>
</dd>
</dl>
<p>After it has built these sets, it will search through the text you have
designated for a place in the text that has all three of the concepts
present within some defined boundary (i.e.; sentence, line, paragraph,
page, chapter, etc.). So, if it was instructed to search by sentence it
would be able to retrieve the following:</p>
<p><em>Iraq’s Sadam Hussein is being pressured by the U.N. to suspend his
endeavors to annex Kuwait.</em></p>
<p>Please Note that Metamorph recognizes that “Near East” is a phrase that
means the countries in the Near East and not the concepts of “near” and
“east” individually. Also, it is not only looking for each of the words
in the lists, but it is also looking for every word-form of the words in
each of the lists.</p>
<div class="section" id="technical-description">
<h2>Technical Description<a class="headerlink" href="#technical-description" title="Permalink to this headline">¶</a></h2>
<p>Within Metamorph a “set” can be any one of four different types of text
data:</p>
<ul class="simple">
<li><p>The set of words or phrases that mean the same thing.</p></li>
<li><p>The set of text patterns that match a regular-expression.</p></li>
<li><p>The set of text patterns that are approximately the same.</p></li>
<li><p>The set of quantities that are within some range.</p></li>
</ul>
<p>There are three types of operations that can be used in conjunction with
any set:</p>
<div class="line-block">
<div class="line">INCLUSION The set must be present.</div>
<div class="line">EXCLUSION The set must not be present.</div>
<div class="line">PERMUTATION X out of Y sets must be present.</div>
</div>
<p>The set logic operations are performed within two boundaries:</p>
<ul class="simple">
<li><p>A starting delimiter (e.g.; the beginning of a sentence).</p></li>
<li><p>An ending delimiter (e.g,; the end of a sentence).</p></li>
</ul>
<p>Each type of set plays an important role in the real-world use of a text
retrieval tool:</p>
<ul class="simple">
<li><p>The word-list pattern matcher can locate any word form of an entire
list of English words and/or phrases.</p></li>
<li><p>The regular-expression pattern matcher allows the user to search for
things like dates, part numbers, social security numbers, and product
codes.</p></li>
<li><p>The approximate pattern matcher can search for things like
misspellings, typos, and names or addresses that are similar.</p></li>
<li><p>The numeric/quantity pattern matcher can look for numeric values that
are present in the text in almost any form and allows the user to
search for them generically by their value.</p></li>
</ul>
<p>The Metamorph search engine will always optimize the search operations
performed so that it will minimize the amount of CPU utilization and
maximize the throughput search rate. At the heart of the Metamorph
search engine lie seven of the most efficient pattern matchers there are
for locating items within text. With the exception of the Approximate
Pattern Matcher, all of these pattern matchers use a proprietary
algorithmic technique that is guaranteed to out-perform any other
published pattern matching algorithm (including those described by
Boyer-Moore-Gosper and Knuth-Pratt-Morris).</p>
<p>Providing the user with set-logic to manipulate combinations of these
set-types gives them the ability to search for just about anything that
they might want to find in their textual information. The query tool in
general can be as simple or sophisticated as the user wishes, with the
simplest query being a simple natural-language question.</p>
</div>
<div class="section" id="some-search-examples-and-explanations">
<h2>Some Search Examples and Explanations<a class="headerlink" href="#some-search-examples-and-explanations" title="Permalink to this headline">¶</a></h2>
<p>Example 1:</p>
<p>Let’s say that we want to search for any occurrence of An Intel 80X86
processor on the same line with the concept of “speed” or “benchmark” as
long as the string “Motorola” is not present.</p>
<p>The query is: <code class="docutils literal notranslate"><span class="pre">+/80=[1-4]?86</span>&#160; <span class="pre">-/motorola</span> <span class="pre">speed</span> <span class="pre">benchmark</span></code></p>
<p>Explanation:</p>
<p>A leading <code class="docutils literal notranslate"><span class="pre">'+'</span></code> means “this must be present”.</p>
<p>A leading <code class="docutils literal notranslate"><span class="pre">'-'</span></code> means “this must not be present”.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">'/'</span></code> signals the use of a regular-expression.</p>
<p><code class="docutils literal notranslate"><span class="pre">'/80=[1-4]?86'</span></code> will locate an <code class="docutils literal notranslate"><span class="pre">'80'</span></code> followed by an optional
<code class="docutils literal notranslate"><span class="pre">('1'</span> <span class="pre">or</span> <span class="pre">'2'</span> <span class="pre">or</span> <span class="pre">'3'</span> <span class="pre">or</span> <span class="pre">'4')</span></code> followed by an <code class="docutils literal notranslate"><span class="pre">'86'</span></code>. This will
locate: <code class="docutils literal notranslate"><span class="pre">8086,</span> <span class="pre">80186,</span> <span class="pre">80286,</span> <span class="pre">80386</span> <span class="pre">or</span> <span class="pre">80486.</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">'/motorola'</span></code> will locate <code class="docutils literal notranslate"><span class="pre">'MOTOROLA'</span></code> or <code class="docutils literal notranslate"><span class="pre">'Motorola'</span></code> or
<code class="docutils literal notranslate"><span class="pre">'motorola'</span></code> (or any other combination of alphabetic cases).</p>
<p><code class="docutils literal notranslate"><span class="pre">'speed'</span></code> will locate any word that means “speed”.</p>
<p><code class="docutils literal notranslate"><span class="pre">'benchmark'</span></code> will locate any word that means “benchmark”.</p>
<p>The beginning and ending delimiting expressions would be defined as
<code class="docutils literal notranslate"><span class="pre">'\n'</span></code> (meaning a new-line character).</p>
<p>The Metamorph search engine will now optimize this search and will
perform the following actions:</p>
<ol class="upperalpha simple">
<li><p>Search for any pattern that matches <code class="docutils literal notranslate"><span class="pre">'/80=[1-4]?86'</span></code>. When it is located do item (B).</p></li>
<li><p>Search backwards for the start delimiter <code class="docutils literal notranslate"><span class="pre">'\n'</span></code> (or begin of file/record whichever comes first).</p></li>
<li><p>Search forwards for the ending delimiter <code class="docutils literal notranslate"><span class="pre">'\n'</span></code> (or end of file/record whichever comes first).</p></li>
<li><p>Search for the pattern <code class="docutils literal notranslate"><span class="pre">'/motorola'</span></code> between the start and end delimiters. If it is <em>not</em> located do item (E), otherwise go to item (A).</p></li>
<li><p>Search for the set of words that mean “benchmark”. If a member is located do item (G), otherwise, do item (F).</p></li>
<li><p>Search for the set of words that mean “speed”. If a member is located do item (G), otherwise, go to item (A).</p></li>
<li><p>Inform the user that a hit has been located.</p></li>
</ol>
<p>Example 2:</p>
<p>Let’s say we are searching an address and phone number list trying to
find an entry for a person whose name has been apparently entered
incorrectly.</p>
<p>The query: <code class="docutils literal notranslate"><span class="pre">&quot;%60</span> <span class="pre">Jane</span> <span class="pre">Plaxton&quot;</span>&#160; <span class="pre">&quot;%60</span> <span class="pre">234</span> <span class="pre">rhoads</span> <span class="pre">dr.&quot;</span>&#160; <span class="pre">/OH</span>&#160; <span class="pre">/49004</span></code></p>
<p>Because our database is large, we want to enter as much as possible
about what we know about Ms. Plaxton so that we decrease the number of
erroneous hits. The actual address in our database looks as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Jane</span> <span class="n">Plxaton</span>
<span class="mi">243</span> <span class="n">Roads</span> <span class="n">Dr</span><span class="o">.</span>
<span class="n">Middle</span> <span class="n">Town</span> <span class="n">OH</span> <span class="mi">49004</span>
</pre></div>
</div>
<p>This is a little exaggerated for reasons of clarity, but what has
happened is that the data-entry operator has transposed the ’x’ and the
’a’ in ’Plaxton’ as well as the ’4’ and ’3’ and has also misspelled
’Rhodes’.</p>
<p>The query we performed has four sets:</p>
<ul class="simple">
<li><p>A 60% approximation of: “Jane Plaxton”</p></li>
<li><p>A 60% approximation of: “234 rhoads dr.”</p></li>
<li><p>The state string : OH</p></li>
<li><p>The zip code string : 49004</p></li>
</ul>
<p>The database records are separated by a blank line, therefore our start
and end delimiters will be <code class="docutils literal notranslate"><span class="pre">'\n\n'</span></code> (two new-line characters).</p>
<p>The Approximate pattern matcher will be looking for the name and street
address information and will match anything that comes within 60matcher
will default to 80regular-expression pattern matcher will be looking for
the state and zip-code strings. We are searching for three intersections
of the four sets (this is the default action).</p>
<p>Example 3:</p>
<p>We are reading the electronic version of the Wall Street Journal and we
are interested in locating any occurrence of profits and/or losses that
amount to more than a million dollars.</p>
<p>The query: <code class="docutils literal notranslate"><span class="pre">+#&gt;1,000,000</span>&#160; <span class="pre">+dollar</span> <span class="pre">&#64;0</span> <span class="pre">profit</span> <span class="pre">loss</span> <span class="pre">gain</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">'+'</span></code> symbol in front of the first two terms indicates that they
must be present in the hit. The <code class="docutils literal notranslate"><span class="pre">'&#64;0</span></code>’ tells Metamorph to find zero
intersections of the following sets. Put another way, only one of the
remaining sets needs to be located.</p>
<p>The sets:</p>
<ul class="simple">
<li><p>Mandatory (because of the <code class="docutils literal notranslate"><span class="pre">'+'</span></code> symbol):</p>
<ul>
<li><p>Any quantity in the text that is greater than one million.</p></li>
<li><p>Any word (or string) that means “dollar”.</p></li>
</ul>
</li>
<li><p>Permutation (because of the <code class="docutils literal notranslate"><span class="pre">'&#64;0'</span></code>):</p>
<ul>
<li><p>Anything that means “profit”.</p></li>
<li><p>Anything that means “loss”.</p></li>
<li><p>Anything that means “gain”.</p></li>
</ul>
</li>
</ul>
<p>We would probably define the delimiters to be either a sentence or a
paragraph.</p>
<p>The following would qualify as hits to this query:</p>
<ul class="simple">
<li><p>Congress has spent 2.5 billion dollars on the stealth bomber.</p></li>
<li><p>Lockheed Corp. has taken a four million dollar contract from Boeing.</p></li>
<li><p>The Lottery income from John Q. Public last week was One Million Two
Hundred and Fifty Thousand dollars and twenty five cents.</p></li>
</ul>
</div>
<div class="section" id="potential-applications">
<h2>Potential Applications<a class="headerlink" href="#potential-applications" title="Permalink to this headline">¶</a></h2>
<p>The nature of our API makes it possible to use Metamorph as a generic
text searching tool no matter where the text resides. Given the quantity
of text that exists on most computers the potential variants are
boundless, but here are some ideas:</p>
<ul class="simple">
<li><p>A method of searching the text field information in databases
(relational or otherwise).</p></li>
<li><p>Document management and control systems.</p></li>
<li><p>Document/record classification systems.</p></li>
<li><p>Real time text analysis.</p></li>
<li><p>E-Mail services.</p></li>
<li><p>Image classification/retrieval databases.</p></li>
<li><p>Message traffic management.</p></li>
<li><p>Educational/instructional aids.</p></li>
<li><p>Executive information systems.</p></li>
<li><p>Research analysis tools.</p></li>
</ul>
</div>
</div>
<div class="section" id="the-programmers-interface-overview">
<h1>The Programmers’ Interface Overview<a class="headerlink" href="#the-programmers-interface-overview" title="Permalink to this headline">¶</a></h1>
<p>There are thousands of stand-alone Metamorph programs in the field
today, and over time we have received many requests by application
developers who would like to be able to embed our searching technology
inside their particular application. It has taken us a long time to
figure out how to provide a simple and clean method to provide a
solution to their problems. We have tried to make it as easy as possible
while providing the maximum power and flexibility.</p>
<p>All of the code that comprises Metamorph has been written in ANSI
compliant ’C’ Language. The source code to the API (only) is provided to
the programmer for reference and modification. Metamorph has currently
been compiled and tested on 22 different UNIX platforms, MS-DOS, and IBM
MVS. The API can be ported by Thunderstone to almost any Machine/OS that
has an ANSI compliant ’C’ compiler.</p>
<p>The set of calls in the API are structured in a fashion similar to
<code class="docutils literal notranslate"><span class="pre">fopen(),</span> <span class="pre">fclose(),</span> <span class="pre">ftell()</span></code>, and <code class="docutils literal notranslate"><span class="pre">gets()</span></code>, standard library
functions. And just like you can have multiple files open at the same
time, you can open as many simultaneous Metamorph queries as needed.
(One reason you might do this is to have a different search in effect
for two different fields of the same record.)</p>
<p>The API itself allows the software engineer to conduct a Metamorph
search through any buffer or file that might contain text. There are two
data structures that are directly involved with the API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">APICP</span>     <span class="o">/*</span> <span class="n">this</span> <span class="n">structure</span> <span class="n">contains</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">control</span> <span class="n">parameters</span> <span class="o">*/</span>
<span class="n">MMAPI</span>       <span class="o">/*</span> <span class="n">this</span> <span class="n">structure</span> <span class="ow">is</span> <span class="n">passed</span> <span class="n">around</span> <span class="n">to</span> <span class="n">the</span> <span class="n">API</span> <span class="n">calls</span> <span class="o">*/</span>
</pre></div>
</div>
<p>The APICP structure contains all the default parameters required by the
API. It is separate from the MMAPI structure so that its contents can be
easily manipulated by the developer. An APICP contains the following
information:</p>
<ul class="simple">
<li><p>A flag telling Metamorph to do suffix processing</p></li>
<li><p>A flag telling it do prefix processing</p></li>
<li><p>A flag that says whether or not to perform word derivations</p></li>
<li><p>The minimum size a word may be processed down to</p></li>
<li><p>The list of suffixes to use in suffix processing</p></li>
<li><p>The list of prefixes to use in prefix processing</p></li>
<li><p>A start delimiter expression</p></li>
<li><p>An end delimiter expression</p></li>
<li><p>A flag indicating to include the starting delimiter in the hit</p></li>
<li><p>A flag indicating to include the ending delimiter in the hit</p></li>
<li><p>A list of high frequency words/phrases to ignore</p></li>
<li><p>The default names of the Thesaurus files</p></li>
<li><p>Two optional, user-written, Thesaurus list editing functions</p></li>
<li><p>The list of suffixes to use in equivs lookup</p></li>
<li><p>A flag indicating to look for the within operator (w/)</p></li>
<li><p>A flag indicating to lookup see references</p></li>
<li><p>A flag indicating to keep equivalences</p></li>
<li><p>A flag indicating to keep noise words</p></li>
<li><p>A user data pointer</p></li>
</ul>
<p>Usually the developer will have no need to modify the contents of this
structure more than one time to tailor it to their application, but in
some applications it will be very desirable to be able to modify its
contents dynamically. Two calls are provided that handle the
manipulation of this structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">APICP</span> <span class="o">*</span> <span class="n">openapicp</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>             <span class="o">/*</span> <span class="n">returns</span> <span class="n">an</span> <span class="n">APICP</span> <span class="n">pointer</span> <span class="o">*/</span>

<span class="n">APICP</span> <span class="o">*</span> <span class="n">closeapicp</span><span class="p">(</span><span class="n">APICP</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>  <span class="o">/*</span> <span class="n">always</span> <span class="n">returns</span> <span class="n">a</span> <span class="n">NULL</span> <span class="n">pointer</span> <span class="o">*/</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">openapicp()</span></code> function creates a structure that contains a set of
default parameters and then returns a pointer to it. The <code class="docutils literal notranslate"><span class="pre">closapicp()</span></code>
function cleans up and releases the memory allocated by the
<code class="docutils literal notranslate"><span class="pre">openapicp()</span></code> function. Between these two calls the application
developer may modify any of the contents of the APICP structure.</p>
<p>There are five function calls that are associated with the actual API
retrieval function; they are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MMAPI</span> <span class="o">*</span><span class="n">openmmapi</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">query</span><span class="p">,</span><span class="n">APICP</span> <span class="o">*</span><span class="n">cp</span><span class="p">)</span>

<span class="nb">int</span>   <span class="n">setmmapi</span><span class="p">(</span><span class="n">MMAPI</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">query</span><span class="p">)</span>

<span class="n">char</span>  <span class="o">*</span><span class="n">getmmapi</span><span class="p">(</span><span class="n">MMAPI</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">endofbuf</span><span class="p">,</span> <span class="nb">int</span> <span class="n">operation</span><span class="p">)</span>

<span class="nb">int</span>   <span class="n">infommapi</span><span class="p">(</span><span class="n">MMAPI</span> <span class="o">*</span><span class="n">mm</span><span class="p">,</span> <span class="nb">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">what</span><span class="p">,</span> <span class="n">char</span> <span class="o">**</span><span class="n">where</span><span class="p">,</span>
                <span class="nb">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>

<span class="n">MMAPI</span> <span class="o">*</span><span class="n">closemmapi</span><span class="p">(</span><span class="n">MMAPI</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code> function takes the set of default parameters from
the APICP structure and builds an MMAPI structure that is ready to be
manipulated by the other four functions. It returns a pointer to this
structure.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> function is passed a standard Metamorph query (see
examples) and does all the processing required to get the API ready to
perform a search that will match the query. If the application program
wishes to, it can define a function that will be called by the
<code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> function to perform editing of the word lists and query
items before the initialization is completed (this is not required).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> function performs the actual search of the data. All
that is required is to pass the <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> function the beginning
and ending locations of the data to be searched. There are two
operations that may be performed with the <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> call;
<code class="docutils literal notranslate"><span class="pre">SEARCHNEWBUF</span></code> and <code class="docutils literal notranslate"><span class="pre">CONTINUESEARCH</span></code>. Because there may be multiple
hits within a single buffer, the <code class="docutils literal notranslate"><span class="pre">search-new-buf</span></code> command tells the
API to locate the first hit, and then by using successive calls with the
command <code class="docutils literal notranslate"><span class="pre">continue-search</span></code> you will locate all the remaining hits in
the buffer.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">infommapi()</span></code> function returns information about a hit to the
caller; it will give the following information:</p>
<ul class="simple">
<li><p>Where the hit is located within the buffer.</p></li>
<li><p>The overall length of the hit.</p></li>
<li><p>For each set in the search that was matched:</p>
<ol class="arabic simple">
<li><p>The query set searched for and located.</p></li>
<li><p>The location of the set item.</p></li>
<li><p>The length of the set item.</p></li>
</ol>
</li>
<li><p>The location and length of the start and end delimiters.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">closemmapi()</span></code> function cleans up and releases the memory
allocated by the <code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code> call.</p>
<p>The last of the important calls in the API is the function that reads
data in from files. While your application may not require this
function, if files are being read in as text streams the use of this
function is mandated.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">rdmmapi</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span><span class="n">FILE</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span><span class="n">MMAPI</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
</pre></div>
</div>
<p>This function works very much like <code class="docutils literal notranslate"><span class="pre">fread()</span></code> with one important
exception; it guarantees that a hit will not be broken across a buffer
boundary. The way it works is as follows:</p>
<ul class="simple">
<li><p>A normal <code class="docutils literal notranslate"><span class="pre">fread(</span></code>) for the number of requested bytes is performed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rdmmapi()</span></code> searches backwards from the end of the buffer for an
occurrence of the ending delimiter regular-expression.</p></li>
<li><p>The data that is beyond the last occurrence of an ending delimiter is
pushed back into the input stream. (The method that is used depends
on whether an <code class="docutils literal notranslate"><span class="pre">fseek()</span></code> can be performed or not.)</p></li>
</ul>
<div class="section" id="the-metamorph-3-api-package">
<h2>The Metamorph 3 API Package<a class="headerlink" href="#the-metamorph-3-api-package" title="Permalink to this headline">¶</a></h2>
<p>The Metamorph 3 API package consists of the following files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api3</span><span class="o">.</span><span class="n">doc</span>   <span class="o">-</span> <span class="n">this</span> <span class="n">documentation</span>
<span class="n">lapi3</span><span class="o">.</span><span class="n">lib</span>  <span class="o">-</span> <span class="n">MS</span><span class="o">-</span><span class="n">DOS</span><span class="p">,</span> <span class="k">for</span> <span class="n">Microsoft</span> <span class="s1">&#39;C&#39;</span> <span class="n">large</span> <span class="n">model</span>
             <span class="n">library</span> <span class="n">containing</span> <span class="nb">all</span> <span class="n">api</span> <span class="n">functions</span>
<span class="n">libapi3</span><span class="o">.</span><span class="n">a</span>  <span class="o">-</span> <span class="n">Unix</span> <span class="n">library</span> <span class="n">containing</span> <span class="nb">all</span> <span class="n">api</span> <span class="n">functions</span>
<span class="n">api3</span><span class="o">.</span><span class="n">h</span>     <span class="o">-</span> <span class="n">header</span> <span class="n">to</span> <span class="n">be</span> <span class="n">included</span> <span class="n">by</span> <span class="nb">any</span> <span class="n">program</span> <span class="n">using</span> <span class="n">Metamorph</span> <span class="mi">3</span> <span class="n">api</span>
<span class="n">api3i</span><span class="o">.</span><span class="n">h</span>    <span class="o">-</span> <span class="n">header</span> <span class="n">automatically</span> <span class="n">included</span> <span class="n">by</span> <span class="n">api3</span><span class="o">.</span><span class="n">h</span>
<span class="n">mmsg</span><span class="o">.</span><span class="n">h</span>     <span class="o">-</span> <span class="n">header</span> <span class="n">automatically</span> <span class="n">included</span> <span class="n">by</span> <span class="n">api3</span><span class="o">.</span><span class="n">h</span>
<span class="n">api3</span><span class="o">.</span><span class="n">c</span>     <span class="o">-</span> <span class="n">source</span> <span class="n">code</span> <span class="n">to</span> <span class="n">the</span> <span class="n">top</span> <span class="n">level</span> <span class="n">api</span> <span class="n">calls</span>
<span class="n">apimmsg</span><span class="o">.</span><span class="n">c</span>  <span class="o">-</span> <span class="n">source</span> <span class="n">code</span> <span class="n">to</span> <span class="n">the</span> <span class="n">default</span> <span class="n">message</span> <span class="n">handler</span>
<span class="n">mmex1</span><span class="o">.</span><span class="n">c</span>    <span class="o">-</span> <span class="n">example</span> <span class="n">source</span> <span class="n">implementing</span> <span class="n">a</span> <span class="n">text</span> <span class="n">search</span> <span class="n">interface</span>
<span class="n">mmex2</span><span class="o">.</span><span class="n">c</span>    <span class="o">-</span> <span class="n">example</span> <span class="n">source</span> <span class="n">implementing</span> <span class="n">a</span> <span class="n">database</span> <span class="n">search</span> <span class="n">interface</span>
<span class="n">mmex2</span><span class="o">.</span><span class="n">dat</span>  <span class="o">-</span> <span class="n">example</span> <span class="n">database</span> <span class="k">for</span> <span class="n">mmex2</span><span class="o">.</span><span class="n">c</span>
<span class="n">readme</span><span class="o">.</span><span class="n">doc</span> <span class="o">-</span> <span class="n">system</span> <span class="n">specific</span> <span class="ow">and</span> <span class="n">installation</span> <span class="n">notes</span>
</pre></div>
</div>
<p>The Metamorph 3 API uses bytes and strings of bytes for most of its
character manipulations. “Byte” is defined, in the API header, as an
unsigned 8 bit quantity (unsigned char) and is used to allow greater
latitude in string contents.</p>
<p>All byte pointers are normal <code class="docutils literal notranslate"><span class="pre">'C'</span></code> strings (pointer to an array of
bytes, terminated by <code class="docutils literal notranslate"><span class="pre">'\0'</span></code>).</p>
<p>All byte pointer lists are arrays of pointers to normal <code class="docutils literal notranslate"><span class="pre">'C'</span></code> strings.
Each list is terminated with an empty string <code class="docutils literal notranslate"><span class="pre">((byte</span> <span class="pre">*)&quot;&quot;)</span></code>.</p>
<p><strong>WARNING:</strong> All APICP strings, string list members, and pointer arrays
will be freed by <code class="docutils literal notranslate"><span class="pre">closeapicp</span></code> if they are <code class="docutils literal notranslate"><span class="pre">!=NULL</span></code>. This includes
the terminator <code class="docutils literal notranslate"><span class="pre">(&quot;&quot;)</span></code> in string lists.</p>
<p>The Metamorph API provides the following functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">closeapicp</span><span class="p">()</span> <span class="o">-</span> <span class="n">control</span> <span class="n">parameters</span> <span class="n">interface</span>
<span class="n">closemmapi</span><span class="p">()</span> <span class="o">-</span> <span class="n">cleanup</span>
<span class="n">closemmsg</span><span class="p">()</span>  <span class="o">-</span> <span class="n">close</span> <span class="n">the</span> <span class="n">message</span> <span class="n">file</span>
<span class="n">fixmmsgfh</span><span class="p">()</span>  <span class="o">-</span> <span class="n">message</span> <span class="n">control</span>
<span class="n">getmmapi</span><span class="p">()</span>   <span class="o">-</span> <span class="n">search</span> <span class="n">routine</span>
<span class="n">infommapi</span><span class="p">()</span>  <span class="o">-</span> <span class="n">hit</span> <span class="n">information</span>
<span class="n">openapicp</span><span class="p">()</span>  <span class="o">-</span> <span class="n">control</span> <span class="n">parameters</span> <span class="n">interface</span>
<span class="n">openmmapi</span><span class="p">()</span>  <span class="o">-</span> <span class="n">initialization</span>
<span class="n">putmsg</span><span class="p">()</span>     <span class="o">-</span> <span class="n">message</span> <span class="n">handler</span>
<span class="n">rdmmapi</span><span class="p">()</span>    <span class="o">-</span> <span class="n">synchronized</span> <span class="n">read</span>
<span class="n">setmmapi</span><span class="p">()</span>   <span class="o">-</span> <span class="n">reinitialization</span>
</pre></div>
</div>
<p>The minimum set of function calls you will use is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">closeapicp</span><span class="p">()</span>
<span class="n">closemmapi</span><span class="p">()</span>
<span class="n">getmmapi</span><span class="p">()</span>
<span class="n">openapicp</span><span class="p">()</span>
<span class="n">openmmapi</span><span class="p">()</span>
</pre></div>
</div>
<p>The Metamorph 3 API needs 3K of stack space in addition to whatever the
calling program uses.</p>
</div>
</div>
<div class="section" id="metamorph-3-api-functions">
<h1>Metamorph 3 API functions<a class="headerlink" href="#metamorph-3-api-functions" title="Permalink to this headline">¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &quot;api3.h&quot;</span>

<span class="n">APICP</span> <span class="o">*</span> <span class="n">openapicp</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>

<span class="n">APICP</span> <span class="o">*</span> <span class="n">closeapicp</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<span class="n">APICP</span> <span class="o">*</span> <span class="n">cp</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Openapicp</span></code> returns a pointer to a structure that contains all of the
default parameters needed by the Metamorph API. Each of the members of
the structure are initialized in a manner that will allow for simple
modification of its contents by the calling program. <code class="docutils literal notranslate"><span class="pre">Closeapicp</span></code>
frees all the memory allocated by <code class="docutils literal notranslate"><span class="pre">openapicp</span></code> and returns an
<code class="docutils literal notranslate"><span class="pre">APICP</span> <span class="pre">*)NULL</span></code>.</p>
<p>The following describes how to modify each of the variable types within
the <code class="docutils literal notranslate"><span class="pre">APICP</span></code> structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">byte</span><span class="p">)</span>    <span class="p">:</span> <span class="n">Direct</span> <span class="n">assignment</span>
            <span class="n">eg</span><span class="p">:</span>  <span class="n">cp</span><span class="o">-&gt;</span><span class="n">suffixproc</span><span class="o">=</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="mi">1</span><span class="p">;</span>

<span class="p">(</span><span class="nb">int</span><span class="p">)</span>     <span class="p">:</span> <span class="n">Direct</span> <span class="n">assignment</span>
            <span class="n">eg</span><span class="p">:</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">minwordlen</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>

<span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span>  <span class="p">:</span> <span class="n">Free</span> <span class="n">original</span> <span class="n">pointer</span> <span class="ow">and</span> <span class="n">assign</span> <span class="n">new</span> <span class="n">allocated</span> <span class="n">pointer</span>
            <span class="n">eg</span><span class="p">:</span> <span class="n">free</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">sdexp</span><span class="p">);</span>
                <span class="n">cp</span><span class="o">-&gt;</span><span class="n">sdexp</span><span class="o">=</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">sdexp</span><span class="p">,</span><span class="s2">&quot;string&quot;</span><span class="p">);</span>

<span class="p">(</span><span class="n">byte</span> <span class="o">**</span><span class="p">)</span> <span class="p">:</span> <span class="n">Free</span> <span class="n">original</span> <span class="n">pointers</span> <span class="ow">and</span> <span class="n">assign</span> <span class="n">new</span> <span class="n">allocated</span> <span class="n">pointers</span>
            <span class="n">eg</span><span class="p">:</span> <span class="c1">#define MYLISTSZ 3</span>
                <span class="n">static</span> <span class="n">char</span> <span class="o">*</span><span class="n">mylist</span><span class="p">[</span><span class="n">MYLISTSZ</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;new&quot;</span><span class="p">,</span><span class="s2">&quot;list&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">};</span>
                <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
                <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="o">*</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
                     <span class="n">free</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                <span class="n">free</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>     <span class="o">/*</span> <span class="n">free</span> <span class="n">empty</span> <span class="n">string</span> <span class="n">at</span> <span class="n">end</span> <span class="o">*/</span>
                <span class="n">free</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">);</span>          <span class="o">/*</span> <span class="n">free</span> <span class="n">the</span> <span class="n">array</span> <span class="n">pointer</span> <span class="o">*/</span>
                <span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="o">=</span><span class="p">(</span><span class="n">byte</span> <span class="o">**</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">MYLISTSZ</span><span class="p">,</span><span class="n">sizeof</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">));</span>
                <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MYLISTSZ</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
                     <span class="p">{</span>
                      <span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                      <span class="n">strcpy</span><span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                     <span class="p">}</span>

<span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)()</span> <span class="p">:</span> <span class="n">Direct</span> <span class="n">assignment</span>
            <span class="n">eg</span><span class="p">:</span>   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">eqedit</span><span class="o">=</span><span class="n">myeditfunction</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>WARNING:</strong> The <code class="docutils literal notranslate"><span class="pre">closeapicp()</span></code> will free all variable pointers. Do
not assign static data pointers or attempt to free any pointers placed
in the <code class="docutils literal notranslate"><span class="pre">APICP</span></code> structure.</p>
<div class="section" id="apicp-variable-definitions">
<h2>APICP Variable Definitions<a class="headerlink" href="#apicp-variable-definitions" title="Permalink to this headline">¶</a></h2>
<p>The following fields are defined in the <code class="docutils literal notranslate"><span class="pre">APICP</span></code> structure:</p>
<ul>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">suffixproc</span></code></div>
<div class="line">Do suffix stripping processing</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">prefixproc</span></code></div>
<div class="line">Do prefix stripping processing</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">rebuild</span></code></div>
<div class="line">Perform the morpheme rebuild check</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">incsd</span></code></div>
<div class="line">Include the start delimiter in the hit</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">inced</span></code></div>
<div class="line">Include the end delimiter in the hit</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">withinproc</span></code></div>
<div class="line">Look for within operator (<code class="docutils literal notranslate"><span class="pre">w/..</span></code>)</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">suffixrev</span></code></div>
<div class="line">Internal Thunderstone use: Strings in suffix list are reversed</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">minwordlen</span></code></div>
<div class="line">Minimum remaining length of a pre/suffix stripped word</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">intersects</span></code></div>
<div class="line">Number of intersections to be located in the hit</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sdexp</span></code></div>
<div class="line">The start delimiter expression</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">edexp</span></code></div>
<div class="line">The end delimiter expression</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">query</span></code></div>
<div class="line">Query from user</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">set</span></code></div>
<div class="line">Array of sets of things being searched for, in equiv format; sets
are in original query order</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">suffix</span></code></div>
<div class="line">The list of suffixes</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">suffixeq</span></code></div>
<div class="line">The list of suffixes for equivalence lookup</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">prefix</span></code></div>
<div class="line">The list of prefixes</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">noise</span></code></div>
<div class="line">The list of words that constitute “noise”</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">eqprefix</span></code></div>
<div class="line">The Path-filename of the main equiv file</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ueqprefix</span></code></div>
<div class="line">The Path-filename of the user equiv file</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">see</span></code></div>
<div class="line">Lookup “see also” references</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">keepeqvs</span></code></div>
<div class="line">Keep equivalences</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">keepnoise</span></code></div>
<div class="line">Keep noise words</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">eqedit</span></code></div>
<div class="line">A user programmable equiv edit function</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">eqedit2</span></code></div>
<div class="line">A user programmable equiv edit function A user settable data
pointer</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">denymode</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">API3DENY</span></code>… mode: how to deny query-protection-forbidden
actions</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">al...</span></code></div>
<div class="line">Flags for allowing/denying query-protection actions</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">qmin</span></code>…, <code class="docutils literal notranslate"><span class="pre">qmax</span></code>…</div>
<div class="line">Query-protection limits</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">defsuffrm</span></code></div>
<div class="line">Whether to remove a trailing vowel, or one of a trailing double
consonant pair, after normal suffix processing, and if the word is
still <code class="docutils literal notranslate"><span class="pre">minwordlen</span></code> or greater. This only has effect if suffix
processing is enabled (<code class="docutils literal notranslate"><span class="pre">suffixproc</span></code> on and the original word is
at least <code class="docutils literal notranslate"><span class="pre">minwordlen</span></code> long)</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">reqsdelim</span></code></div>
<div class="line">Flag indicating start delimiter must be present</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">reqedelim</span></code></div>
<div class="line">Flag indicating end delimiter must be present</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">olddelim</span></code></div>
<div class="line">Flag indicating old delimiter behavior should be used</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">withincount</span></code></div>
<div class="line">Value of integer <code class="docutils literal notranslate"><span class="pre">N</span></code> if within operator was “<code class="docutils literal notranslate"><span class="pre">w/N</span></code>”</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">phrasewordproc</span></code></div>
<div class="line">Phrase word processing mode (<code class="docutils literal notranslate"><span class="pre">API3PHRASEWORD</span></code>… value)</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">textsearchmode</span></code></div>
<div class="line">The <code class="docutils literal notranslate"><span class="pre">TXCFF</span></code> mode for text searches</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">stringcomparemode</span></code></div>
<div class="line">The <code class="docutils literal notranslate"><span class="pre">TXCFF</span></code> mode for string comparisons</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">setqoffs</span></code></div>
<div class="line">List of offsets into original user query, corresponding to
<code class="docutils literal notranslate"><span class="pre">set</span></code>s</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">setqlens</span></code></div>
<div class="line">List of lengths in original user query, corresponding to <code class="docutils literal notranslate"><span class="pre">set</span></code>s</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">originalPrefixes</span></code></div>
<div class="line">List of set-logic, tilde, open-parenthesis, pattern-matcher
character prefixes in original query, corresponding to <code class="docutils literal notranslate"><span class="pre">set</span></code>s;
NULL-terminated</div>
</div>
</li>
<li><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sourceExprLsts</span></code></div>
<div class="line">Each <code class="docutils literal notranslate"><span class="pre">sourceExprLists</span></code> item corresponds to a <code class="docutils literal notranslate"><span class="pre">set</span></code> item, and is
a list of source expressions/terms (before equivalence etc.
processing) from original query for that set; NULL-terminated</div>
</div>
</li>
</ul>
<p><strong>NOTE:</strong> See Metamorph chapter [chp:mmling] for detailed descriptions
of what many of these variables do.</p>
</div>
<div class="section" id="application-notes">
<h2>Application Notes<a class="headerlink" href="#application-notes" title="Permalink to this headline">¶</a></h2>
<p>Generally speaking, the user program will have little need to modify the
contents of the <code class="docutils literal notranslate"><span class="pre">APICP</span></code> structure returned by <code class="docutils literal notranslate"><span class="pre">openapicp()</span></code>. If the
user wishes to permanently modify one or more of the default parameters
it is far easier to directly edit and recompile the <code class="docutils literal notranslate"><span class="pre">api3.c</span></code> file.</p>
<p>The user <code class="docutils literal notranslate"><span class="pre">eqedit</span></code> and <code class="docutils literal notranslate"><span class="pre">eqedit2</span></code> functions are intended for those
applications that wish to process the results of the command
line/thesaurus lookup process before the remainder of the
<code class="docutils literal notranslate"><span class="pre">open/setmmapi()</span></code> processing occurs. This has a similar role to the
<a href="#id1"><span class="problematic" id="id2">``</span></a><code class="docutils literal notranslate"><span class="pre">\</span> <span class="pre">‘EDIT’’‘</span> <span class="pre">knob</span> <span class="pre">inside</span> <span class="pre">the</span> <span class="pre">Metamorph</span> <span class="pre">user</span> <span class="pre">interface.</span> <span class="pre">For</span> <span class="pre">more</span>
<span class="pre">information</span> <span class="pre">see</span> <span class="pre">the</span> <span class="pre">``openmmapi()</span></code> and <code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> documentation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &quot;api3.h&quot;</span>

<span class="n">MMAPI</span> <span class="o">*</span> <span class="n">openmmapi</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="n">cp</span><span class="p">)</span>
<span class="n">char</span>  <span class="o">*</span> <span class="n">query</span><span class="p">;</span>
<span class="n">APICP</span> <span class="o">*</span> <span class="n">cp</span><span class="p">;</span>

<span class="n">MMAPI</span> <span class="o">*</span> <span class="n">closemmapi</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
<span class="n">MMAPI</span> <span class="o">*</span> <span class="n">mm</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Openmmapi</span></code> performs the initialization required to perform a
Metamorph query. It returns a pointer to a structure that will be
required by the <code class="docutils literal notranslate"><span class="pre">getmmapi,</span> <span class="pre">setmmapi,</span></code> and <code class="docutils literal notranslate"><span class="pre">closemmapi</span></code> functions.</p>
<p><code class="docutils literal notranslate"><span class="pre">Openmmapi</span></code> requires two parameters. The first parameter is the user’s
query. The query is a <code class="docutils literal notranslate"><span class="pre">'\0'</span></code> terminated string which has exactly the
same syntax as a query would have within the Metamorph User Interface
with the exception that there is no macro facility. Internally
<code class="docutils literal notranslate"><span class="pre">openmmapi</span></code> calls <code class="docutils literal notranslate"><span class="pre">setmmapi</span></code> if the query is not <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code>.
If the query is <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code> it is up to the programmer to call
<code class="docutils literal notranslate"><span class="pre">setmmapi</span></code> before calling <code class="docutils literal notranslate"><span class="pre">getmmapi</span></code>. The second parameter is the
<code class="docutils literal notranslate"><span class="pre">APICP</span></code> pointer returned by a successful call to <code class="docutils literal notranslate"><span class="pre">openapicp()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setmmapi</span><span class="p">(),</span> <span class="n">openapicp</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &quot;api3.h&quot;</span>

<span class="n">MMAPI</span> <span class="o">*</span> <span class="n">setmmapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="n">query</span><span class="p">)</span>
<span class="n">MMAPI</span> <span class="o">*</span> <span class="n">mm</span><span class="p">;</span>
<span class="n">char</span>  <span class="o">*</span> <span class="n">query</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> takes a pointer to an open <code class="docutils literal notranslate"><span class="pre">MMAPI</span></code> and a query string.
The query is a <code class="docutils literal notranslate"><span class="pre">'\0'</span></code> terminated string which has exactly the same
syntax as a query would have within the Metamorph User Interface with
the exception that there is no macro facility.</p>
<p>The query will be parsed using the <code class="docutils literal notranslate"><span class="pre">APICP</span></code> variables from the
<code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code> call, and following the rules described under “Query
processing and Equivalence lookup”.</p>
<p><code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code>, or <code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code> with a <code class="docutils literal notranslate"><span class="pre">non-(char</span> <span class="pre">*)NULL</span></code> query,
must be called before making calls to <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> returns the mm pointer passed if successful or
<code class="docutils literal notranslate"><span class="pre">MMAPIPN</span></code> if there was an error.</p>
<p><code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &quot;api3.h&quot;</span>

<span class="n">char</span>  <span class="o">*</span> <span class="n">getmmapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="n">buf_start</span><span class="p">,</span><span class="n">buf_end</span><span class="p">,</span><span class="n">operation</span><span class="p">)</span>
<span class="n">MMAPI</span> <span class="o">*</span> <span class="n">mm</span><span class="p">;</span>
<span class="n">char</span>  <span class="o">*</span> <span class="n">buf_start</span><span class="p">;</span>
<span class="n">char</span>  <span class="o">*</span> <span class="n">buf_end</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">operation</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> is passed the <code class="docutils literal notranslate"><span class="pre">MMAPI</span> <span class="pre">*</span></code> returned by <code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code>
function and performs the actual search of the data pointed to by the
<code class="docutils literal notranslate"><span class="pre">buf_start</span></code> and <code class="docutils literal notranslate"><span class="pre">buf_end</span></code> pointers. The operation parameter can
<code class="docutils literal notranslate"><span class="pre">buf_end</span></code>. Successive calls to getmmapi() with the operation be one of
two values: <code class="docutils literal notranslate"><span class="pre">SEARCHNEWBUF</span></code> or <code class="docutils literal notranslate"><span class="pre">CONTINUESEARCH</span></code>. <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> will
return a <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code> if it does not locate a hit within the buffer.
If a hit is located it will return a pointer to the beginning of the
hit.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> is called with the operation parameter set to
<code class="docutils literal notranslate"><span class="pre">SEARCHNEWBUF</span></code>, it will begin its search at <code class="docutils literal notranslate"><span class="pre">buf_start</span></code> and search
through the buffer until it locates a hit or until it reaches
<code class="docutils literal notranslate"><span class="pre">buf_end</span></code>. Successive calls to <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> with the operation
parameter set to <code class="docutils literal notranslate"><span class="pre">CONTINUESEARCH</span></code> will locate all remaining hits
within the bounds set by <code class="docutils literal notranslate"><span class="pre">buf_start</span></code> and <code class="docutils literal notranslate"><span class="pre">buf_end</span></code>.</p>
<p>Typically the sequence of events would look as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">hit</span><span class="p">;</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">my_buffer</span><span class="p">;</span>
 <span class="nb">int</span>   <span class="n">my_buf_size</span><span class="p">;</span>

 <span class="n">MMAPI</span> <span class="o">*</span><span class="n">mm</span><span class="p">;</span>

 <span class="o">...</span>

 <span class="k">for</span><span class="p">(</span><span class="n">hit</span><span class="o">=</span><span class="n">getmmapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="n">my_buffer</span><span class="p">,</span><span class="n">my_buffer</span><span class="o">+</span><span class="n">my_buf_size</span><span class="p">,</span><span class="n">SEARCHNEWBUF</span><span class="p">);</span>
     <span class="n">hit</span><span class="o">!=</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">;</span>
     <span class="n">hit</span><span class="o">=</span><span class="n">getmmapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="n">my_buffer</span><span class="p">,</span><span class="n">my_buffer</span><span class="o">+</span><span class="n">my_buf_size</span><span class="p">,</span><span class="n">CONTINUESEARCH</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="p">{</span>
     <span class="o">/*</span> <span class="n">process</span> <span class="n">the</span> <span class="n">hit</span> <span class="n">here</span> <span class="o">*/</span>
    <span class="p">}</span>
 <span class="o">...</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infommapi</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &quot;api3.h&quot;</span>

<span class="nb">int</span>     <span class="n">infommapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="n">MMAPI</span>  <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">index</span><span class="p">;</span>
<span class="n">char</span>  <span class="o">**</span><span class="n">what</span><span class="p">;</span>
<span class="n">char</span>  <span class="o">**</span><span class="n">where</span><span class="p">;</span>
<span class="nb">int</span>    <span class="o">*</span><span class="n">size</span><span class="p">;</span>
</pre></div>
</div>
<p>After a hit has been located by the <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> function, the calling
program may get information about objects contained within the hit by
passing the <code class="docutils literal notranslate"><span class="pre">MMAPI</span> <span class="pre">*</span></code> to the <code class="docutils literal notranslate"><span class="pre">infommapi()</span></code> function. This call can
provide the following information:</p>
<ul class="simple">
<li><p>Location and length of the entire hit.</p></li>
<li><p>Location and length of the start delimiter.</p></li>
<li><p>Location and length of the end delimiter.</p></li>
<li><p>For each set in the search that was matched:</p>
<ul>
<li><p>The query set searched for and located.</p></li>
<li><p>The location of the set item.</p></li>
<li><p>The length of the set item.</p></li>
</ul>
</li>
</ul>
<p>The idea behind <code class="docutils literal notranslate"><span class="pre">infommapi()</span></code> is to provide the caller with a
structured method for obtaining information about a hit that was located
with the <code class="docutils literal notranslate"><span class="pre">getmmapi()</span></code> call. The index parameter and the return code
are used to “walk” through the items that were located. Information
about each item is placed into the variables pointed to by the what,
where and size parameters. A return value of <code class="docutils literal notranslate"><span class="pre">-1</span></code> indicates a usage
error, <code class="docutils literal notranslate"><span class="pre">0</span></code> indicates that the index is out of range, and <code class="docutils literal notranslate"><span class="pre">1</span></code>
indicates that the index was in range and the data is valid.</p>
<p>Index values and what they return:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">infommapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span>
<span class="n">what</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">query</span> <span class="n">that</span> <span class="n">was</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">the</span> <span class="n">openmmapi</span><span class="p">()</span>
       <span class="n">call</span><span class="o">.</span>
<span class="n">where</span><span class="p">:</span> <span class="n">Will</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">the</span> <span class="n">hit</span> <span class="n">within</span> <span class="n">the</span> <span class="n">buffer</span> <span class="n">being</span>
       <span class="n">searched</span><span class="o">.</span>
<span class="n">size</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">overall</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">located</span> <span class="n">hit</span><span class="o">.</span>

<span class="n">infommapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span>
<span class="n">what</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">start</span> <span class="n">delimiter</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">use</span><span class="o">.</span>
<span class="n">where</span><span class="p">:</span> <span class="n">Will</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">start</span> <span class="n">delimiter</span><span class="o">.</span>
<span class="n">size</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">overall</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">located</span> <span class="n">delimiter</span><span class="o">.</span>
       <span class="n">size</span> <span class="n">will</span> <span class="n">be</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">where</span> <span class="n">will</span> <span class="n">be</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span> <span class="k">if</span> <span class="n">the</span> <span class="n">hit</span> <span class="ow">is</span> <span class="n">at</span>
       <span class="n">the</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">the</span> <span class="n">buffer</span> <span class="ow">or</span> <span class="n">immediately</span> <span class="n">after</span> <span class="n">the</span> <span class="n">previous</span>
       <span class="n">hit</span><span class="o">.</span>

<span class="n">infommapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span>
<span class="n">what</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">the</span> <span class="n">end</span> <span class="n">delimiter</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">use</span><span class="o">.</span>
<span class="n">where</span><span class="p">:</span> <span class="n">Will</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">location</span> <span class="n">of</span> <span class="n">end</span> <span class="n">delimiter</span><span class="o">.</span>
<span class="n">size</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">overall</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">located</span> <span class="n">delimiter</span><span class="o">.</span>
       <span class="n">size</span> <span class="n">will</span> <span class="n">be</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">where</span> <span class="n">will</span> <span class="n">be</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span> <span class="k">if</span> <span class="n">the</span> <span class="n">hit</span> <span class="ow">is</span> <span class="n">at</span>
       <span class="n">the</span> <span class="n">end</span> <span class="n">of</span> <span class="n">the</span> <span class="n">search</span> <span class="n">buffer</span> <span class="ow">and</span> <span class="n">no</span> <span class="n">end</span> <span class="n">delimiter</span> <span class="n">was</span> <span class="n">found</span> <span class="ow">in</span>
       <span class="n">the</span> <span class="n">buffer</span><span class="o">.</span>

<span class="n">infommapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="p">[</span><span class="mf">3.</span><span class="o">..</span><span class="n">n</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span>
<span class="n">what</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">first</span> <span class="s2">&quot;set&quot;</span> <span class="n">being</span> <span class="n">searched</span> <span class="k">for</span><span class="p">;</span>

<span class="nb">set</span> <span class="nb">type</span>    <span class="n">what</span> <span class="n">points</span> <span class="n">to</span>
<span class="o">--------</span>    <span class="o">--------------------------</span>
<span class="n">REX</span>         <span class="n">A</span> <span class="n">regular</span> <span class="n">expression</span>
<span class="n">NPM</span>         <span class="n">The</span> <span class="n">npm</span> <span class="n">query</span> <span class="n">expression</span>
<span class="n">PPM</span>         <span class="n">The</span> <span class="n">root</span> <span class="n">word</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">words</span>
<span class="n">XPM</span>         <span class="n">The</span> <span class="s2">&quot;approximate&quot;</span> <span class="n">string</span>

<span class="n">where</span><span class="p">:</span> <span class="n">Will</span> <span class="n">point</span> <span class="n">to</span> <span class="n">the</span> <span class="n">buffer</span> <span class="n">location</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">set</span><span class="o">-</span><span class="n">element</span><span class="o">.</span>
<span class="n">size</span> <span class="p">:</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">the</span> <span class="n">overall</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">located</span> <span class="nb">set</span><span class="o">-</span><span class="n">element</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="n">MMAPI</span>  <span class="o">*</span><span class="n">mm</span><span class="p">;</span>
 <span class="n">char</span>   <span class="o">*</span><span class="n">what</span><span class="p">,</span> <span class="o">*</span><span class="n">where</span><span class="p">;</span>
 <span class="nb">int</span>    <span class="n">size</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

 <span class="o">...</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="n">infommapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">what</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">where</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">index</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
       <span class="n">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>
           <span class="p">{</span>
            <span class="n">case</span> <span class="mi">0</span> <span class="p">:</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The Query: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The hit  :&quot;</span><span class="p">);</span>
               <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">,</span> <span class="n">where</span><span class="o">++</span><span class="p">)</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">where</span><span class="p">);</span>
               <span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="n">case</span> <span class="mi">1</span> <span class="p">:</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The start delimiter expression: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The start delimiter located   :&quot;</span><span class="p">);</span>
               <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">,</span> <span class="n">where</span><span class="o">++</span><span class="p">)</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">where</span><span class="p">);</span>
               <span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="n">case</span> <span class="mi">2</span> <span class="p">:</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The end delimiter expression: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The end delimiter located   :&quot;</span><span class="p">);</span>
               <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">,</span> <span class="n">where</span><span class="o">++</span><span class="p">)</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">where</span><span class="p">);</span>
               <span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="n">default</span><span class="p">:</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;set </span><span class="si">%d</span><span class="s2"> expression: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">what</span><span class="p">);</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;The set located  :&quot;</span><span class="p">);</span>
               <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span><span class="o">--</span><span class="p">,</span> <span class="n">where</span><span class="o">++</span><span class="p">)</span> <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">where</span><span class="p">);</span>
               <span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>
               <span class="k">break</span><span class="p">;</span>
           <span class="p">}</span>
      <span class="p">}</span>
 <span class="o">...</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">getmmapi</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>    <span class="n">rdmmapi</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">bufsize</span><span class="p">,</span><span class="n">fp</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span>
<span class="n">char</span>  <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="nb">int</span>    <span class="n">bufsize</span><span class="p">;</span>
<span class="n">FILE</span>  <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
<span class="n">MMAPI</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>

<span class="nb">bool</span> <span class="n">freadex_strip8</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">buf</span>            <span class="n">where</span> <span class="n">to</span> <span class="n">put</span> <span class="n">the</span> <span class="n">data</span>
<span class="n">bufsize</span>        <span class="n">the</span> <span class="n">maximum</span> <span class="n">number</span> <span class="n">of</span> <span class="nb">bytes</span> <span class="n">that</span> <span class="n">will</span> <span class="n">fit</span> <span class="ow">in</span> <span class="n">buf</span>
<span class="n">fp</span>             <span class="n">the</span> <span class="n">file</span> <span class="n">to</span> <span class="n">read</span> <span class="kn">from</span> <span class="nn">which</span> <span class="n">must</span> <span class="n">be</span> <span class="n">opened</span> <span class="n">binary</span> <span class="p">(</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">mp</span>             <span class="n">the</span> <span class="n">Metamorph</span> <span class="mi">3</span> <span class="n">API</span> <span class="n">to</span> <span class="n">synchronize</span> <span class="k">for</span>

<span class="n">freadex_strip8</span> <span class="n">controls</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">high</span> <span class="n">bit</span> <span class="n">will</span> <span class="n">be</span> <span class="n">stripped</span> <span class="kn">from</span>
               <span class="nn">incoming</span> <span class="n">data</span>
</pre></div>
</div>
<p>This function works very much like <code class="docutils literal notranslate"><span class="pre">fread()</span></code> with one important
exception; it guarantees that a hit will not be broken across a buffer
boundary. The way it works is as follows:</p>
<ol class="arabic simple">
<li><p>A normal <code class="docutils literal notranslate"><span class="pre">fread()</span></code> for the number of requested bytes is performed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rdmmapi()</span></code> searches backwards from the end of the buffer for an
occurrence of the ending delimiter regular expression.</p></li>
<li><p>The data that is beyond the last occurrence of an ending delimiter is
pushed back into the input stream. (The method that is used depends
on whether an <code class="docutils literal notranslate"><span class="pre">fseek()</span></code> can be performed or not.)</p></li>
</ol>
<p>If the <code class="docutils literal notranslate"><span class="pre">freadex_strip8</span></code> global variable is non-zero the 8th bit will
be stripped off all of the incoming data. This is useful for reading
WordStar(C) and other files that set the high bit. Setting
<code class="docutils literal notranslate"><span class="pre">freadex_strip8</span></code> incurs a speed penalty because every byte read gets
stripped. Don’t use this flag unless it is absolutely necessary.</p>
<p><code class="docutils literal notranslate"><span class="pre">rdmmapi()</span></code> should be used any time you are doing delimited searches.
An unsynchronized read can cause hits to be missed.</p>
<p><code class="docutils literal notranslate"><span class="pre">rdmmapi()</span></code> returns the number of bytes actually read into <code class="docutils literal notranslate"><span class="pre">buf</span></code> or
<code class="docutils literal notranslate"><span class="pre">(-1)</span></code> if there was an error.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include ``api3.h&#39;&#39;</span>
<span class="c1">#include ``mmsg.h&#39;&#39;</span>
<span class="c1">#include ``cgi.h&#39;&#39;</span>

<span class="nb">int</span>  <span class="n">putmsg</span><span class="p">(</span><span class="n">msgn</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">fmt</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="nb">int</span>  <span class="n">msgn</span><span class="p">;</span>
<span class="n">char</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>
<span class="n">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

<span class="n">FILE</span> <span class="o">*</span><span class="n">mmsgfh</span><span class="p">;</span>
<span class="n">char</span> <span class="o">*</span><span class="n">mmsgfname</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msgn</span>  <span class="ow">is</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">the</span> <span class="n">message</span> <span class="ow">or</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span>
<span class="n">fn</span>    <span class="ow">is</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">function</span> <span class="n">issuing</span> <span class="n">the</span> <span class="n">message</span> <span class="ow">or</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="o">.</span>
<span class="n">fmt</span>   <span class="ow">is</span> <span class="n">the</span> <span class="n">htpf</span><span class="p">()</span> <span class="nb">format</span> <span class="p">(</span><span class="n">similar</span> <span class="n">to</span> <span class="n">printf</span><span class="p">()</span> <span class="n">but</span> <span class="n">extended</span><span class="p">)</span><span class="o">.</span>
<span class="o">...</span>   <span class="ow">is</span> <span class="n">the</span> <span class="n">argument</span> <span class="nb">list</span> <span class="k">for</span> <span class="n">fmt</span> <span class="k">if</span> <span class="n">necessary</span><span class="o">.</span>
</pre></div>
</div>
<p>These functions handle all output from the Metamorph API. The API
reports its status periodically at points of interest. Each message has
a number associated with it that indicates what type of message it is.
Left alone the Metamorph API will generate message file output just like
the Metamorph 3 product.</p>
<p>Messages consist of four basic parts:</p>
<ol class="arabic simple">
<li><p>the message number followed by a space</p></li>
<li><p>the text of the message</p></li>
<li><p>the name of the function issuing the message</p></li>
<li><p>a newline.</p></li>
</ol>
<p>Message numbers are broken into various levels or types. The levels are
grouped in hundreds. The levels are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">000</span><span class="o">-</span><span class="mi">099</span>  <span class="n">messages</span> <span class="n">indicate</span> <span class="n">total</span> <span class="n">failure</span> <span class="n">of</span> <span class="n">the</span> <span class="n">process</span>
<span class="mi">100</span><span class="o">-</span><span class="mi">199</span>  <span class="n">messages</span> <span class="n">indicate</span> <span class="n">potential</span> <span class="n">failure</span> <span class="ow">or</span> <span class="n">hazard</span> <span class="n">to</span> <span class="n">the</span> <span class="n">process</span>
<span class="mi">200</span><span class="o">-</span><span class="mi">299</span>  <span class="n">messages</span> <span class="n">are</span> <span class="n">informative</span> <span class="n">messages</span> <span class="n">on</span> <span class="n">the</span> <span class="n">operation</span> <span class="n">of</span> <span class="n">a</span> <span class="n">process</span>
<span class="mi">300</span><span class="o">-</span><span class="mi">399</span>  <span class="n">messages</span> <span class="n">are</span> <span class="n">hit</span> <span class="n">information</span> <span class="n">coming</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">Metamorph</span> <span class="mi">3</span> <span class="n">engine</span>
<span class="mi">400</span><span class="o">-</span><span class="mi">499</span>  <span class="n">messages</span> <span class="n">are</span> <span class="n">non</span><span class="o">-</span><span class="n">error</span> <span class="n">messages</span> <span class="n">coming</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">mindex</span> <span class="n">engine</span>
<span class="mi">500</span><span class="o">-</span><span class="mi">599</span>  <span class="n">messages</span> <span class="n">about</span> <span class="n">query</span><span class="o">/</span><span class="n">hit</span> <span class="n">logic</span>
<span class="mi">600</span><span class="o">-</span><span class="mi">699</span>  <span class="n">query</span> <span class="n">information</span><span class="o">/</span><span class="n">debugging</span> <span class="n">info</span>
<span class="mi">700</span><span class="o">-</span><span class="mi">999</span>  <span class="n">undefined</span> <span class="k">as</span> <span class="n">yet</span> <span class="p">(</span><span class="n">reserved</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Output formatting:</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> will output msgn formatted with <code class="docutils literal notranslate"><span class="pre">%03d</span></code> if <code class="docutils literal notranslate"><span class="pre">msgn!=(-1)</span></code>,
followed by the results of fmt and its arguments if
<code class="docutils literal notranslate"><span class="pre">fmt!=(char</span> <span class="pre">*)NULL</span></code>, followed by fn formatted with “in the function:
<code class="docutils literal notranslate"><span class="pre">%s</span></code>” if <code class="docutils literal notranslate"><span class="pre">fn!=(char</span> <span class="pre">*)NULL</span></code>, followed by a newline. The output
buffer is flushed to disk after every message so that any process
reading the message file will always be able to get the latest messages.</p>
<p><strong>Summary of formatting control:</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">to</span> <span class="n">suppress</span> <span class="n">msgn</span> <span class="p">:</span> <span class="k">pass</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">to</span> <span class="n">suppress</span> <span class="n">fn</span>   <span class="p">:</span> <span class="k">pass</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span>
<span class="n">to</span> <span class="n">suppress</span> <span class="n">fmt</span>  <span class="p">:</span> <span class="k">pass</span> <span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span>
</pre></div>
</div>
<p><strong>Output destination:</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> and <code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code> control where <code class="docutils literal notranslate"><span class="pre">putmsg(</span></code>) will send its
output. Each time <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> or <code class="docutils literal notranslate"><span class="pre">datamsg()</span></code> is called they will
attempt to make <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> point to a legal file, named by
<code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code>, and send their output there. Setting <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> is
accomplished by the function <code class="docutils literal notranslate"><span class="pre">fixmmsgfh()</span></code> (See <a href="#id3"><span class="problematic" id="id4">``</span></a><a href="#id5"><span class="problematic" id="id6">``</span></a>‘putmsg()‘
extensions’’). How it works is described below.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> becomes <code class="docutils literal notranslate"><span class="pre">(FILE</span> <span class="pre">*)NULL</span></code> or the name pointed to by
<code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code> changes <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> will be closed, if it was not
<code class="docutils literal notranslate"><span class="pre">(FILE</span> <span class="pre">*)NULL</span></code>, and reopened for binary append with the new
<code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code>. If the open fails <code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code> will be set to point to
<code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>,the empty string, <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> will be set to <code class="docutils literal notranslate"><span class="pre">stderr</span></code>, and a
warning message will be be issued via <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code>. Only the first 127
characters in <code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code> will be remembered between calls, so changes
beyond that point will not be noticed.</p>
<p>If you want to set <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> yourself and not have it changed set
<code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code> to <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code>. This will preempt the checks
described above. <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> will, however, be checked for
<code class="docutils literal notranslate"><span class="pre">(FILE</span> <span class="pre">*)NULL</span></code> and will be reset to <code class="docutils literal notranslate"><span class="pre">stderr</span></code> if it is.</p>
<p>The initial setting for <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> is (<code class="docutils literal notranslate"><span class="pre">FILE</span> <span class="pre">*)NULL</span></code> and the initial
setting for <code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code> is <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code>. This will, by default,
cause all output to go to <code class="docutils literal notranslate"><span class="pre">stderr</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">call</span><span class="p">:</span>
   <span class="n">putmsg</span><span class="p">(</span><span class="n">MERR</span><span class="p">,</span><span class="s2">&quot;parse expression&quot;</span><span class="p">,</span><span class="s2">&quot;invalid escapement&quot;</span><span class="p">);</span>
<span class="n">output</span><span class="p">:</span>
   <span class="mi">000</span> <span class="n">invalid</span> <span class="n">escapement</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span> <span class="n">parse</span> <span class="n">expression</span>\<span class="n">n</span>

<span class="n">call</span><span class="p">:</span>
   <span class="n">putmsg</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s2">&quot;parse expression&quot;</span><span class="p">,</span><span class="s2">&quot;invalid escapement&quot;</span><span class="p">);</span>
<span class="n">output</span><span class="p">:</span>
   <span class="n">invalid</span> <span class="n">escapement</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">function</span> <span class="n">parse</span> <span class="n">expression</span>\<span class="n">n</span>

<span class="n">call</span><span class="p">:</span>
   <span class="n">char</span> <span class="o">*</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;myfile&quot;</span><span class="p">;</span>
   <span class="n">putmsg</span><span class="p">(</span><span class="n">MERR</span><span class="o">+</span><span class="n">FOE</span><span class="p">,(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">,</span><span class="s2">&quot;can&#39;t open file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">filename</span><span class="p">);</span>
<span class="n">output</span><span class="p">:</span>
   <span class="mi">002</span> <span class="n">can</span><span class="s1">&#39;t open file myfile</span><span class="se">\n</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code> for success or <code class="docutils literal notranslate"><span class="pre">-1</span></code> if there was an error
writing the output file. If there was an error the standard library
variable errno may be checked for the reason. The output file will <em>not</em>
be closed if there is an error.</p>
<p><code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> may be overridden by writing your own function with the
same name, arguments and return value so that messages can be handled in
an application specific manner.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> outputs a newline it will be the correct type for the
host operating system (CRLF on MS-DOS, LF on Unix).</p>
<p><strong>MS-DOS applications:</strong></p>
<p>MS-DOS does not allow real multi-tasking so the contents of the message
file will not become available to another program until the message file
is closed (this is an MS-DOS limitation). To read the message file while
a search is in progress you must access <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> directly. If you move
the <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> file position by seeking, remember to reposition it to
the end with <code class="docutils literal notranslate"><span class="pre">fseek(mmsgfh,0L,SEEK_SET)</span></code> before allowing the Metamorph
3 API to continue.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apimmsg</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">apimmsg</span><span class="o">.</span><span class="n">h</span> <span class="k">for</span> <span class="n">specific</span> <span class="n">message</span> <span class="n">numbers</span> <span class="ow">and</span> <span class="n">their</span> <span class="n">macros</span>
<span class="n">putmsg</span><span class="p">()</span> <span class="n">extensions</span>
<span class="n">putmsg</span><span class="p">()</span> <span class="n">replacement</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">closemmsg</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>

<span class="n">void</span> <span class="n">fixmmsgfh</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
</pre></div>
</div>
<p>These are some useful extensions to the <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> family of functions
that provide more flexibility to programmers. They are not used directly
by the Metamorph 3 API.</p>
<p><code class="docutils literal notranslate"><span class="pre">closemmsg()</span></code> closes the message file and should be called before
exiting any application that uses <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> or the Metamorph 3 API.
It may also be called in the middle of an application to flush the
message file buffers to disk or force the message file to be reopened on
the next call to <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code>. If mmsgfh is <code class="docutils literal notranslate"><span class="pre">stderr</span></code>, it will not be
closed, but the next <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> call will still force a reopen. It is
safe to call <code class="docutils literal notranslate"><span class="pre">closemmsg()</span></code> at any time because it will not attempt to
close a file that is already closed or has never been opened.</p>
<p><code class="docutils literal notranslate"><span class="pre">fixmmsgfh()</span></code> is called by <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> before any output is
attempted. It guarantees that <code class="docutils literal notranslate"><span class="pre">mmsgfh</span></code> points somewhere legal based on
<code class="docutils literal notranslate"><span class="pre">mmsgfname</span></code>. See “Output destination” in the <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> description.
<code class="docutils literal notranslate"><span class="pre">fixmmsgfh()</span></code> will probably not be needed by API users because
<code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> supplies ample output functionality.</p>
<p>If you use any of these functions and replace <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> you will have
to write your own replacements for the extensions. All of the
<code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> functions are in the same object module within the library.
Therefore, calling any one of the functions will cause all of them to be
brought in by the linker, which will then cause a clash if you have your
own version of <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">putmsg</span><span class="p">()</span>
<span class="n">putmsg</span><span class="p">()</span> <span class="n">replacement</span>
</pre></div>
</div>
<p>Normally all Metamorph 3 API output goes to <code class="docutils literal notranslate"><span class="pre">stderr</span></code> or a disk file.
But, depending on your application, this may not be desirable. You may
wish to send all messages to a special alternate window under a
graphical environment or process the messages as they occur and take
immediate action based on the type of message. You may also want to
filter the messages so that only errors and warnings get displayed.
Whatever your reason, <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> may be replaced.</p>
<p>Since <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> takes a variable number of arguments it must be
written using <code class="docutils literal notranslate"><span class="pre">vararg</span></code>s or the ANSI <code class="docutils literal notranslate"><span class="pre">stdarg</span></code>, if you prefer (see
your ’C’ manual). Only the v<code class="docutils literal notranslate"><span class="pre">arargs</span></code> method will be documented here.
The core is the same either way; the only variation is how you go about
getting the function arguments.</p>
<p>There are three arguments that are always present. The first argument is
a message number of type <code class="docutils literal notranslate"><span class="pre">(int)</span></code>. The second argument is a function
name of type <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)</span></code>. The third argument is a <code class="docutils literal notranslate"><span class="pre">htpf()</span></code> format
string of type <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)</span></code>. <code class="docutils literal notranslate"><span class="pre">htpf()</span></code> is a Thunderstone function
similar to <code class="docutils literal notranslate"><span class="pre">printf()</span></code>, but with extended flags and codes: the <code class="docutils literal notranslate"><span class="pre">fmt</span></code>
argument should always be printed with an <code class="docutils literal notranslate"><span class="pre">htpf()</span></code>-family function and
not <code class="docutils literal notranslate"><span class="pre">printf()</span></code>-family because some messages may utilize these extended
flags and codes. Any remaining arguments are as required by the
<code class="docutils literal notranslate"><span class="pre">htpf()</span></code> format string.</p>
<p><code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> returns whether there was an error outputting the message
or not. A return of <code class="docutils literal notranslate"><span class="pre">0</span></code> means there was not an error. A return of
<code class="docutils literal notranslate"><span class="pre">non-0</span></code> means there was an error.</p>
<p>All of the macros needed for <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> are in the header
<code class="docutils literal notranslate"><span class="pre">&quot;mmsg.h&quot;</span></code>. <code class="docutils literal notranslate"><span class="pre">&quot;api3.h&quot;</span></code> automatically #include’s <code class="docutils literal notranslate"><span class="pre">&quot;mmsg.h&quot;</span></code>. If you
put <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> in its own source file just use <code class="docutils literal notranslate"><span class="pre">&quot;mmsg.h&quot;</span></code>. If you
put <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> in the same file as Metamorph API calls or call the API
from <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> use <code class="docutils literal notranslate"><span class="pre">&quot;api3.h&quot;</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*
** This implementation will *ONLY* output errors(MERR) and
** warnings(MWARN).
** It will output &quot;ERROR:&quot; or &quot;WARNING:&quot; instead of a message number.
** It will always send its output to stderr.
** Function names will not be printed.
*/

#include &lt;stdio.h&gt;
#include &lt;varargs.h&gt;        /* for variable argument list handling */
#include &quot;mmsg.h&quot;                                   /* or &quot;api3.h&quot; */
#include &quot;cgi.h&quot;                        /* for htvfpf()  prototype */

int
putmsg(va_alist)                    /* args: msgn,funcname,fmt,... */
va_dcl       /* no semicolon allowed! - just the way varargs works */
{
va_list args;       /* for variable argument list handling         */
int        n;       /* the message number (may be -1)              */
char     *fn;       /* the function name (may be NULL)             */
char    *fmt;       /* the htpf type format string (may be NULL) */
int level;                               /* message hundreds level */

                                        /* get the fixed arguments */
   va_start(args);      /* initialize variable argument list usage */
   n  =va_arg(args,int   );                      /* message number */
   fn =va_arg(args,char *);                      /* function name  */
   fmt=va_arg(args,char *);                      /* htpf format    */

   if(n&gt;=0){                          /* is there a message number */
      level=n-(n%100);           /* clear the tens and ones places */
                                 /* to get the hundreds level      */
      if(level==MERR || level==MWARN){ /* only do error or warning */
         if(level==MERR) fputs(&quot;ERROR: &quot;  ,stderr);
         else            fputs(&quot;WARNING: &quot;,stderr);
         if(fmt!=(char *)NULL){           /* is there message text */
            htvfpf(stderr,fmt,args);  /* print the message content */
                                      /* using the varargs version */
                                      /* of htpf(): htvfpf()       */
         }
         fputc(&#39;\n&#39;,stderr);                 /* print the new line */
      }
   }
   va_end(args);         /* terminate variable argument list usage */
   return(0);                                         /* return OK */
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> extensions need not be replaced if you are not going to
use them because the API does not use them. If you do use any extensions
you must also replace the ones that you use to avoid linker clashes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">putmsg</span><span class="p">()</span>
<span class="n">apimmsg</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">mmsg</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
</div>
<div class="section" id="query-processing-and-equivalence-lookup">
<h2>Query processing and Equivalence lookup<a class="headerlink" href="#query-processing-and-equivalence-lookup" title="Permalink to this headline">¶</a></h2>
<p>Query processing and equivalence lookup occur in <code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> and
<code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code> if <code class="docutils literal notranslate"><span class="pre">query!=(byte</span> <span class="pre">*)NULL</span></code>.</p>
<p>Control query parsing and equivalence lookup with the following APICP
variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span>  <span class="o">*</span><span class="n">query</span>
  <span class="p">:</span> <span class="n">The</span> <span class="n">user</span> <span class="n">query</span> <span class="n">interpret</span> <span class="ow">and</span> <span class="n">get</span> <span class="n">equivalences</span> <span class="k">for</span><span class="o">.</span>

<span class="n">byte</span>  <span class="o">*</span><span class="n">eqprefix</span>
  <span class="p">:</span> <span class="n">The</span> <span class="n">main</span> <span class="n">equivalence</span> <span class="n">file</span> <span class="n">name</span><span class="o">.</span>

<span class="n">byte</span>  <span class="o">*</span><span class="n">ueqprefix</span>
  <span class="p">:</span> <span class="n">The</span> <span class="n">user</span> <span class="n">equivalence</span> <span class="n">file</span> <span class="n">name</span><span class="o">.</span>

<span class="n">byte</span>   <span class="n">see</span>
  <span class="p">:</span> <span class="n">Flag</span> <span class="n">that</span> <span class="n">says</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">lookup</span> <span class="n">see</span> <span class="n">references</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>

<span class="n">byte</span>   <span class="n">keepeqvs</span>
  <span class="p">:</span> <span class="n">Flag</span> <span class="n">that</span> <span class="n">says</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">equivalences</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>

<span class="n">byte</span>   <span class="n">keepnoise</span>
 <span class="p">:</span> <span class="n">Flag</span> <span class="n">that</span> <span class="n">says</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">noise</span> <span class="n">words</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>

<span class="n">byte</span>   <span class="n">withinproc</span>
 <span class="p">:</span> <span class="n">Flag</span> <span class="n">that</span> <span class="n">says</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">process</span> <span class="n">the</span> <span class="n">within</span> <span class="n">operator</span> <span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>

<span class="n">byte</span>   <span class="n">suffixproc</span>
 <span class="p">:</span> <span class="n">Flag</span> <span class="n">that</span> <span class="n">says</span> <span class="n">whether</span> <span class="n">to</span> <span class="n">do</span> <span class="n">suffix</span> <span class="n">processing</span> <span class="ow">or</span> <span class="ow">not</span><span class="o">.</span>

<span class="nb">int</span>    <span class="n">minwordlen</span>
 <span class="p">:</span> <span class="n">The</span> <span class="n">smallest</span> <span class="n">a</span> <span class="n">word</span> <span class="ow">is</span> <span class="n">allowed</span> <span class="n">to</span> <span class="n">get</span> <span class="n">through</span> <span class="n">suffix</span> <span class="n">stripping</span><span class="o">.</span>

<span class="n">byte</span> <span class="o">**</span><span class="n">suffixeq</span>
 <span class="p">:</span> <span class="n">The</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">suffixes</span><span class="o">.</span>

<span class="n">byte</span> <span class="o">**</span><span class="n">noise</span>
 <span class="p">:</span> <span class="n">The</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">noise</span> <span class="n">words</span><span class="o">.</span>

<span class="nb">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">eqedit</span><span class="p">)(</span><span class="n">APICP</span> <span class="o">*</span><span class="p">)</span>
 <span class="p">:</span> <span class="n">Equivalence</span> <span class="n">editor</span> <span class="n">function</span><span class="o">.</span>

<span class="nb">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">eqedit2</span><span class="p">)(</span><span class="n">APICP</span> <span class="o">*</span><span class="p">,</span><span class="n">EQVLST</span> <span class="o">***</span><span class="p">)</span>
 <span class="p">:</span> <span class="n">Equivalence</span> <span class="n">editor</span> <span class="n">function</span><span class="o">.</span>

<span class="n">void</span>  <span class="o">*</span><span class="n">usr</span>
 <span class="p">:</span> <span class="n">An</span> <span class="n">arbitrary</span> <span class="n">user</span> <span class="n">data</span> <span class="n">pointer</span><span class="o">.</span>
</pre></div>
</div>
<p><strong>NOTE:</strong> Also see Metamorph chapter [chp:mmling] for further
descriptions of these variables.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="o">*</span><span class="n">query</span><span class="p">:</span>
</pre></div>
</div>
<p>query is a pointer to a Metamorph query. This string typically comes
directly from user input, but may be constructed or preprocessed by your
program. All rules of a Metamorph query apply.</p>
<ul class="simple">
<li><p>REX patterns are prefixed by <code class="docutils literal notranslate"><span class="pre">'/'</span></code>.</p></li>
<li><p>XPM patterns are prefixed by <code class="docutils literal notranslate"><span class="pre">'%'</span></code>.</p></li>
<li><p>NPM patterns are prefixed by <code class="docutils literal notranslate"><span class="pre">'#'</span></code>.</p></li>
<li><p>Required sets are prefixed by <code class="docutils literal notranslate"><span class="pre">'+'</span></code>.</p></li>
<li><p>Exclusive sets are prefixed by <a href="#id7"><span class="problematic" id="id8">``</span></a><a href="#id9"><span class="problematic" id="id10">``</span></a>’-’‘.</p></li>
<li><p>Normal sets are prefixed by <code class="docutils literal notranslate"><span class="pre">'='</span></code> or nothing.</p></li>
<li><p>Intersection quantities are prefixed by <code class="docutils literal notranslate"><span class="pre">'&#64;'</span></code>.</p></li>
<li><p>Equivalence lookup may be prevented/forced on an individual word or
phrase by prefixing it with <code class="docutils literal notranslate"><span class="pre">'~'</span></code>.</p></li>
<li><p>Commas will be treated as whitespace except when part of a pattern
(REX, XPM, or NPM).</p></li>
<li><p>Phrases or patterns with spaces in them that should be treated as a
unit are surrounded by double quotes (<code class="docutils literal notranslate"><span class="pre">'&quot;'</span></code>).</p></li>
<li><p>Noise stripping is controlled by the keepnoise flag (see below).</p></li>
<li><p>Equivalence lookup may be completely turned off by setting eqprefix
to <code class="docutils literal notranslate"><span class="pre">(byte</span> <span class="pre">*)NULL</span></code> (see below). Turning off equiv lookup does not
affect query parsing as described above.</p></li>
<li><p>New delimiters may be specified using the within operator (w/).</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="o">*</span><span class="n">eqprefix</span><span class="p">:</span>
</pre></div>
</div>
<p>This string contains the name of the main equivalence file. This
typically includes the full path but may have a relative path or no path
at all. The equivs may be relocated or even renamed.</p>
<p>Default <code class="docutils literal notranslate"><span class="pre">eqprefix</span></code> <code class="docutils literal notranslate"><span class="pre">&quot;builtin&quot;</span></code> which refers to a compiled in equiv
file.</p>
<p>This default may be permanently adjusted by changing the macro
<code class="docutils literal notranslate"><span class="pre">API3EQPREFIX</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code> header file and recompiling
<code class="docutils literal notranslate"><span class="pre">api3.c</span></code> and replacing the resultant object file in the library.</p>
<p>Equivalence lookup may be completely turned off by setting <code class="docutils literal notranslate"><span class="pre">eqprefix</span></code>
to <code class="docutils literal notranslate"><span class="pre">(byte</span> <span class="pre">*)NULL</span></code>. Sometimes it is not appropriate to get the
associations from the equiv file or you may want to run your application
without the disk space overhead of the equiv file which is very large
(around 2 megabytes). Turning off equiv lookup does not affect query
parsing as described previously.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="o">*</span><span class="n">ueqprefix</span><span class="p">:</span>
</pre></div>
</div>
<p>This string contains the name of the user equivalence file. This
typically includes the full path but may have a relative path or no path
at all. The equivs may be relocated or even renamed.</p>
<p>Default <code class="docutils literal notranslate"><span class="pre">ueqprefix</span></code> for Unix :<code class="docutils literal notranslate"><span class="pre">&quot;/usr/local/morph3/eqvsusr&quot;</span></code> Default
<code class="docutils literal notranslate"><span class="pre">ueqprefix</span></code> for MS-DOS:<code class="docutils literal notranslate"><span class="pre">&quot;c:\morph3\eqvsusr&quot;</span></code></p>
<p>This default may be permanently adjusted by changing the macro
<code class="docutils literal notranslate"><span class="pre">API3UEQPREFIX</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code> header file and recompiling
<code class="docutils literal notranslate"><span class="pre">api3.c</span></code> and replacing the resultant object file in the library.</p>
<p>Equivalences in the user equiv file edit and/or override those in the
main equiv file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="n">withinproc</span><span class="p">:</span>
</pre></div>
</div>
<p>Process the within operator <code class="docutils literal notranslate"><span class="pre">(w/)</span></code>. The within operator allows
changing the start and end delimiters from the query line. The argument
of the within operator may be one of the built in names, a number
indicating character proximity, or a REX expression. The built in names
are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Name    Meaning     Expression
sent    Sentence    \verb`[^\digit\upper][.?!][\space&#39;&quot;]`
para    Paragraph   \verb`\x0a=\space+  `
line    Line        \verb`$`
page    Page        \verb`x0c`
\#      Proximity   \verb`.{,#}`(where \# is the number of characters)
</pre></div>
</div>
<p>Any other string following the <code class="docutils literal notranslate"><span class="pre">&quot;w/&quot;</span></code> is considered a REX expression.
When using a REX expression with the within operator both start and
delimiters are set to the expression to set the end delimiter to a
different expression specify another within operator and expression.
e.g. `` “power w/tag:  w/$”`` will set the start delimiter to
<code class="docutils literal notranslate"><span class="pre">&quot;tag:&quot;</span> <span class="pre">``</span> <span class="pre">and</span> <span class="pre">the</span> <span class="pre">end</span> <span class="pre">delimiter</span> <span class="pre">to</span> <span class="pre">``&quot;$&quot;</span></code>.</p>
<p>By default both delimiters will be excluded from the hit when using a
REX with the within operator. To specify inclusion use a <code class="docutils literal notranslate"><span class="pre">&quot;W/&quot;</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">&quot;w/&quot;</span></code>. You may specify different inclusion/exclusion for
the end delimiter without repeating the expression if you wish to use
the same expression for both. Simply use the <code class="docutils literal notranslate"><span class="pre">&quot;W/&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;w/&quot;</span></code> by
itself for the end delimiter. e.g. <code class="docutils literal notranslate"><span class="pre">&quot;power</span> <span class="pre">w/$$</span> <span class="pre">W/&quot;</span></code> will set both
delimiters to <code class="docutils literal notranslate"><span class="pre">&quot;$$&quot;</span></code> but will exclude the start delimiter and include
the end delimiter.</p>
<p>The default value for <code class="docutils literal notranslate"><span class="pre">withinproc</span></code> is <code class="docutils literal notranslate"><span class="pre">1</span></code>. This default may be
adjusted by changing the macro <code class="docutils literal notranslate"><span class="pre">API3WITHINPROC</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code>
header file and recompiling <code class="docutils literal notranslate"><span class="pre">api3.c</span></code>.</p>
<p>See also the section “Reprogramming the Within Operator”.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="n">see</span><span class="p">:</span>
</pre></div>
</div>
<p>Lookup “see” references in the equiv file. The equiv file has “see”
references much as a dictionary or thesaurus has. With this flag off
“see” references are left in the word list as is. With it on, those
references will be looked up and their equiv lists added to the list for
the original word. This can greatly increase the number of equivs and
abstraction for a given word. This is not needed in most cases.</p>
<p>The default value for see is <code class="docutils literal notranslate"><span class="pre">0</span></code>. This default may be adjusted by
changing the macro <code class="docutils literal notranslate"><span class="pre">API3SEE</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code> header file and
recompiling <code class="docutils literal notranslate"><span class="pre">api3.c</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="n">keepnoise</span><span class="p">:</span>
</pre></div>
</div>
<p>Keep noise words. With this flag off any word in query, that is not part
of a larger phrase, that is also found in the noise array will be
removed from the list.</p>
<p>The default value for <code class="docutils literal notranslate"><span class="pre">keepnoise</span></code> is <code class="docutils literal notranslate"><span class="pre">1</span></code>. This default may be
adjusted by changing the macro <code class="docutils literal notranslate"><span class="pre">API3KEEPNOISE</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code>
header file and recompiling <code class="docutils literal notranslate"><span class="pre">api3.c</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="n">keepeqvs</span><span class="p">:</span>
</pre></div>
</div>
<p>Invert normal meaning of <code class="docutils literal notranslate"><span class="pre">~</span></code> . With this flag on words will not
normally have equivs. To get the equivs for a word use the <code class="docutils literal notranslate"><span class="pre">~</span></code> prefix.</p>
<p>The default value for <code class="docutils literal notranslate"><span class="pre">keepeqvs</span></code> is <code class="docutils literal notranslate"><span class="pre">1</span></code>. This default may be
adjusted by changing the macro <code class="docutils literal notranslate"><span class="pre">API3KEEPEQVS</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code> header
file and recompiling <code class="docutils literal notranslate"><span class="pre">api3.c</span></code>.</p>
<p>Setting <code class="docutils literal notranslate"><span class="pre">keepeqvs</span></code> to`` 0`` does not eliminate looking for the equiv
file. See the <code class="docutils literal notranslate"><span class="pre">eqprefix</span></code> variable for how to eliminate the equiv file
completely.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="n">suffixproc</span><span class="p">:</span>
</pre></div>
</div>
<p>This is a flag that, if not set to <code class="docutils literal notranslate"><span class="pre">0</span></code>, will cause the equiv lookup
process to strip suffixes from query words and words from the equiv file
to find the closest match if there is not an exact match. Words will not
be stripped smaller than the <code class="docutils literal notranslate"><span class="pre">minwordlen</span></code> value (see below). This flag
has a similar effect on the search process (see Metamorph section
[set:presuf]).</p>
<p>The default value for <code class="docutils literal notranslate"><span class="pre">suffixproc</span></code> is <code class="docutils literal notranslate"><span class="pre">1</span></code>. This default may be
adjusted by changing the macro <code class="docutils literal notranslate"><span class="pre">API3SUFFIXPROC</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code>
header file and recompiling <code class="docutils literal notranslate"><span class="pre">api3.c</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="o">**</span><span class="n">suffixeq</span><span class="p">:</span>
</pre></div>
</div>
<p>This is the list of word endings used by the suffix processor if
<code class="docutils literal notranslate"><span class="pre">suffixproc</span></code> is on (see the description of lists). The suffix
processor also has some permanent built in rules for stripping. This is
the default list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;   s  ies</span>
</pre></div>
</div>
<p>The default may be changed by editing the <code class="docutils literal notranslate"><span class="pre">suffixeq[]</span></code> array in the
function <code class="docutils literal notranslate"><span class="pre">openapicp()</span></code> in the file <code class="docutils literal notranslate"><span class="pre">api3.c</span></code> and recompiling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">minwordlen</span><span class="p">:</span>
</pre></div>
</div>
<p>This only applies if <code class="docutils literal notranslate"><span class="pre">suffixproc</span></code> is on. It is the smallest that a
word is allowed to get before suffix stripping will stop and give up.</p>
<p>The default value for <code class="docutils literal notranslate"><span class="pre">minwordlen</span></code> is <code class="docutils literal notranslate"><span class="pre">5</span></code>. This default may be
adjusted by changing the macro <code class="docutils literal notranslate"><span class="pre">API3MINWORDLEN</span></code> in the <code class="docutils literal notranslate"><span class="pre">api3.h</span></code>
header file and recompiling api3.c. This flag has a similar effect on
the search process (see Metamorph section [set:minwrdlen]).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">byte</span> <span class="o">**</span><span class="n">noise</span><span class="p">:</span>
</pre></div>
</div>
<p>This is the default noise list:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 19%" />
<col style="width: 14%" />
<col style="width: 18%" />
<col style="width: 18%" />
<col style="width: 16%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>a</p></td>
<td><p>between</p></td>
<td><p>got</p></td>
<td><p>me</p></td>
<td><p>she</p></td>
<td><p>upon</p></td>
</tr>
<tr class="row-even"><td><p>about</p></td>
<td><p>but</p></td>
<td><p>gotten</p></td>
<td><p>mine</p></td>
<td><p>should</p></td>
<td><p>us</p></td>
</tr>
<tr class="row-odd"><td><p>after</p></td>
<td><p>by</p></td>
<td><p>had</p></td>
<td><p>more</p></td>
<td><p>so</p></td>
<td><p>very</p></td>
</tr>
<tr class="row-even"><td><p>again</p></td>
<td><p>came</p></td>
<td><p>has</p></td>
<td><p>most</p></td>
<td><p>some</p></td>
<td><p>was</p></td>
</tr>
<tr class="row-odd"><td><p>ago</p></td>
<td><p>can</p></td>
<td><p>have</p></td>
<td><p>much</p></td>
<td><p>somebody</p></td>
<td><p>we</p></td>
</tr>
<tr class="row-even"><td><p>all</p></td>
<td><p>cannot</p></td>
<td><p>having</p></td>
<td><p>my</p></td>
<td><p>someone</p></td>
<td><p>went</p></td>
</tr>
<tr class="row-odd"><td><p>almost</p></td>
<td><p>come</p></td>
<td><p>he</p></td>
<td><p>myself</p></td>
<td><p>something</p></td>
<td><p>were</p></td>
</tr>
<tr class="row-even"><td><p>also</p></td>
<td><p>could</p></td>
<td><p>her</p></td>
<td><p>never</p></td>
<td><p>stand</p></td>
<td><p>what</p></td>
</tr>
<tr class="row-odd"><td><p>always</p></td>
<td><p>did</p></td>
<td><p>here</p></td>
<td><p>no</p></td>
<td><p>such</p></td>
<td><p>whatever</p></td>
</tr>
<tr class="row-even"><td><p>am</p></td>
<td><p>do</p></td>
<td><p>him</p></td>
<td><p>none</p></td>
<td><p>sure</p></td>
<td><p>what’s</p></td>
</tr>
<tr class="row-odd"><td><p>an</p></td>
<td><p>does</p></td>
<td><p>his</p></td>
<td><p>not</p></td>
<td><p>take</p></td>
<td><p>when</p></td>
</tr>
<tr class="row-even"><td><p>and</p></td>
<td><p>doing</p></td>
<td><p>how</p></td>
<td><p>now</p></td>
<td><p>than</p></td>
<td><p>where</p></td>
</tr>
<tr class="row-odd"><td><p>another</p></td>
<td><p>done</p></td>
<td><p>i</p></td>
<td><p>of</p></td>
<td><p>that</p></td>
<td><p>whether</p></td>
</tr>
<tr class="row-even"><td><p>any</p></td>
<td><p>down</p></td>
<td><p>if</p></td>
<td><p>off</p></td>
<td><p>the</p></td>
<td><p>which</p></td>
</tr>
<tr class="row-odd"><td><p>anybody</p></td>
<td><p>each</p></td>
<td><p>in</p></td>
<td><p>on</p></td>
<td><p>their</p></td>
<td><p>while</p></td>
</tr>
<tr class="row-even"><td><p>anyhow</p></td>
<td><p>else</p></td>
<td><p>into</p></td>
<td><p>one</p></td>
<td><p>them</p></td>
<td><p>who</p></td>
</tr>
<tr class="row-odd"><td><p>anyone</p></td>
<td><p>even</p></td>
<td><p>is</p></td>
<td><p>onto</p></td>
<td><p>then</p></td>
<td><p>whoever</p></td>
</tr>
<tr class="row-even"><td><p>anything</p></td>
<td><p>ever</p></td>
<td><p>isn’t</p></td>
<td><p>or</p></td>
<td><p>there</p></td>
<td><p>whom</p></td>
</tr>
<tr class="row-odd"><td><p>anyway</p></td>
<td><p>every</p></td>
<td><p>it</p></td>
<td><p>our</p></td>
<td><p>these</p></td>
<td><p>whose</p></td>
</tr>
<tr class="row-even"><td><p>are</p></td>
<td><p>everyone</p></td>
<td><p>just</p></td>
<td><p>ourselves</p></td>
<td><p>they</p></td>
<td><p>why</p></td>
</tr>
<tr class="row-odd"><td><p>as</p></td>
<td><p>everything</p></td>
<td><p>last</p></td>
<td><p>out</p></td>
<td><p>this</p></td>
<td><p>will</p></td>
</tr>
<tr class="row-even"><td><p>at</p></td>
<td><p>for</p></td>
<td><p>least</p></td>
<td><p>over</p></td>
<td><p>those</p></td>
<td><p>with</p></td>
</tr>
<tr class="row-odd"><td><p>away</p></td>
<td><p>from</p></td>
<td><p>left</p></td>
<td><p>per</p></td>
<td><p>through</p></td>
<td><p>within</p></td>
</tr>
<tr class="row-even"><td><p>back</p></td>
<td><p>front</p></td>
<td><p>less</p></td>
<td><p>put</p></td>
<td><p>till</p></td>
<td><p>without</p></td>
</tr>
<tr class="row-odd"><td><p>be</p></td>
<td><p>get</p></td>
<td><p>let</p></td>
<td><p>putting</p></td>
<td><p>to</p></td>
<td><p>won’t</p></td>
</tr>
<tr class="row-even"><td><p>became</p></td>
<td><p>getting</p></td>
<td><p>like</p></td>
<td><p>same</p></td>
<td><p>too</p></td>
<td><p>would</p></td>
</tr>
<tr class="row-odd"><td><p>because</p></td>
<td><p>go</p></td>
<td><p>make</p></td>
<td><p>saw</p></td>
<td><p>two</p></td>
<td><p>wouldn’t</p></td>
</tr>
<tr class="row-even"><td><p>been</p></td>
<td><p>goes</p></td>
<td><p>many</p></td>
<td><p>see</p></td>
<td><p>unless</p></td>
<td><p>yet</p></td>
</tr>
<tr class="row-odd"><td><p>before</p></td>
<td><p>going</p></td>
<td><p>may</p></td>
<td><p>seen</p></td>
<td><p>until</p></td>
<td><p>you</p></td>
</tr>
<tr class="row-even"><td><p>being</p></td>
<td><p>gone</p></td>
<td><p>maybe</p></td>
<td><p>shall</p></td>
<td><p>up</p></td>
<td><p>your</p></td>
</tr>
</tbody>
</table>
<p>The default may be changed by editing the <code class="docutils literal notranslate"><span class="pre">noise[]</span></code> array in the
function <code class="docutils literal notranslate"><span class="pre">openapicp()</span></code> in the file <code class="docutils literal notranslate"><span class="pre">api3.c</span></code> and recompiling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">:</span>
</pre></div>
</div>
<p>This is a pointer that the application programmer my use as a method of
passing arbitrary application specific information to the callback
functions <code class="docutils literal notranslate"><span class="pre">(*eqedit)()</span></code> and <code class="docutils literal notranslate"><span class="pre">(*eqedit2)()</span></code>. This pointer is entirely
under the control of the programmer. The Metamorph API does not
reference it in any way except to set it to <code class="docutils literal notranslate"><span class="pre">(void</span> <span class="pre">*)NULL</span></code> in
<code class="docutils literal notranslate"><span class="pre">openapicp()</span></code>.</p>
</div>
<div class="section" id="equivalence-editing-callbacks">
<h2>Equivalence editing callbacks<a class="headerlink" href="#equivalence-editing-callbacks" title="Permalink to this headline">¶</a></h2>
<p>During query processing, <code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> will call two user callback
functions to perform editing on the query terms. The processing sequence
is as follows:</p>
<ol class="arabic simple">
<li><p>parse the query and lookup terms in equiv file.</p></li>
<li><p>build eqvlist for eqedit2.</p></li>
<li><p>* call (*eqedit2)().</p></li>
<li><p>check for empty or NULL list.</p></li>
<li><p>check for and remove duplication in set lists.</p></li>
<li><p>set intersections if not already set (&lt;0).</p></li>
<li><p>build formatted sets for (*eqedit)() from eqvlist.</p></li>
<li><p>free eqvlist.</p></li>
<li><p>* call (*eqedit)().</p></li>
<li><p>perform rest of internal setup.</p></li>
<li><p>return to caller.</p></li>
</ol>
<p><code class="docutils literal notranslate"><span class="pre">(*eqedit2)()</span></code> is the recommended method for implementing on the fly
equiv editing because it is easier to use. <code class="docutils literal notranslate"><span class="pre">(*eqedit)()</span></code> is available
for backwards compatibility.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">eqedit2</span><span class="p">)(</span><span class="n">APICP</span> <span class="o">*</span><span class="p">,</span><span class="n">EQVLST</span> <span class="o">***</span><span class="p">):</span>
</pre></div>
</div>
<p>This function is always called after a successful equiv lookup and
before the search begins. It is called with the current <code class="docutils literal notranslate"><span class="pre">APICP</span></code>
pointer and a pointer to the list of equivs generated by the query (see
the description of lists). The list pointer may be reassigned as needed.</p>
<p>The return value from <code class="docutils literal notranslate"><span class="pre">(*eqedit2)()</span></code> determines whether to go ahead
with the search or not. A return value of <code class="docutils literal notranslate"><span class="pre">0</span></code> means OK, go ahead with
the search. A return value of anything else means <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, don’t do
search. An <code class="docutils literal notranslate"><span class="pre">ERROR</span></code> return from <code class="docutils literal notranslate"><span class="pre">(*eqedit2)()</span></code> will then cause
<code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> or <code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code>, depending on where it was called
from, to return an error. A <code class="docutils literal notranslate"><span class="pre">NULL</span></code> list from <code class="docutils literal notranslate"><span class="pre">(*eqedit2)()</span></code> is also
considered an error.</p>
<p>There is one <code class="docutils literal notranslate"><span class="pre">EQVLST</span></code> for each term in the query. The array of
<code class="docutils literal notranslate"><span class="pre">EQVLSTs</span></code> is terminated by an <code class="docutils literal notranslate"><span class="pre">EQVLST</span></code> with the words member set to
<code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code> (all other members of the terminator are ignored). The
<code class="docutils literal notranslate"><span class="pre">EQVLST</span></code> structure contains the following members:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>char   logic: the logic for this set
char **words: the list of terms including the root term
char **clas : the list of classes for `words&#39;
int    sz   : the allocated size of the `words&#39; and `clas&#39; arrays
int    used : the number used (populated) of the `words&#39; and `clas&#39;
              arrays, including the terminating empty string (&quot;&quot;)
int    qoff : the offset into user&#39;s query for this set (-1 if unknown)
int    qlen : the length in user&#39;s query for this set (-1 if unknown)
char   *originalPrefix:  set logic/tilde/open-paren/pattern-matcher
char   **sourceExprs: NULL-terminated list of source expressions for set
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">words</span></code> and <code class="docutils literal notranslate"><span class="pre">clas</span></code> arrays are allocated lists like everything
else in the <code class="docutils literal notranslate"><span class="pre">APICP</span></code>, and are terminated by empty strings. The <code class="docutils literal notranslate"><span class="pre">sz</span></code>
and <code class="docutils literal notranslate"><span class="pre">used</span></code> fields are provided so that editors may manage the lists
more efficiently.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">words</span></code> and <code class="docutils literal notranslate"><span class="pre">clas</span></code> lists are parallel. They are exactly the same
length and for every item, <code class="docutils literal notranslate"><span class="pre">words[i]</span></code>, its classification is
<code class="docutils literal notranslate"><span class="pre">clas[i]</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">originalPrefix</span></code> field (added in Texis version 6) contains the set
logic (“<code class="docutils literal notranslate"><span class="pre">+</span></code>”, “<code class="docutils literal notranslate"><span class="pre">-</span></code>”, “<code class="docutils literal notranslate"><span class="pre">=</span></code>”), tilde (“<code class="docutils literal notranslate"><span class="pre">~</span></code>”), open-parenthesis,
and/or pattern-matcher characters (“<code class="docutils literal notranslate"><span class="pre">/</span></code>” for REX, “<code class="docutils literal notranslate"><span class="pre">%</span></code>” for XPM,
“<code class="docutils literal notranslate"><span class="pre">#</span></code>” for NPM) present in the original query for this set, if any. It
can be used in reconstructing the original query, e.g. if the terms are
to be modified but set logic etc. should be preserved as given.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sourceExprs</span></code> field (added in Texis version 6) contains a list of
the source expressions or terms for the set, i.e. as given in the
original query. For SPM queries, this will be a single word or phrase.
For PPM queries given as parenthetical lists, this will be a list of the
individual terms or phrases. For REX/NPM/XPM queries, this will be the
expression (sans “<code class="docutils literal notranslate"><span class="pre">/</span></code>”/“<code class="docutils literal notranslate"><span class="pre">#</span></code>”/”<code class="docutils literal notranslate"><span class="pre">%</span></code>”). For single terms that are
expanded by equivalence lookup, this will be the original single term,
<em>not</em> the expanded list (as <code class="docutils literal notranslate"><span class="pre">words</span></code> will be) – because <code class="docutils literal notranslate"><span class="pre">sourceExprs</span></code>
is from the source (original query), not post-equivalence-processing.
Note also that <code class="docutils literal notranslate"><span class="pre">sourceExprs</span></code> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code> (not empty-string)
terminated. The <code class="docutils literal notranslate"><span class="pre">sourceExprs</span></code> array can be used in reconstructing or
modifying queries.</p>
<p>The default function is the function <code class="docutils literal notranslate"><span class="pre">nulleqedit2</span></code> in <code class="docutils literal notranslate"><span class="pre">api3.c</span></code> which
does nothing and returns <code class="docutils literal notranslate"><span class="pre">0</span></code> for OK.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">eqedit</span><span class="p">)(</span><span class="n">APICP</span> <span class="o">*</span><span class="p">):</span>
</pre></div>
</div>
<p>This function is always called after a successful equiv lookup and
before the search begins. It is called with the current <code class="docutils literal notranslate"><span class="pre">APICP</span></code>
pointer with the “set” list in the APICP structure set to the list of
equivs generated by the query (see the description of lists).</p>
<p>The return value from <code class="docutils literal notranslate"><span class="pre">(*eqedit)()</span></code> determines whether to go ahead
with the search or not. A return value of <code class="docutils literal notranslate"><span class="pre">0</span></code> means OK, go ahead with
the search. A return value of anything else means <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, don’t do
search. An <code class="docutils literal notranslate"><span class="pre">ERROR</span></code> return from <code class="docutils literal notranslate"><span class="pre">(*eqedit)()</span></code> will then cause
<code class="docutils literal notranslate"><span class="pre">setmmapi()</span></code> or <code class="docutils literal notranslate"><span class="pre">openmmapi()</span></code>, depending on where it was called
from, to return an error.</p>
<p>The format of the sets is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">-|+|=</span><span class="p">}</span><span class="n">word</span><span class="p">[;</span><span class="n">class</span><span class="p">][,</span><span class="n">equiv</span><span class="p">][</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">-|+|=</span><span class="p">}{</span><span class="o">/|%</span><span class="mi">99</span><span class="o">|</span><span class="c1">#}word</span>
</pre></div>
</div>
<p>Where:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[]</span>    <span class="n">surround</span> <span class="n">optional</span> <span class="n">sections</span><span class="o">.</span>
<span class="p">{}</span>    <span class="n">surround</span> <span class="n">required</span> <span class="n">items</span> <span class="n">to</span> <span class="n">be</span> <span class="n">chosen</span> <span class="n">from</span><span class="o">.</span>
<span class="o">|</span>     <span class="n">separates</span> <span class="n">mutually</span> <span class="n">exclusive</span> <span class="n">items</span> <span class="n">between</span> <span class="p">{}</span><span class="o">.</span>
<span class="mi">9</span>     <span class="n">represents</span> <span class="n">a</span> <span class="n">required</span> <span class="n">decimal</span> <span class="n">digit</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span><span class="o">.</span>
<span class="n">word</span>  <span class="ow">is</span> <span class="n">the</span> <span class="n">word</span><span class="p">,</span> <span class="n">phrase</span><span class="p">,</span> <span class="ow">or</span> <span class="n">pattern</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">query</span><span class="o">.</span>
<span class="n">equiv</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">equivalent</span> <span class="k">for</span> <span class="n">word</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">is</span> <span class="n">a</span> <span class="n">string</span> <span class="n">representing</span> <span class="n">the</span> <span class="n">classification</span> <span class="k">for</span> <span class="n">the</span>
      <span class="n">following</span> <span class="n">words</span><span class="o">.</span>
<span class="o">...</span>   <span class="n">means</span> <span class="nb">any</span> <span class="n">amount</span> <span class="n">of</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">item</span><span class="o">.</span>
</pre></div>
</div>
<p>Classifications in the default thesaurus (case is significant):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">P</span> <span class="o">=</span> <span class="n">Pronoun</span>         <span class="n">c</span> <span class="o">=</span> <span class="n">Conjunction</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">Interjection</span>    <span class="n">m</span> <span class="o">=</span> <span class="n">Modifier</span>
<span class="n">n</span> <span class="o">=</span> <span class="n">Noun</span>            <span class="n">p</span> <span class="o">=</span> <span class="n">Preposition</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">Verb</span>            <span class="n">u</span> <span class="o">=</span> <span class="n">Unknown</span><span class="o">/</span><span class="n">Don</span><span class="s1">&#39;t care</span>
</pre></div>
</div>
<p>Words and phrases will be in the first format. Patterns will be in the
second format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=</span><span class="n">struggle</span><span class="p">;</span><span class="n">n</span><span class="p">,</span><span class="n">battle</span><span class="p">,</span><span class="n">combat</span><span class="p">,</span><span class="n">competition</span><span class="p">,</span><span class="n">conflict</span><span class="p">,</span><span class="n">compete</span><span class="p">;</span><span class="n">v</span><span class="p">,</span><span class="n">contest</span><span class="p">,</span><span class="n">strive</span>
     <span class="n">battle</span><span class="p">,</span> <span class="n">combat</span><span class="p">,</span> <span class="n">competition</span><span class="p">,</span> <span class="ow">and</span> <span class="n">conflict</span> <span class="n">are</span> <span class="n">nouns</span>
     <span class="n">compete</span><span class="p">,</span> <span class="n">contest</span><span class="p">,</span> <span class="ow">and</span> <span class="n">strive</span> <span class="n">are</span> <span class="n">verbs</span>
     <span class="n">struggle</span> <span class="n">can</span> <span class="n">be</span> <span class="n">a</span> <span class="n">noun</span> <span class="ow">or</span> <span class="n">verb</span>

<span class="o">=</span><span class="n">status</span> <span class="n">quo</span><span class="p">;</span><span class="n">n</span><span class="p">,</span><span class="n">average</span><span class="p">,</span><span class="n">normality</span>
     <span class="n">status</span> <span class="n">quo</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="ow">and</span> <span class="n">normality</span> <span class="n">are</span> <span class="n">nouns</span>

<span class="o">+</span><span class="n">Bush</span><span class="p">;</span><span class="n">P</span>
     <span class="n">Bush</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">pronoun</span>

<span class="o">-/</span><span class="mi">19</span>\<span class="n">digit</span><span class="p">{</span><span class="mi">2</span><span class="p">}</span>
     <span class="n">a</span> <span class="n">REX</span> <span class="n">pattern</span> <span class="n">to</span> <span class="n">find</span> <span class="s2">&quot;19&quot;</span> <span class="n">followed</span> <span class="n">by</span> <span class="mi">2</span> <span class="n">digits</span>

<span class="o">=%</span><span class="mi">80</span><span class="n">qadafi</span>
     <span class="n">an</span> <span class="n">XPM</span> <span class="n">pattern</span> <span class="n">to</span> <span class="n">find</span> <span class="n">qadafi</span> <span class="n">within</span> <span class="mi">80</span><span class="o">%</span>

<span class="o">=</span><span class="c1">#&gt;500</span>
     <span class="n">an</span> <span class="n">NPM</span> <span class="n">pattern</span> <span class="n">to</span> <span class="n">find</span> <span class="n">numbers</span> <span class="n">greater</span> <span class="n">than</span> <span class="mi">500</span>
</pre></div>
</div>
<p>Remember that each of the “set” strings is allocated. So if you replace
a set you must free the old one, to prevent memory loss, and use an
allocated pointer for the replacement because it will get freed in
<code class="docutils literal notranslate"><span class="pre">closeapicp()</span></code>, unless it is <code class="docutils literal notranslate"><span class="pre">(byte</span> <span class="pre">*)NULL</span></code>.</p>
<p>The “set” format must be totally correct for the search process to work.</p>
<p>The default is the function <code class="docutils literal notranslate"><span class="pre">nulleqedit</span></code> in <code class="docutils literal notranslate"><span class="pre">api3.c</span></code> which does
nothing and returns <code class="docutils literal notranslate"><span class="pre">0</span></code> for OK.</p>
</div>
<div class="section" id="user-equivalence-file-maintenance">
<h2>User equivalence file maintenance<a class="headerlink" href="#user-equivalence-file-maintenance" title="Permalink to this headline">¶</a></h2>
<p>A user equivalence file contains equivalences in a manner similar to the
main equiv file. The user equiv contains equivs that edit and/or replace
equivs in the main equiv. It may also contain new equivs.</p>
<p>Make a user equiv file by creating an ASCII file containing your desired
equiv edits. Then index that source file with backref program.</p>
<p>The user equiv source file has the following format:</p>
<ul class="simple">
<li><p>The root word or phrase is the first thing on the line.</p></li>
<li><p>Hyphenated words should be entered with a space instead of a hyphen.</p></li>
<li><p>Subsequent words/phrases (equivs) follow on the same line prefixed
with edit commands (see below).</p></li>
<li><p>Add optional classification information by appending a semicolon (;)
and the class to the word to apply it to. Any specified
classification is carried onto subsequent words until a new
classification is entered.</p></li>
<li><p>Lines should be kept to a reasonable length; around 80 characters for
standard screen display is prudent. In no case should a line exceed
1K. Where more equivs exist for a root word than can be fit onto one
line, enter multiple entries where the root word is repeated as the
first item.</p></li>
<li><p>There should not be any blank lines. Lines should not have any
leading or trailing spaces. Words or phrases also should not have any
leading or trailing spaces.</p></li>
<li><p>A user equiv file may “chain” to another user equiv file by placing
the key string “;chain;” followed by the name of the equiv source
file to chain to on the first line of the source file. e.g.
<code class="docutils literal notranslate"><span class="pre">&quot;;chain;c:\morph3\eqvsusr&quot;</span></code> Equivs are looked up in the chained
file before the current file so that a user may, for example,
override system wide settings. Chains are resolved when the source
file gets backreferenced.</p></li>
</ul>
</div>
<div class="section" id="edit-commands">
<h2>Edit commands:<a class="headerlink" href="#edit-commands" title="Permalink to this headline">¶</a></h2>
<p>Comma <code class="docutils literal notranslate"><span class="pre">(,)</span></code> means add this word/phrase to the list of equivs for this
root.</p>
<p>Tilde <code class="docutils literal notranslate"><span class="pre">(~)</span></code> means delete this word from the list of equivs for this
root.</p>
<p>Equals <code class="docutils literal notranslate"><span class="pre">(=)</span></code> only applies for the first equiv specified for a root. It
means replace this entry with the following entry. The first word after
the equals is taken as the new root and the rest of the words are its
equivs. If the equals is followed by a non-alphanumeric character the
entire rest of the line is taken literally as a replacement for the
original entry. This is a macro like facility that allows you to make a
word mean a regular expression or other Metamorph special pattern match.</p>
<p>Once you have a user equiv source file index it with the backref
command. This syntax is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">backref</span> <span class="n">source_file</span> <span class="n">indexed_file</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">source_file</span></code> is the ASCII file you created. And
<code class="docutils literal notranslate"><span class="pre">indexed_file</span></code> is the backreferenced and indexed file that you specify
in the <code class="docutils literal notranslate"><span class="pre">ueqprefix</span></code> variable. To just index the source file without
backreferencing it use the <code class="docutils literal notranslate"><span class="pre">-l1</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">backref</span> <span class="o">-</span><span class="n">l1</span> <span class="n">source_file</span> <span class="n">indexed_file</span>
</pre></div>
</div>
<p>By convention the source file should have the same path and filename as
the indexed file with an extension of <code class="docutils literal notranslate"><span class="pre">&quot;.lst&quot;</span></code>. This is what the
Metamorph user interface expects. For example: the source file for
<code class="docutils literal notranslate"><span class="pre">&quot;c:\morph3\eqvsusr&quot;</span></code> would be <code class="docutils literal notranslate"><span class="pre">&quot;c:\morph3\eqvsusr.lst&quot;</span></code></p>
<p>Sample user equiv file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chicken</span><span class="p">,</span><span class="n">bird</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">egg</span><span class="p">,</span><span class="n">aviary</span><span class="p">,</span><span class="n">rooster</span>
<span class="n">seed</span><span class="p">;</span><span class="n">n</span><span class="p">,</span><span class="n">food</span><span class="p">,</span><span class="n">feed</span><span class="p">,</span><span class="n">sprout</span>
<span class="n">ranch</span><span class="p">,</span><span class="n">farm</span><span class="p">,</span><span class="n">pen</span><span class="p">,</span><span class="n">hen</span> <span class="n">house</span><span class="p">,</span><span class="n">chicken</span> <span class="n">house</span><span class="p">,</span><span class="n">pig</span> <span class="n">sty</span>
<span class="n">Farmer</span><span class="s1">&#39;s Almanac,research,weather forecast,book</span>
<span class="n">rose</span><span class="p">,</span><span class="n">flower</span><span class="p">,</span><span class="n">thorn</span><span class="p">,</span><span class="n">red</span> <span class="n">flower</span>
<span class="n">water</span><span class="p">,</span><span class="n">moisture</span><span class="p">,</span><span class="n">dew</span><span class="p">,</span><span class="n">dewdrop</span><span class="p">,</span><span class="n">Atlantic</span> <span class="n">Ocean</span>
<span class="n">bee</span> <span class="n">pollen</span><span class="p">,</span><span class="n">mating</span><span class="p">,</span><span class="n">flower</span><span class="p">,</span><span class="n">pollination</span><span class="p">,</span><span class="n">Vitamin</span> <span class="n">B</span>
<span class="n">grow</span><span class="p">,</span><span class="n">mature</span><span class="p">,</span><span class="n">blossom</span><span class="p">,</span><span class="n">ripen</span>
<span class="n">abort</span><span class="p">,</span><span class="n">cancel</span><span class="p">,</span><span class="n">cease</span><span class="p">,</span><span class="n">destroy</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">fail</span><span class="p">,</span><span class="n">kill</span>
<span class="n">abort</span><span class="p">,</span><span class="n">miscarry</span><span class="p">,</span><span class="n">nullify</span><span class="p">,</span><span class="n">terminate</span><span class="p">,</span><span class="n">zap</span>
<span class="n">wish</span><span class="p">;</span><span class="n">n</span><span class="p">,</span><span class="n">pie</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">sky</span><span class="p">,</span><span class="n">dream</span><span class="p">;</span><span class="n">v</span><span class="p">,</span><span class="n">yearn</span><span class="p">,</span><span class="n">long</span><span class="p">,</span><span class="n">pine</span>
<span class="n">constellation</span><span class="o">~</span><span class="n">nebula</span><span class="o">~</span><span class="n">zodiac</span><span class="p">,</span><span class="n">big</span> <span class="n">dipper</span>
<span class="n">abandon</span><span class="o">=</span><span class="n">abandon</span><span class="p">,</span><span class="n">leave</span>
<span class="n">galaxy</span><span class="o">=</span><span class="n">andromeda</span>
<span class="nb">slice</span><span class="o">=</span><span class="nb">slice</span>
<span class="n">lots</span><span class="o">=</span><span class="c1">#&gt;100</span>
<span class="n">bush</span><span class="o">=/</span>\<span class="n">RBush</span>
</pre></div>
</div>
</div>
<div class="section" id="reprogramming-the-within-operator">
<h2>Reprogramming the Within Operator<a class="headerlink" href="#reprogramming-the-within-operator" title="Permalink to this headline">¶</a></h2>
<p><strong>NOTE:</strong> The mechanism described here may be replaced with something
different in a future version of the Metamorph API.</p>
<p>The symbolic expressions that the within operator knows about may be
reprogrammed by the application developer. The within processor
maintains two lists of symbolic expressions: a “standard” list and a
“user” list. By default the standard list contains the symbols described
elsewhere in this document (line/page/etc). The user list is empty by
default.</p>
<p>The within processor processes the string after the <code class="docutils literal notranslate"><span class="pre">&quot;w/&quot;</span></code> in the
following order:</p>
<ul class="simple">
<li><p>If the first character is a digit its a proximity count.</p></li>
<li><p>If it matches something in the user list, use its expression.</p></li>
<li><p>If it matches something in the standard list, use its expression.</p></li>
<li><p>Otherwise it’s taken literally as a rex expression.</p></li>
</ul>
<p>Each list is made up of an array of <code class="docutils literal notranslate"><span class="pre">MDPDLM</span></code> structures</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MDPDLM</span> <span class="p">{</span>
   <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
   <span class="n">char</span> <span class="o">*</span><span class="n">expr</span><span class="p">;</span>
   <span class="nb">int</span>   <span class="n">incsd</span><span class="p">;</span>
   <span class="nb">int</span>   <span class="n">inced</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Where:</p>
<p><code class="docutils literal notranslate"><span class="pre">name</span></code> is the name used in the query with the <code class="docutils literal notranslate"><span class="pre">&quot;w/&quot;</span></code> operator.
<code class="docutils literal notranslate"><span class="pre">expr</span></code> is the rex expression associated with name. <code class="docutils literal notranslate"><span class="pre">incsd</span></code> is a flag
indicating whether to include the start delimiter. <code class="docutils literal notranslate"><span class="pre">inced</span></code> is a flag
indicating whether to include the end delimiter.</p>
<p>The array is terminated with a <code class="docutils literal notranslate"><span class="pre">MDPDLM</span></code> with the name member set to
<code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code>.</p>
<p>The lists are manipulated with the <code class="docutils literal notranslate"><span class="pre">mdpstd()</span></code> and <code class="docutils literal notranslate"><span class="pre">mdpusr()</span></code>
functions to control the standard and user lists respectively.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MDPDLM</span> <span class="o">*</span><span class="n">mdpstd</span><span class="p">(</span><span class="n">MDPDLM</span> <span class="o">*</span><span class="p">);</span>
<span class="n">MDPDLM</span> <span class="o">*</span><span class="n">mdpusr</span><span class="p">(</span><span class="n">MDPDLM</span> <span class="o">*</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions set their respective lists to those provided by the
argument. They return the previous lists. Any list may be <code class="docutils literal notranslate"><span class="pre">MDPDLMPN</span></code>
to suppress its processing. The list pointers are kept in a static
global variable within the api library, so all subsequent within
operators will be effected by any changes. The table is not copied, so
the pointers passed must remain valid for the duration of all api usage.</p>
<p>Comparisons to name need only match for the length of name, thus
allowing abbreviations. e.g. The following will both match for a name of
“mess”: w/message, w/messy.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">MDPDLM</span> <span class="n">mydelims</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
   <span class="p">{</span> <span class="s2">&quot;mess&quot;</span><span class="p">,</span><span class="s2">&quot;^From:&quot;</span>         <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span> <span class="p">},</span>           <span class="o">/*</span> <span class="n">add</span> <span class="n">a</span> <span class="n">new</span> <span class="n">name</span> <span class="o">*/</span>
   <span class="p">{</span> <span class="s2">&quot;page&quot;</span><span class="p">,</span><span class="s2">&quot;-- </span><span class="se">\\</span><span class="s2">digit+ --:&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="p">},</span><span class="o">/*</span> <span class="n">override</span> <span class="n">an</span> <span class="n">existing</span> <span class="n">name</span> <span class="o">*/</span>
   <span class="p">{</span> <span class="n">CHARPN</span> <span class="p">}</span>
<span class="p">};</span>
   <span class="o">...</span>
   <span class="o">/*</span>
      <span class="n">you</span> <span class="n">could</span> <span class="n">call</span>
         <span class="n">mdpstd</span><span class="p">(</span><span class="n">MDPDLMPN</span><span class="p">);</span>
      <span class="n">to</span> <span class="n">suppress</span> <span class="n">the</span> <span class="n">standard</span> <span class="n">names</span> <span class="n">so</span> <span class="n">that</span> <span class="n">only</span> <span class="n">the</span> <span class="n">usr</span> <span class="n">names</span>
      <span class="n">would</span> <span class="n">be</span> <span class="n">recognized</span><span class="o">.</span>
   <span class="o">*/</span>
   <span class="n">mdpusr</span><span class="p">(</span><span class="n">mydelims</span><span class="p">);</span>
   <span class="o">...</span>
   <span class="n">setmmapi</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="n">query</span><span class="p">);</span>
   <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="low-level-pattern-matchers">
<h1>Low level Pattern Matchers<a class="headerlink" href="#low-level-pattern-matchers" title="Permalink to this headline">¶</a></h1>
<p><strong>*Programmers note: Do not use these functions unless you are sure you
know why you need them. Thunderstone will *not* provide technical
support involving the ``((ab=normal ?)|mis)use`` of these functions.*</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FFS</span>   <span class="o">*</span><span class="n">openrex</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="n">FFS</span>   <span class="o">*</span><span class="n">closerex</span><span class="p">(</span><span class="n">FFS</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
<span class="n">FFS</span>   <span class="o">*</span><span class="n">mknegexp</span><span class="p">(</span><span class="n">FFS</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
<span class="n">byte</span>  <span class="o">*</span><span class="n">getrex</span><span class="p">(</span><span class="n">FFS</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span><span class="nb">int</span> <span class="n">operation</span><span class="p">);</span>
<span class="nb">int</span>    <span class="n">rexsize</span><span class="p">(</span><span class="n">FFS</span> <span class="o">*</span><span class="n">ex</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>XPM - Approximate Pattern Matcher</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XPMS</span> <span class="o">*</span><span class="n">openxpm</span><span class="p">(</span><span class="n">byte</span>  <span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="nb">int</span> <span class="n">threshold</span><span class="p">);</span> <span class="o">/*</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">threshhold</span> <span class="o">&lt;</span> <span class="mi">101</span> <span class="o">*/</span>
<span class="n">XPMS</span> <span class="o">*</span><span class="n">closexpm</span><span class="p">(</span><span class="n">XPMS</span> <span class="o">*</span><span class="n">xs</span><span class="p">);</span>
<span class="n">byte</span> <span class="o">*</span><span class="n">getxpm</span><span class="p">(</span><span class="n">XPMS</span> <span class="o">*</span><span class="n">xs</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span><span class="nb">int</span> <span class="n">operation</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>PPM - Parallel String Pattern Matcher</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PPMS</span> <span class="o">*</span><span class="n">closeppm</span><span class="p">(</span><span class="n">PPMS</span> <span class="o">*</span><span class="n">ps</span><span class="p">);</span>
<span class="n">PPMS</span> <span class="o">*</span><span class="n">openppm</span><span class="p">(</span><span class="n">byte</span> <span class="o">**</span><span class="n">sl</span><span class="p">);</span>
<span class="n">byte</span> <span class="o">*</span><span class="n">getppm</span><span class="p">(</span><span class="n">PPMS</span> <span class="o">*</span><span class="n">ps</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span><span class="nb">int</span> <span class="n">operation</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>SPM - Single String Pattern Matcher</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPMS</span> <span class="o">*</span><span class="n">openspm</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="n">SPMS</span> <span class="o">*</span><span class="n">closespm</span><span class="p">(</span><span class="n">SPMS</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
<span class="n">byte</span> <span class="o">*</span><span class="n">getspm</span><span class="p">(</span><span class="n">SPMS</span> <span class="o">*</span><span class="n">fs</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span><span class="nb">int</span> <span class="n">operation</span><span class="p">);</span>
<span class="nb">int</span>   <span class="n">spmhitsz</span><span class="p">(</span><span class="n">SPMS</span> <span class="o">*</span><span class="n">fs</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>NPM - Numeric Pattern Matcher</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NPMS</span> <span class="o">*</span><span class="n">opennpm</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="n">NPMS</span> <span class="o">*</span><span class="n">closenpm</span><span class="p">(</span><span class="n">NPMS</span> <span class="o">*</span><span class="p">);</span>
<span class="n">byte</span> <span class="o">*</span><span class="n">getnpm</span><span class="p">(</span><span class="n">NPMS</span> <span class="o">*</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="p">,</span><span class="n">byte</span> <span class="o">*</span><span class="p">,</span><span class="nb">int</span><span class="p">);</span>
</pre></div>
</div>
<p>These pattern matchers represent the core search algorithms that are
present in the <strong>Metamorph</strong> program and API. Usage and syntax details
are not presented here as they are described in great detail in the
<strong>Metamorph User Manual</strong>. The programmer is encouraged to understand
their purpose and usage before implementing their own software using
these functions.</p>
<p>All of the pattern matchers behave in a similar fashion from a
programming perspective. The <code class="docutils literal notranslate"><span class="pre">open___()</span></code> call initializes the matcher
and returns a “handle” to it, and the <code class="docutils literal notranslate"><span class="pre">close___()</span></code> call <code class="docutils literal notranslate"><span class="pre">free()s</span></code>
the memory associated with that object’s “handle”. If the <code class="docutils literal notranslate"><span class="pre">open___()</span></code>
call fails for any reason it will return a cast pointer to <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<p>The arguments passed to the <code class="docutils literal notranslate"><span class="pre">open___()</span></code> call are as follows:</p>
<div class="line-block">
<div class="line">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxCall
Parameters Type(s) Example</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">openrex()</span></code> Rex expression <code class="docutils literal notranslate"><span class="pre">&quot;\\x0d\\x0a+&quot;</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">openxpm()</span></code> any string, threshold <code class="docutils literal notranslate"><span class="pre">&quot;abc</span> <span class="pre">widgets&quot;,80</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">openppm()</span></code> a list of strings <code class="docutils literal notranslate"><span class="pre">{&quot;abc&quot;,&quot;def&quot;,&quot;ghi&quot;,&quot;&quot;};</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">opennpm()</span></code> a numeric expression <code class="docutils literal notranslate"><span class="pre">&quot;&gt;1000&lt;=million&quot;</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">openspm()</span></code> a string expression <code class="docutils literal notranslate"><span class="pre">&quot;abc*def&quot;</span></code></div>
</div>
<p>In all cases, the <code class="docutils literal notranslate"><span class="pre">open___()</span></code> call is computationally intensive, as
each algorithm makes extensive use of dynamic programming techniques. It
is generally considered that the pattern matcher will be processing a
great deal of information between it’s creation and destruction so that
the creation overhead is justified by the dramatic increase in search
rates.</p>
<p>If the pattern matchers are to be used in conjunction with one another
then the programmer should optimize usage by dispatching the pattern
matchers in order of relative speed. The following table enumerates the
relative search rates:</p>
<div class="line-block">
<div class="line">xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxPattern
Types Governing factors</div>
<div class="line">SPM Fastest longer strings are faster</div>
<div class="line">REX . longer expressions are usually faster</div>
<div class="line">PPM . shorter lists with the longest minimum strlen()</div>
<div class="line">XPM . shorter strings are faster</div>
<div class="line">NPM Slowest nothing makes a difference</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">get___()</span></code> call is responsible for the location of <em>hits</em> within a
buffer of information. All of the pattern matchers share a common
parameter set for this operation:</p>
<p><strong>(object pointer, byte *buf , byte *end, int operation)</strong></p>
<dl class="simple">
<dt>object pointer</dt><dd><p>The structure pointer that was returned by the <code class="docutils literal notranslate"><span class="pre">open___()</span></code> call.</p>
</dd>
<dt>byte *buf</dt><dd><p>A pointer to the first character of the buffer to be searched  <a class="footnote-reference brackets" href="#id12" id="id11">1</a>.</p>
</dd>
<dt>byte *end</dt><dd><p>A pointer to one character past the last character in the buffer to
be searched. ( Usually obtained by the expression <code class="docutils literal notranslate"><span class="pre">buf+bufsize</span></code>).</p>
</dd>
<dt>int operation</dt><dd><p>This will be one of the four possible operation codes:
<code class="docutils literal notranslate"><span class="pre">SEARCHNEWBUF</span></code>,<code class="docutils literal notranslate"><span class="pre">CONTINUESEARCH</span></code>, <code class="docutils literal notranslate"><span class="pre">BSEARCHNEWBUF</span></code>, or
<code class="docutils literal notranslate"><span class="pre">BCONTINUESEARCH</span></code>.</p>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">SEARCHNEWBUF</span></code> to locate the first occurrence of a hit within the
delineated buffer, and the <code class="docutils literal notranslate"><span class="pre">CONTINUESEARCH</span></code> operation code indicates
that the pattern matcher should locate the next (or succesive)
occurrence. A pointer to the matched pattern will be returned or, a
<code class="docutils literal notranslate"><span class="pre">(byte</span> <span class="pre">*)NULL</span></code> if no match was located within the buffer for the given
call.</p>
<p>The operation codes <code class="docutils literal notranslate"><span class="pre">BSEARCHNEWBUF</span></code> and <code class="docutils literal notranslate"><span class="pre">BCONTINUESEARCH</span></code> are only
understood by the REX pattern matcher, and are used to search backwards
from the <code class="docutils literal notranslate"><span class="pre">end</span></code> pointer towards the <code class="docutils literal notranslate"><span class="pre">buf</span></code> pointer. A non <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
return value will point to the beginning of the matched pattern.</p>
<p>Some information about the matched hits for each of the pattern matchers
may be obtained by looking into that pattern matcher’s structure. The
following structure members are the only valid ones for an API
programmer to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">NPMS</span> <span class="o">/*</span> <span class="n">Numeric</span> <span class="n">Pattern</span> <span class="n">Matcher</span> <span class="o">*/</span>
<span class="p">{</span>
 <span class="nb">int</span> <span class="n">hitsz</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">the</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">matched</span> <span class="n">quantity</span> <span class="o">*/</span>
 <span class="n">double</span> <span class="n">hy</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">the</span> <span class="n">maximum</span> <span class="n">numeric</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">matched</span> <span class="n">string</span> <span class="o">*/</span>
 <span class="n">double</span> <span class="n">hx</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">the</span> <span class="n">minimum</span> <span class="n">numeric</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">matched</span> <span class="n">string</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PPMS</span>
<span class="p">{</span>
 <span class="n">byte</span> <span class="o">**</span><span class="n">slist</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">the</span> <span class="n">strings</span> <span class="n">being</span> <span class="n">sought</span> <span class="o">*/</span>
 <span class="nb">int</span> <span class="n">sn</span><span class="p">;</span>        <span class="o">/*</span> <span class="n">the</span> <span class="n">index</span> <span class="n">of</span> <span class="n">the</span> <span class="n">located</span> <span class="n">string</span> <span class="n">within</span> <span class="n">slist</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XPMS</span>
<span class="p">{</span>
 <span class="n">word</span> <span class="n">thresh</span><span class="p">;</span>           <span class="o">/*</span> <span class="n">threshold</span> <span class="n">above</span> <span class="n">which</span> <span class="n">a</span> <span class="n">hit</span> <span class="n">can</span> <span class="n">occur</span> <span class="o">*/</span>
 <span class="n">word</span> <span class="n">maxthresh</span><span class="p">;</span>        <span class="o">/*</span> <span class="n">the</span> <span class="nb">max</span> <span class="n">possible</span> <span class="n">value</span> <span class="n">a</span> <span class="n">match</span> <span class="n">may</span> <span class="n">have</span> <span class="o">*/</span>
 <span class="n">word</span> <span class="n">thishit</span><span class="p">;</span>          <span class="o">/*</span> <span class="n">the</span> <span class="n">value</span> <span class="n">of</span> <span class="n">this</span> <span class="n">match</span> <span class="o">*/</span>
 <span class="n">word</span> <span class="n">maxhit</span><span class="p">;</span>           <span class="o">/*</span> <span class="nb">max</span> <span class="n">value</span> <span class="n">located</span> <span class="n">so</span> <span class="n">far</span> <span class="o">*/</span>
 <span class="n">byte</span> <span class="n">maxstr</span><span class="p">[</span><span class="n">DYNABYTE</span><span class="p">];</span> <span class="o">/*</span> <span class="n">the</span> <span class="n">string</span> <span class="k">with</span> <span class="n">highest</span> <span class="n">match</span> <span class="n">value</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SPMS</span>
<span class="p">{</span>
 <span class="o">/*</span> <span class="n">no</span> <span class="n">usable</span> <span class="n">members</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FFS</span>  <span class="o">/*</span> <span class="n">aka</span> <span class="n">REX</span> <span class="o">*/</span>
<span class="p">{</span>
 <span class="o">/*</span> <span class="n">no</span> <span class="n">usable</span> <span class="n">members</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Hit length information for REX and SPM is available through calls to
<code class="docutils literal notranslate"><span class="pre">rexsize()</span></code> and <code class="docutils literal notranslate"><span class="pre">spmhitsz()</span></code> respectively. Each of these functions
return the length of the last hit located by a call to <code class="docutils literal notranslate"><span class="pre">get___()</span></code>. The
reason there are not similar calls available for the othe pattern
matchers is because their length is obtainable via the structure.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;api3.h&quot;</span>

       <span class="o">/*</span> <span class="n">this</span> <span class="n">code</span> <span class="n">breaks</span> <span class="n">some</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">interest</span> <span class="n">of</span> <span class="n">brevity</span> <span class="o">*/</span>

<span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">)</span>
<span class="nb">int</span>    <span class="n">argc</span><span class="p">;</span>
<span class="n">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>
<span class="p">{</span>
 <span class="n">void</span> <span class="o">*</span><span class="n">pm</span><span class="o">=</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">;</span>
 <span class="nb">int</span>   <span class="n">i</span><span class="p">;</span>
 <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)();</span>                    <span class="o">/*</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">close</span> <span class="n">function</span> <span class="o">*/</span>
 <span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">get</span><span class="p">)();</span>                        <span class="o">/*</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">get</span> <span class="n">function</span> <span class="o">*/</span>
 <span class="n">char</span> <span class="n">ln</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

 <span class="n">switch</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>      <span class="o">/*</span> <span class="n">determine</span> <span class="n">search</span> <span class="nb">type</span> <span class="n">via</span> <span class="n">leading</span> <span class="n">character</span> <span class="o">*/</span>
    <span class="p">{</span>
     <span class="n">case</span> <span class="s1">&#39;/&#39;</span> <span class="p">:</span> <span class="n">pm</span><span class="o">=</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">openrex</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">get</span><span class="o">=</span><span class="n">getrex</span><span class="p">;</span>
                <span class="n">close</span><span class="o">=</span><span class="n">closerex</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
     <span class="n">case</span> <span class="s1">&#39;#&#39;</span> <span class="p">:</span> <span class="n">pm</span><span class="o">=</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">opennpm</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">get</span><span class="o">=</span><span class="n">getnpm</span><span class="p">;</span>
                <span class="n">close</span><span class="o">=</span><span class="n">closenpm</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
     <span class="n">case</span> <span class="s1">&#39;%&#39;</span> <span class="p">:</span> <span class="n">pm</span><span class="o">=</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">openxpm</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">);</span>
                <span class="n">get</span><span class="o">=</span><span class="n">getxpm</span><span class="p">;</span>
                <span class="n">close</span><span class="o">=</span><span class="n">closexpm</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
 <span class="k">if</span><span class="p">(</span><span class="n">pm</span><span class="o">==</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">)</span>                    <span class="o">/*</span> <span class="n">check</span> <span class="n">to</span> <span class="n">see</span> <span class="k">if</span> <span class="n">it</span> <span class="n">opened</span> <span class="o">*/</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

 <span class="k">while</span><span class="p">(</span><span class="n">gets</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span><span class="o">!=</span><span class="n">NULL</span><span class="p">)</span>
    <span class="p">{</span>                                <span class="o">/*</span> <span class="n">see</span> <span class="k">if</span> <span class="n">there</span> <span class="n">hit</span> <span class="n">on</span> <span class="n">this</span> <span class="n">line</span> <span class="o">*/</span>
     <span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">get</span><span class="p">)(</span><span class="n">pm</span><span class="p">,(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">ln</span><span class="p">,(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">ln</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">ln</span><span class="p">)),</span><span class="n">SEARCHNEWBUF</span><span class="p">)</span>
                    <span class="o">!=</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">)</span>
         <span class="n">puts</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
    <span class="p">}</span>
 <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="n">pm</span><span class="p">);</span>
 <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="windows-addendum">
<h1>Windows Addendum<a class="headerlink" href="#windows-addendum" title="Permalink to this headline">¶</a></h1>
<p>Those using non-Microsoft compilers should also read <code class="docutils literal notranslate"><span class="pre">MSFOPEN.H</span></code>.</p>
<p>The Metamorph Windows API is provided in the form of two DLLs and their
associated export libraries:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MORPH</span><span class="o">.</span><span class="n">DLL</span>      <span class="n">MORPH</span><span class="o">.</span><span class="n">LIB</span>
<span class="n">MORPHMEM</span><span class="o">.</span><span class="n">DLL</span>   <span class="n">MORPHMEM</span><span class="o">.</span><span class="n">LIB</span>
</pre></div>
</div>
<p>Both DLLs must be available for Metamorph applications at run time.
<code class="docutils literal notranslate"><span class="pre">MORPHMEM.DLL</span></code> contains all memory handling functions.</p>
<p>The entire Metamorph API was compiled large model with the PASCAL
calling convention. All function calls are therefore PASCAL unless
declared otherwise. <code class="docutils literal notranslate"><span class="pre">Putmsg()</span></code> uses the C calling convention since it
has a variable number of arguments. All data passed to and from API
functions must be <code class="docutils literal notranslate"><span class="pre">FAR</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">Putmsg()</span></code> is handled a little differently under Windows since the
version in the DLL can not be effectively replaced. The default behavior
of `` putmsg()`` is to write to file handle 2. To change the output file
call <code class="docutils literal notranslate"><span class="pre">setmmsgfname()</span></code> with the name of the file to write to. To change
the output file to an already opened file call <code class="docutils literal notranslate"><span class="pre">setmmsgfh()</span></code> with the
opened file handle. To change the message handling function completely
call <code class="docutils literal notranslate"><span class="pre">setmmsg()</span></code> with a pointer to your message handling function. See
the descriptions of these functions for more details.</p>
<p>Message handling should be setup before calling any Metamorph API
functions that could fail so that messages will go to a known place.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">MMEXW.C</span></code> for working examples. <code class="docutils literal notranslate"><span class="pre">MMEXW.MAK</span></code> is a Quick C 1.00
project file for <code class="docutils literal notranslate"><span class="pre">MMEXW</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;windows.h&quot;</span>
<span class="c1">#include &quot;stdio.h&quot;</span>
<span class="c1">#include &quot;api3.h&quot;</span>
<span class="c1">#include &quot;mmsg.h&quot;</span>

<span class="n">char</span> <span class="n">FAR</span> <span class="o">*</span> <span class="n">FAR</span> <span class="n">setmmsgfname</span><span class="p">(</span><span class="n">newfname</span><span class="p">)</span>
<span class="n">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">newfname</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Setmmsgfname()</span></code> will change the file that <code class="docutils literal notranslate"><span class="pre">putmsg</span></code> writes messages
to. It returns its argument. The default is to write messages to file
handle 2 <code class="docutils literal notranslate"><span class="pre">(stderr)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">APICP</span> <span class="o">*</span><span class="n">acp</span><span class="p">;</span>

<span class="o">...</span>

<span class="n">setmmsgfname</span><span class="p">(</span><span class="s2">&quot;msg.001&quot;</span><span class="p">);</span>    <span class="o">/*</span> <span class="nb">set</span> <span class="n">message</span> <span class="n">file</span> <span class="n">name</span> <span class="n">to</span> <span class="n">msg</span><span class="o">.</span><span class="mi">001</span> <span class="o">*/</span>

<span class="o">...</span>

<span class="n">acp</span><span class="o">=</span><span class="n">openapicp</span><span class="p">();</span>              <span class="o">/*</span> <span class="nb">open</span> <span class="n">mm</span> <span class="n">api</span> <span class="n">control</span> <span class="n">parameters</span> <span class="o">*/</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;windows.h&quot;</span>
<span class="c1">#include &quot;stdio.h&quot;</span>
<span class="c1">#include &quot;api3.h&quot;</span>
<span class="c1">#include &quot;mmsg.h&quot;</span>

<span class="nb">int</span> <span class="n">FAR</span> <span class="n">setmmsgfh</span><span class="p">(</span><span class="n">newfhandle</span><span class="p">)</span>
<span class="nb">int</span> <span class="n">newfhandle</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Setmmsgfh()</span></code> will change the file handle that <code class="docutils literal notranslate"><span class="pre">putmsg</span></code> writes
messages to. It returns its argument. The default is to write messages
to file handle 2 <code class="docutils literal notranslate"><span class="pre">(stderr)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">fh</span><span class="p">;</span>
<span class="n">OFSTRUCT</span> <span class="n">mmsginfo</span><span class="p">;</span>
<span class="n">APICP</span> <span class="o">*</span><span class="n">acp</span><span class="p">;</span>

<span class="o">...</span>

                              <span class="o">/*</span> <span class="nb">open</span> <span class="n">file</span> <span class="n">msg</span><span class="o">.</span><span class="mi">001</span> <span class="ow">in</span> <span class="s2">&quot;wb&quot;</span> <span class="n">mode</span> <span class="o">*/</span>
<span class="n">fh</span><span class="o">=</span><span class="n">OpenFile</span><span class="p">(</span><span class="s2">&quot;msg.001&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mmsginfo</span><span class="p">,</span>
            <span class="p">(</span><span class="n">OF_CANCEL</span><span class="o">|</span><span class="n">OF_CREATE</span><span class="o">|</span><span class="n">OF_WRITE</span><span class="o">|</span><span class="n">OF_SHARE_DENY_NONE</span><span class="p">));</span>

<span class="k">if</span><span class="p">(</span><span class="n">fh</span><span class="o">!=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="n">setmmsgfh</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>    <span class="o">/*</span> <span class="nb">set</span> <span class="n">message</span> <span class="n">file</span> <span class="n">handle</span> <span class="k">if</span> <span class="n">ok</span> <span class="o">*/</span>

<span class="o">...</span>

<span class="n">acp</span><span class="o">=</span><span class="n">openapicp</span><span class="p">();</span>              <span class="o">/*</span> <span class="nb">open</span> <span class="n">mm</span> <span class="n">api</span> <span class="n">control</span> <span class="n">parameters</span> <span class="o">*/</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;windows.h&quot;</span>
<span class="c1">#include &quot;stdio.h&quot;</span>
<span class="c1">#include &quot;stdarg.h&quot;</span>
<span class="c1">#include &quot;api3.h&quot;</span>
<span class="c1">#include &quot;mmsg.h&quot;</span>

<span class="n">void</span> <span class="n">FAR</span> <span class="n">setmmsg</span><span class="p">(</span><span class="n">newfunction</span><span class="p">)</span>
<span class="nb">int</span> <span class="p">(</span><span class="n">FAR</span> <span class="o">*</span><span class="n">newfunction</span><span class="p">)(</span><span class="nb">int</span> <span class="n">msgn</span><span class="p">,</span> <span class="n">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span> <span class="n">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
                       <span class="n">va_list</span> <span class="n">args</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Setmmsg()</span></code> will set the function to call to handle messages from
<code class="docutils literal notranslate"><span class="pre">putmsg()</span></code>. The handler function will receive four arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">:</span> <span class="nb">int</span> <span class="n">msgn</span><span class="p">;</span>     <span class="n">the</span> <span class="n">message</span> <span class="n">number</span>       <span class="p">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">putmsg</span><span class="p">())</span>
<span class="mi">2</span><span class="p">:</span> <span class="n">char</span> <span class="o">*</span><span class="n">fn</span><span class="p">;</span>     <span class="n">the</span> <span class="n">function</span> <span class="n">name</span>        <span class="p">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">putmsg</span><span class="p">())</span>
<span class="mi">3</span><span class="p">:</span> <span class="n">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>    <span class="n">the</span> <span class="n">htpf</span> <span class="nb">format</span> <span class="n">string</span>   <span class="p">(</span><span class="n">same</span> <span class="k">as</span> <span class="n">putmsg</span><span class="p">())</span>
<span class="mi">4</span><span class="p">:</span> <span class="n">va_list</span> <span class="n">args</span><span class="p">;</span> <span class="n">the</span> <span class="n">stdarg</span> <span class="n">argument</span> <span class="nb">list</span> <span class="k">as</span> <span class="n">derived</span> <span class="ow">in</span> <span class="n">putmsg</span><span class="p">()</span>
<span class="n">by</span> <span class="n">the</span> <span class="n">va_start</span><span class="p">()</span> <span class="n">call</span><span class="o">.</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">args</span></code> variable may be used like any <code class="docutils literal notranslate"><span class="pre">va_list</span></code> that has been
<code class="docutils literal notranslate"><span class="pre">va_start()'d</span></code>. e.g. in a call to <code class="docutils literal notranslate"><span class="pre">WVSPRINTF()</span></code>. Do <em>not</em> call
<code class="docutils literal notranslate"><span class="pre">va_end()</span></code> on <code class="docutils literal notranslate"><span class="pre">args</span></code>.</p>
<p>The handler function pointer must be the result of the Windows
<code class="docutils literal notranslate"><span class="pre">MakeProcInstance()</span></code> call so that it can be called correctly from
within the Metamorph API DLL. See your Windows SDK manual for details on
<code class="docutils literal notranslate"><span class="pre">MakeProcInstance()</span></code>. You should not use <code class="docutils literal notranslate"><span class="pre">MakeProcInstance()</span></code> more
than once for any given function if possible. Each call to it will use a
little memory.</p>
<p>The return value of the handler function will be returned by
<code class="docutils literal notranslate"><span class="pre">putmsg()</span></code> to the original caller.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

                                     <span class="o">/*</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">message</span> <span class="n">handler</span> <span class="o">*/</span>
<span class="nb">int</span> <span class="n">FAR</span> <span class="n">PASCAL</span>
<span class="n">msghandler</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">,</span><span class="n">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">fn</span><span class="p">,</span><span class="n">char</span> <span class="n">FAR</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span><span class="n">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">static</span> <span class="n">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>                     <span class="o">/*</span> <span class="n">place</span> <span class="n">to</span> <span class="n">sprintf</span> <span class="n">to</span> <span class="o">*/</span>
<span class="n">char</span>        <span class="o">*</span><span class="n">d</span><span class="p">;</span>

   <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">)</span>        <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s2">&quot;ERROR: &quot;</span><span class="p">);</span>
   <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">&gt;=</span><span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">&lt;</span><span class="mi">200</span><span class="p">)</span> <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s2">&quot;WARNING: &quot;</span><span class="p">);</span>
   <span class="k">else</span>                     <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s2">&quot;FYI: &quot;</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">fmt</span><span class="o">!=</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">){</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
      <span class="n">htsnpf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">-</span> <span class="n">d</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span><span class="p">(</span><span class="n">fn</span><span class="o">!=</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">){</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s2">&quot; In the function: &quot;</span><span class="p">);</span>
      <span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">fn</span><span class="p">);</span>
   <span class="p">}</span>
            <span class="o">/*</span> <span class="n">display</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">standard</span> <span class="n">windows</span> <span class="n">message</span> <span class="n">box</span> <span class="o">*/</span>
   <span class="n">MessageBox</span><span class="p">(</span><span class="n">GetFocus</span><span class="p">(),(</span><span class="n">LPSTR</span><span class="p">)</span><span class="n">buf</span><span class="p">,(</span><span class="n">LPSTR</span><span class="p">)</span><span class="s2">&quot;Metamorph 3 Message&quot;</span><span class="p">,</span><span class="n">MB_OK</span><span class="p">);</span>
   <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">...</span>

<span class="n">HANDLE</span> <span class="n">hInst</span><span class="p">;</span>                              <span class="o">/*</span> <span class="n">current</span> <span class="n">instance</span> <span class="o">*/</span>
<span class="n">FARPROC</span> <span class="n">m</span><span class="p">;</span>
<span class="n">APICP</span> <span class="o">*</span><span class="n">acp</span><span class="p">;</span>

   <span class="o">...</span>

   <span class="n">putmsg</span><span class="p">(</span><span class="n">MINFO</span><span class="p">,(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">,</span><span class="s2">&quot;Default handler active&quot;</span><span class="p">);</span>

   <span class="n">m</span><span class="o">=</span><span class="n">MakeProcInstance</span><span class="p">(</span><span class="n">msghandler</span><span class="p">,</span><span class="n">hInst</span><span class="p">);</span>

   <span class="k">if</span><span class="p">(</span><span class="n">m</span><span class="o">!=</span><span class="p">(</span><span class="n">FARPROC</span><span class="p">)</span><span class="n">NULL</span><span class="p">){</span>

      <span class="n">setmmsg</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>

      <span class="n">putmsg</span><span class="p">(</span><span class="n">MINFO</span><span class="p">,(</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">,</span><span class="s2">&quot;My custom handler active&quot;</span><span class="p">);</span>

   <span class="p">}</span>

   <span class="o">...</span>

   <span class="n">acp</span><span class="o">=</span><span class="n">openapicp</span><span class="p">();</span>          <span class="o">/*</span> <span class="nb">open</span> <span class="n">mm</span> <span class="n">api</span> <span class="n">control</span> <span class="n">parameters</span> <span class="o">*/</span>
</pre></div>
</div>
<p>Windows programs are generally case insensitive pascal calling sequence.
Using the Metamorph API under Borland C with case sensitivity and C
calling sequence as defaults requires a little adjustment.</p>
<p><strong>Borland C options:</strong></p>
<ol class="arabic simple">
<li><p>Windows large model exe.</p></li>
<li><p>define_WINDOWS.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Borland</span> <span class="pre">C++</span> <span class="pre">source</span></code> (detect <code class="docutils literal notranslate"><span class="pre">C/C++</span></code> by extension).</p></li>
<li><p>Case sensitive exports as well as case sensitive link.</p></li>
</ol>
<p><strong>api3.h modifications:</strong></p>
<ol class="arabic simple">
<li><p>Insert the “pascal” keyword before each function name in its
prototype.</p></li>
<li><p>Redefine all functions as uppercase before their prototypes. (e.g.
<code class="docutils literal notranslate"><span class="pre">&quot;#define</span> <span class="pre">rdmmapi</span> <span class="pre">RDMMAPI&quot;</span></code>)</p></li>
</ol>
<dl class="footnote brackets">
<dt class="label" id="id12"><span class="brackets"><a class="fn-backref" href="#id11">1</a></span></dt>
<dd><p>byte is defined as an unsigned char</p>
</dd>
</dl>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Moat Crossing Systems.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>