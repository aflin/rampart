

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Texis Network Client API &mdash; Rampart 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Rampart 0.1.0 documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Rampart
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <!-- Local TOC -->
                <div class="local-toc"><ul>
<li><a class="reference internal" href="#">The Texis Network Client API</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#network-api-common-functions">Network API common functions</a></li>
<li><a class="reference internal" href="#sql-interface-version-2">SQL Interface Version 2</a></li>
<li><a class="reference internal" href="#texis-specific-functions">Texis specific functions</a></li>
<li><a class="reference internal" href="#modifying-the-server">Modifying the server</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rampart</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>The Texis Network Client API</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/texis5.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-texis-network-client-api">
<h1>The Texis Network Client API<a class="headerlink" href="#the-texis-network-client-api" title="Permalink to this headline">¶</a></h1>
<p>[Part:V:Chp:tnapi][Part:V:Chp:Embed]</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This chapter provides a reference to the functions that you will need to
use to write your own custom application that talks to Texis. This API
is flexible enough to support both a procedural programming style as
well as an event driven style.</p>
<p>Most applications can be written in Vortex, and executed via <code class="docutils literal notranslate"><span class="pre">texis</span></code>.
Vortex provides a simple programming language which allows applications
to be written and tested quickly. Since the Vortex code handles the
details of extracting data from the web server, maintaining variable
state, and many of the repetitive tasks in generating user output, as
well as being automatically compiled when the script is changed it
allows for rapid development, deployment, and provides excellent
performance for interactive applications.</p>
<p>The API is provided for applications that may require linking with other
APIs that would not be good candidates for user defined Vortex functions
and for applications where the request/response paradigm of the web is
not appropriate.</p>
<p><strong>Server Connection Management</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">openserver</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="n">SERVER</span> <span class="o">*</span><span class="n">closeserver</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">serverhandle</span><span class="p">)</span>
<span class="nb">int</span>     <span class="n">serveruser</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">username</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">servergroup</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">groupname</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">serverpass</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">password</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Texis control parameters</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_setdatabase</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">database</span><span class="p">);</span>
<span class="nb">str</span> <span class="n">n_getdatabase</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>SQL interface Version 2</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TSQL</span>   <span class="o">*</span><span class="n">n_opentsql</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">);</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">n_closetsql</span><span class="p">(</span><span class="n">TSQL</span> <span class="o">*</span><span class="n">ts</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_settsql</span><span class="p">(</span><span class="n">TSQL</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">stmt</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_exectsql</span><span class="p">(</span><span class="n">TSQL</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_gettsql</span><span class="p">(</span><span class="n">TSQL</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="nb">format</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_dotsql</span><span class="p">(</span><span class="n">TSQL</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">stmt</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_resulttsql</span><span class="p">(</span><span class="n">TSQL</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span><span class="nb">int</span> <span class="n">flag</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>SQL interface</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>     <span class="n">n_texis</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">queryformat</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">n_closetx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">n_opentx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">);</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">n_duptx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">n_settx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">queryformat</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">n_preptx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">queryformat</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">n_exectx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_runtx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">n_gettx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">freefldlst</span><span class="p">(</span><span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_settexisparam</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="nb">int</span> <span class="n">ipar</span><span class="p">,</span><span class="n">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="nb">int</span> <span class="o">*</span><span class="nb">len</span><span class="p">,</span>
                        <span class="nb">int</span> <span class="n">ctype</span><span class="p">,</span><span class="nb">int</span> <span class="n">sqltype</span><span class="p">)</span>
<span class="nb">int</span>     <span class="n">n_paramtx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="nb">int</span> <span class="n">ipar</span><span class="p">,</span><span class="n">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="nb">int</span> <span class="o">*</span><span class="nb">len</span><span class="p">,</span>
                        <span class="nb">int</span> <span class="n">ctype</span><span class="p">,</span><span class="nb">int</span> <span class="n">sqltype</span><span class="p">)</span>
<span class="nb">int</span> <span class="n">n_resetparamtx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_flushtx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">n_flushtx2</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="nb">int</span> <span class="n">nrows</span><span class="p">,</span> <span class="nb">int</span> <span class="nb">max</span><span class="p">);</span>
<span class="n">MMOFFS</span> <span class="o">*</span><span class="n">n_offstx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">fieldname</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_regtexiscb</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">,</span><span class="n">func</span> <span class="n">cb</span><span class="p">);</span>
    <span class="n">func</span> <span class="n">cb</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">,</span><span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Hit information</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SRCHLST</span> <span class="o">*</span><span class="n">n_getsrchlst</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">SRCHLST</span> <span class="o">*</span><span class="n">n_freesrchlst</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCHLST</span> <span class="o">*</span><span class="n">sl</span><span class="p">);</span>
<span class="n">SRCHI</span>   <span class="o">*</span><span class="n">n_srchinfo</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCH</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span><span class="nb">int</span> <span class="n">i</span><span class="p">);</span>
<span class="n">SRCHI</span>   <span class="o">*</span><span class="n">n_freesrchi</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCHI</span> <span class="o">*</span><span class="n">si</span><span class="p">);</span>
<span class="n">XPMI</span>    <span class="o">*</span><span class="n">n_xpminfo</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCH</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span><span class="nb">int</span> <span class="n">i</span><span class="p">);</span>
<span class="n">XPMI</span>    <span class="o">*</span><span class="n">n_freexpmi</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">XPMI</span> <span class="o">*</span><span class="n">xi</span><span class="p">);</span>
<span class="nb">int</span>  <span class="n">n_getindexcount</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>Object manipulation</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span> <span class="o">*</span><span class="n">n_newindirect</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">database</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span>
                    <span class="n">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>File transfer</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_rcopyto</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">remotedest</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">localsrc</span><span class="p">);</span>
<span class="nb">int</span> <span class="n">n_rcopyfrom</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">localdest</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">remotesrc</span><span class="p">);</span>
</pre></div>
</div>
<p>The Texis API provides the client program with an easy to use interface
to any Texis server without regard to machine type. This is the
preferred interface and completely unrelated to the ODBC interface which
is documented elsewhere.</p>
<p><strong>The network Metamorph API is also contained within the Texis server
and available to client programs.</strong> It is documented separately. Please
see its documentation in Part VI. The programmer is <em>strongly</em>
encouraged to play with the example programs provided with the package
before attempting their own implementation. It is also suggested that
you experiment with <code class="docutils literal notranslate"><span class="pre">txtoc</span></code> as well, as it can generate an outline to
start from.</p>
<dl class="simple">
<dt>Server Connection Management</dt><dd><p>These functions allow you to connect and disconnect from a server.
The return value from <code class="docutils literal notranslate"><span class="pre">openserver()</span></code> is a <code class="docutils literal notranslate"><span class="pre">SERVER</span> <span class="pre">*</span></code>, and will
be used as the first parameter in all subsequent calls to the
Server.</p>
</dd>
<dt>SQL interface</dt><dd><p>This group of operations is for passing a user’s query onto the
server for processing and subsequently obtaining the results. There
are two different versions of the SQL interface. Version 2 is a
higher level interface, which provides the same functionality, but
simplifies many operations by working directly with your variables.
This is the preferred interface for most applications.</p>
</dd>
<dt>Hit registration</dt><dd><p>These functions tell the server which client function to “<em>call
back</em>” when it has located information pertinent to the query.</p>
</dd>
<dt>Hit information</dt><dd><p>These functions allow you to obtain detailed information about any
Metamorph queries that may have been used in the query.</p>
</dd>
<dt>Object manipulation</dt><dd><p>These functions allow you to manipulate indirect fields within a
Texis database.</p>
</dd>
<dt>File transfer</dt><dd><p>These functions provide the ability to transfer entire files between
the client and server.</p>
</dd>
<dt>Texis control parameters</dt><dd><p>This set of functions is for getting and changing the various
operational parameters that define how a remote Texis performs.</p>
</dd>
</dl>
</div>
<div class="section" id="network-api-common-functions">
<h2>Network API common functions<a class="headerlink" href="#network-api-common-functions" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;tstone.h&quot;</span>
<span class="n">SERVER</span> <span class="o">*</span><span class="n">openserver</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">port</span><span class="p">);</span>
<span class="n">SERVER</span> <span class="o">*</span><span class="n">closeserver</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">serverhandle</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">serveruser</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">username</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">servergroup</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">groupname</span><span class="p">);</span>
<span class="nb">int</span>     <span class="n">serverpass</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">password</span><span class="p">);</span>
</pre></div>
</div>
<p>These rather generic sounding functions are for establishing or
disconnecting a communication channel to a Thunderstone Server. The
presumption is made that the host and port you open is the correct one
for the type of calls you will be making.</p>
<p>In general, the <code class="docutils literal notranslate"><span class="pre">openserver()</span></code> call returns a handle to the requested
service at the specified <code class="docutils literal notranslate"><span class="pre">hostname</span></code> and <code class="docutils literal notranslate"><span class="pre">port</span></code>. The returned handle
is of the type <code class="docutils literal notranslate"><span class="pre">SERVER</span> <span class="pre">*</span></code> and will have the value <code class="docutils literal notranslate"><span class="pre">SERVERPN</span></code> <a class="footnote-reference brackets" href="#id16" id="id1">1</a>
if there’s a problem.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">closeserver()</span></code> call shuts the open communication channel with a
server and frees the allocated memory on both the client and the server
associated with the connection. <code class="docutils literal notranslate"><span class="pre">closeserver()</span></code> will return the value
<code class="docutils literal notranslate"><span class="pre">SERVERPN</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">hostname</span></code> is a string that is the given internet name or number
of the machine on which the requested service is running. For example:
<code class="docutils literal notranslate"><span class="pre">thunder.thunderstone.com</span></code> or <code class="docutils literal notranslate"><span class="pre">198.49.220.81</span></code>. The port number is
also a string, and is the port number assigned to the service when it is
brought up initially on the server machine. The port number may also be
assigned a name of a service that is enumerated in the file
<code class="docutils literal notranslate"><span class="pre">/etc/services</span></code>.</p>
<p>Either <code class="docutils literal notranslate"><span class="pre">hostname</span></code> or <code class="docutils literal notranslate"><span class="pre">port</span></code> or both may be the empty string (<code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>)
indicating that the compiled in default is to be used. The default for
<code class="docutils literal notranslate"><span class="pre">hostname</span></code> is <code class="docutils literal notranslate"><span class="pre">&quot;localhost&quot;</span></code> indicating the same machine that the
client application is running on. The default <code class="docutils literal notranslate"><span class="pre">port</span></code> is <code class="docutils literal notranslate"><span class="pre">&quot;10000&quot;</span></code>
for Metamorph and <code class="docutils literal notranslate"><span class="pre">&quot;10002&quot;</span></code> for Texis.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">serveruser()</span></code>, <code class="docutils literal notranslate"><span class="pre">servergroup()</span></code>, and <code class="docutils literal notranslate"><span class="pre">serverpass()</span></code> calls set
the user name, group name, and password, respectively, that
<code class="docutils literal notranslate"><span class="pre">openserver()</span></code> will use when logging into the server. These functions
will return zero on error. Non-zero is returned on success. If
<code class="docutils literal notranslate"><span class="pre">servergroup()</span></code> is not used, the user will be logged into their
default group as defined by the server.</p>
<p>The default user name and password are both the empty string (<code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>).</p>
<p>If no user name is given then Texis will default to PUBLIC. If a user
name and password is given then Texis will verify them against the users
defined in Texis. You can use <code class="docutils literal notranslate"><span class="pre">tsql</span></code> to add users. See
Chapter [Chp:Sec] for an in-depth discussion of security.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SERVER *se;                              /* network server pointer */
SRCH   *sr;                                      /* search pointer */

                                          /* connect to the server */
if(serveruser(&quot;me&quot;)         &amp;&amp;
   servergroup(&quot;somegroup&quot;) &amp;&amp;
   serverpass(&quot;mypassword&quot;) &amp;&amp;
   (se=openserver(&quot;thunder.thunderstone.com&quot;,&quot;666&quot;))!=SERVERPN)
   {
    n_reghitcb(se,(void *)NULL,mycallback);  /* setup hit callback */
    if((sr=n_setqry(se,&quot;power struggle&quot;))!=SRCHPN)  /* setup query */
        {
         if(!n_search(se,sr))                     /* find all hits */
             puts(&quot;n_search() failed&quot;);
         n_closesrch(se,sr);                  /* cleanup the query */
        }
    closeserver(se);                     /* disconnect from server */
   }
</pre></div>
</div>
<p>Make sure you are talking to the right port!</p>
<p><code class="docutils literal notranslate"><span class="pre">/etc/services</span></code>, <code class="docutils literal notranslate"><span class="pre">services(4)</span></code></p>
<p>There are numerous other API calls that may be used to control the
behavior of Metamorph <code class="docutils literal notranslate"><span class="pre">like</span></code> searches in SQL statements. See section
[napi:mmctrl] for a listing of those functions.</p>
</div>
<div class="section" id="sql-interface-version-2">
<h2>SQL Interface Version 2<a class="headerlink" href="#sql-interface-version-2" title="Permalink to this headline">¶</a></h2>
<p>All files needed to build Texis clients are installed into the
<code class="docutils literal notranslate"><span class="pre">/usr/local/morph3/api</span></code> directory. This directory should be added to
your compiler include and linker library paths. This directory also
contains example client source code and a <code class="docutils literal notranslate"><span class="pre">makefile</span></code> that can be used
as a model. <code class="docutils literal notranslate"><span class="pre">sqlex1.c</span></code> is an example of using this API.</p>
<p>Source code needs to <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;tstone.h&quot;</span></code>. <code class="docutils literal notranslate"><span class="pre">tstone.h</span></code> also requires
<code class="docutils literal notranslate"><span class="pre">sys/types.h</span></code> if it has not been included already.</p>
<p>Executables need to be linked with <code class="docutils literal notranslate"><span class="pre">libntexis.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libapi3.a</span></code>,
<code class="docutils literal notranslate"><span class="pre">txclnop.o</span></code>, and the standard math lib. Also some platforms don’t
include TCP/IP socket calls in the standard libs. These platforms will
need them added to the link list. They are typically called
<code class="docutils literal notranslate"><span class="pre">libsocket.a</span></code>, <code class="docutils literal notranslate"><span class="pre">libnsl.a</span></code>, and <code class="docutils literal notranslate"><span class="pre">libresolv.a</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cc</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">morph3</span><span class="o">/</span><span class="n">api</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span><span class="n">c</span> <span class="n">sqlex1</span><span class="o">.</span><span class="n">c</span>
<span class="n">cc</span> <span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">morph3</span><span class="o">/</span><span class="n">api</span> <span class="n">sqlex1</span><span class="o">.</span><span class="n">o</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">morph3</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">txclnop</span><span class="o">.</span><span class="n">o</span>
   <span class="o">-</span><span class="n">lntexis</span> <span class="o">-</span><span class="n">lapi3</span> <span class="o">-</span><span class="n">lm</span> <span class="o">-</span><span class="n">o</span> <span class="n">sqlex1</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cc</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">morph3</span><span class="o">/</span><span class="n">api</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span><span class="n">c</span> <span class="n">sqlex1</span><span class="o">.</span><span class="n">c</span>
<span class="n">cc</span> <span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">morph3</span><span class="o">/</span><span class="n">api</span> <span class="n">sqlex1</span><span class="o">.</span><span class="n">o</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">morph3</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">txclnop</span><span class="o">.</span><span class="n">o</span>
   <span class="o">-</span><span class="n">lntexis</span> <span class="o">-</span><span class="n">lapi3</span> <span class="o">-</span><span class="n">lm</span> <span class="o">-</span><span class="n">lsocket</span> <span class="o">-</span><span class="n">lnsl</span> <span class="o">-</span><span class="n">lresolv</span> <span class="o">-</span><span class="n">o</span> <span class="n">sqlex1</span>
</pre></div>
</div>
<p>or (with the example makefile)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">sqlex1</span>
</pre></div>
</div>
<p>You should not work directly in the <code class="docutils literal notranslate"><span class="pre">/usr/local/morph3/api</span></code> directory.
You should make separate a directory to work in and copy the example
source and makefile to that directory and work there.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;tstone.h&quot;</span>

<span class="n">TSQL</span> <span class="o">*</span><span class="n">n_opentsql</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
<span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>

<span class="n">TSQL</span> <span class="o">*</span><span class="n">n_closetsql</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_opentsql()</span></code> performs the initialization required to perform a Texis
SQL query. It returns a pointer to a structure that will be required by
the <code class="docutils literal notranslate"><span class="pre">n_settsql(),</span> <span class="pre">n_exectsql(),</span> <span class="pre">n_gettsql()</span></code> and <code class="docutils literal notranslate"><span class="pre">n_closetsql()</span></code>
functions. It takes one argument that is an opened <code class="docutils literal notranslate"><span class="pre">SERVER</span></code> pointer
(from <code class="docutils literal notranslate"><span class="pre">openserver()</span></code>). The <code class="docutils literal notranslate"><span class="pre">SERVER</span></code> pointer must remain open as long
as the <code class="docutils literal notranslate"><span class="pre">TSQL</span></code> is open. <code class="docutils literal notranslate"><span class="pre">n_opentsql()</span></code> returns <code class="docutils literal notranslate"><span class="pre">TSQLPN</span></code> <a class="footnote-reference brackets" href="#id17" id="id2">2</a> on
failure.</p>
<p>All subsequent <code class="docutils literal notranslate"><span class="pre">...tsql()</span></code> family calls will take the <code class="docutils literal notranslate"><span class="pre">TSQL</span></code> pointer
as their first argument.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_closetsql()</span></code> cleans up all data used used by <code class="docutils literal notranslate"><span class="pre">n_opentsql()</span></code>. It
takes the <code class="docutils literal notranslate"><span class="pre">TSQL</span></code> pointer to close as its only argument. This must be
called before shutting the <code class="docutils literal notranslate"><span class="pre">SERVER</span></code> connection given to
<code class="docutils literal notranslate"><span class="pre">n_opentsql()</span></code>. <code class="docutils literal notranslate"><span class="pre">n_closetsql()</span></code> always returns TSQLPN.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">database</span><span class="p">;</span>

   <span class="o">...</span>
                     <span class="o">/*</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">the</span> <span class="n">local</span> <span class="n">host</span> <span class="n">on</span> <span class="n">the</span> <span class="n">default</span> <span class="n">port</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">((</span><span class="n">se</span><span class="o">=</span><span class="n">openserver</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">!=</span><span class="n">SERVERPN</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">n_setdatabase</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">database</span><span class="p">);</span>          <span class="o">/*</span> <span class="nb">set</span> <span class="n">the</span> <span class="n">database</span> <span class="n">to</span> <span class="n">use</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">((</span><span class="n">ts</span><span class="o">=</span><span class="n">n_opentsql</span><span class="p">(</span><span class="n">se</span><span class="p">))</span><span class="o">!=</span><span class="n">TSQLPN</span><span class="p">)</span> <span class="o">/*</span> <span class="n">initialize</span> <span class="n">the</span> <span class="n">Texis</span> <span class="n">SQL</span> <span class="n">API</span> <span class="o">*/</span>
      <span class="p">{</span>

         <span class="o">/*</span> <span class="o">...</span> <span class="n">perform</span> <span class="n">SQL</span> <span class="n">processing</span> <span class="o">...</span> <span class="o">*/</span>

         <span class="n">n_closetsql</span><span class="p">(</span><span class="n">ts</span><span class="p">);</span>               <span class="o">/*</span> <span class="n">shutdown</span> <span class="n">the</span> <span class="n">Texis</span> <span class="n">SQL</span> <span class="n">API</span> <span class="o">*/</span>
      <span class="p">}</span>
      <span class="n">closeserver</span><span class="p">(</span><span class="n">se</span><span class="p">);</span>                  <span class="o">/*</span> <span class="n">disconnect</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">server</span> <span class="o">*/</span>
   <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openserver</span><span class="p">(),</span> <span class="n">n_settsql</span><span class="p">(),</span> <span class="n">n_gettsql</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;tstone.h&quot;</span>

<span class="nb">int</span> <span class="n">n_settsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">stmt</span><span class="p">)</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">stmt</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">n_exectsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code> takes a SQL statement, parses it, and prepares to
execute it. All SQL statements must end with a semi-colon (<code class="docutils literal notranslate"><span class="pre">;</span></code>). Only
one SQL statement at a time may be included in the <code class="docutils literal notranslate"><span class="pre">stmt</span></code> argument.
The statement may contain <code class="docutils literal notranslate"><span class="pre">printf</span></code> like formatting codes. These
formatting codes may appear anywhere in the SQL statement that data
constants would otherwise appear (e.g.: as the values for insert or the
data to perform comparisons on in a select). The data for the formatting
codes are provided via the <code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code> function.</p>
<p>The following table summarizes the format codes and their respective
data types. See the <strong>formatting codes</strong> man page for full descriptions.</p>
<p>[tab:efmtcodes]</p>
<div class="line-block">
<div class="line">|l|l|l|l|</div>
<div class="line">&amp; <em>Description</em> &amp; <em>C Type</em> &amp; <em>SQL Type</em></div>
<div class="line">%b &amp; Raw binary data &amp; byte * &amp; BYTE</div>
<div class="line">%p%n &amp; Raw binary data &amp; byte * &amp; BYTE</div>
<div class="line">%s &amp; Character string &amp; char * &amp; CHAR</div>
<div class="line">%lf &amp; Double precision floating point &amp; double &amp; DOUBLE</div>
<div class="line">%lu &amp; Unix date stored as time_t &amp; long &amp; DATE</div>
<div class="line">%f &amp; Single precision floating point &amp; float &amp; FLOAT</div>
<div class="line">%d &amp; 32/64-bit signed integer &amp; long &amp; INTEGER</div>
<div class="line">%ld &amp; 32/64-bit signed integer &amp; long &amp; INTEGER</div>
<div class="line">%hd &amp; 16-bit signed integer &amp; short &amp; SMALLINT</div>
<div class="line">%w &amp; 16-bit unsigned integer &amp; word &amp; UNSIGNED SMALLINT</div>
<div class="line">%s &amp; Name of external file &amp; char * &amp; INDIRECT</div>
<div class="line">%<span class="math notranslate nohighlight">\(&lt;\)</span> &amp; Name of external file &amp; char * &amp; INDIRECT</div>
<div class="line">%dw &amp; 32-bit unsigned integer &amp; dword &amp; UNSIGNED INTEGER</div>
<div class="line">%64d &amp; 64-bit signed integer &amp; EPI_INT64 &amp; INT64</div>
<div class="line">%64u &amp; 64-bit unsigned integer &amp; EPI_UINT64 &amp; UINT64</div>
<div class="line">%c &amp; Unique serial number &amp; ft_counter * &amp; COUNTER</div>
<div class="line">%ls &amp; A list of allocated strings &amp; char ** &amp; STRLST</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code> takes a variable argument list that is a list of
pointers to the data to be passed into the query. <code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code> may
be issued as many times as desired for the same statement. When issuing
a statement where you want to get the resultant rows, such as
<code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, you will need to use <code class="docutils literal notranslate"><span class="pre">n_gettsql()</span></code> (see its man page).
Variables passed to <code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code> are not modified or <code class="docutils literal notranslate"><span class="pre">free()</span></code>’d.</p>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statements will always generate result rows. By default
<code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> statements will not. To enable result rows
from <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> see <code class="docutils literal notranslate"><span class="pre">n_resulttsql()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code> and <code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code> both return 0 on failure and non-0
on success.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*
  This example loads records into a table called docs that has the
  following fields:

  Name    Type       Description
  ----    ----       -----------
  ctr     counter    a handy unique key field
  text    varchar    the text ocr&#39;d off the image
  thumb   varbyte    a thumbnail of the original image
  image   indirect   the full size image

  Given a list of images, it OCR&#39;s any text, creates a small thumbnail,
  and uploads the original image file to the server.

  NOTE:  This example uses two fictitious calls, ocrimage() and
  shrinkimage(), to OCR images and make thumbnails of them.  We do
  not provide any such calls.  Also, Texis does not know any image
  formats.  Any image or other binary format data may be stored in
  a Texis field or indirect.
*/
TSQL   *ts;
char   *text;
byte   *thumbnail;
size_t  nthumbnail;
char  **imagefiles;
int     i, nimages;

   ...
              /* setup the insert statement for loading new records */
   if(n_settsql(ts,&quot;insert into docs values (counter, %s, %p%n, %&lt;);&quot;))
   {
      for(i=0;i&lt;nimages;i++)               /* each image to process */
      {
         text=ocrimage(imagefile[i]);              /* OCR the image */
                                                /* make a thumbnail */
         thumbnail=shrinkimage(imagefiles[i],&amp;thumbnail);
                        /* execute the insert with the current data */
         if(!n_exectsql(ts,text,thumbnail,nthumbnail,imagefiles[i]))
            break;
      }
   }
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
  <span class="n">This</span> <span class="n">example</span> <span class="n">accesses</span> <span class="n">the</span> <span class="n">same</span> <span class="n">table</span> <span class="n">described</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">previous</span>
  <span class="n">example</span><span class="o">.</span>  <span class="n">Given</span> <span class="n">a</span> <span class="n">Metamorph</span> <span class="n">query</span><span class="p">,</span> <span class="n">it</span> <span class="n">will</span> <span class="n">retrieve</span> <span class="nb">all</span> <span class="n">rows</span>
  <span class="n">that</span> <span class="n">have</span> <span class="n">a</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">text</span> <span class="n">field</span><span class="o">.</span>
<span class="o">*/</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">query</span><span class="p">;</span>

   <span class="o">...</span>
                                    <span class="o">/*</span> <span class="n">setup</span> <span class="n">the</span> <span class="n">select</span> <span class="n">statement</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span>
      <span class="s2">&quot;select ctr,text,thumb,image from docs where text like </span><span class="si">%s</span><span class="s2">;&quot;</span><span class="p">))</span>
   <span class="p">{</span>
          <span class="o">/*</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">select</span> <span class="k">with</span> <span class="n">the</span> <span class="n">supplied</span> <span class="n">Metamorph</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_exectsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">query</span><span class="p">))</span>
      <span class="p">{</span>
         <span class="o">/*</span> <span class="n">the</span> <span class="n">n_gettsql</span><span class="p">()</span> <span class="n">man</span> <span class="n">page</span> <span class="n">describes</span> <span class="n">how</span> <span class="n">to</span> <span class="n">get</span> <span class="n">results</span> <span class="o">*/</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_opentsql</span><span class="p">(),</span> <span class="n">n_gettsql</span><span class="p">(),</span> <span class="n">n_dotsql</span><span class="p">()</span><span class="o">.</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;tstone.h&quot;</span>

<span class="nb">int</span> <span class="n">n_gettsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="nb">format</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="nb">format</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_gettsql()</span></code> retrieves resultant rows from execution of a SQL
statement. It takes a format string containing <code class="docutils literal notranslate"><span class="pre">scanf</span></code> like conversion
codes. There should not be any characters in the format string except
format codes and optional space separators.</p>
<p>By default, only <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statements will generate result rows. To get
result rows from <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> statements see
<code class="docutils literal notranslate"><span class="pre">n_resulttsql()</span></code>.</p>
<p>The following table summarizes the format codes and their respective
data types. See the <strong>formatting codes</strong> man page for full descriptions.</p>
<p>[tab:gfmtcodes]</p>
<div class="line-block">
<div class="line">|l|l|l|l|</div>
<div class="line">&amp; <em>Description</em> &amp; <em>C Type</em> &amp; <em>SQL Type</em></div>
<div class="line">%b &amp; Raw binary data &amp; byte ** &amp; BYTE</div>
<div class="line">%p%n &amp; Raw binary data &amp; byte ** &amp; BYTE</div>
<div class="line">%s &amp; Character string &amp; char ** &amp; CHAR</div>
<div class="line">%lf &amp; Double precision floating point &amp; double * &amp; DOUBLE</div>
<div class="line">%lu &amp; Unix date stored as time_t &amp; long * &amp; DATE</div>
<div class="line">%f &amp; Single precision floating point &amp; float * &amp; FLOAT</div>
<div class="line">%d &amp; 32/64-bit signed integer &amp; int * &amp; INTEGER</div>
<div class="line">%ld &amp; 32/64-bit signed integer &amp; long * &amp; LONG</div>
<div class="line">%hd &amp; 16-bit signed integer &amp; short * &amp; SMALLINT</div>
<div class="line">%w &amp; 16-bit unsigned integer &amp; word * &amp; UNSIGNED SMALLINT</div>
<div class="line">%s &amp; Name of external file &amp; char ** &amp; INDIRECT</div>
<div class="line">%<span class="math notranslate nohighlight">\(&gt;\)</span> &amp; Name of external file &amp; char ** &amp; INDIRECT</div>
<div class="line">%dw &amp; 32-bit unsigned integer &amp; dword * &amp; UNSIGNED INTEGER</div>
<div class="line">%64d &amp; 64-bit signed integer &amp; EPI_INT64 * &amp; INT64</div>
<div class="line">%64u &amp; 64-bit unsigned integer &amp; EPI_UINT64 * &amp; UINT64</div>
<div class="line">%c &amp; Unique serial number &amp; ft_counter **&amp; COUNTER</div>
<div class="line">%ls &amp; A list of allocated strings &amp; char *** &amp; STRLST</div>
<div class="line">%a &amp; All remaining fields as string &amp; char ** &amp; —</div>
<div class="line">%o &amp; Metamorph subhit offsets &amp; MMOFFS ** &amp; —</div>
</div>
<p>After the format string are the variables to place the retrieved data
into. You must provide the address of each variable, as in <code class="docutils literal notranslate"><span class="pre">scanf</span></code>, to
set. Each variable will be pointed to an allocated region that must be
released with <code class="docutils literal notranslate"><span class="pre">free()</span></code> when you are finished with it except for the
fundamental types <code class="docutils literal notranslate"><span class="pre">double,</span> <span class="pre">long,</span> <span class="pre">float,</span> <span class="pre">short,</span> <span class="pre">word,</span> <span class="pre">dword</span></code>. It is not
necessary to get all result rows if you don’t want them all. any
subsequent <code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code> will flush any ungotten rows.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_gettsql()</span></code> both returns 0 on “end of results” and non-0 otherwise.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
  <span class="n">This</span> <span class="n">example</span> <span class="n">accesses</span> <span class="n">the</span> <span class="n">same</span> <span class="n">table</span> <span class="n">described</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">n_settsql</span><span class="p">()</span>
  <span class="n">man</span> <span class="n">page</span><span class="o">.</span>  <span class="n">Given</span> <span class="n">a</span> <span class="n">Metamorph</span> <span class="n">query</span><span class="p">,</span> <span class="n">it</span> <span class="n">will</span> <span class="n">retrieve</span> <span class="nb">all</span> <span class="n">rows</span>
  <span class="n">that</span> <span class="n">have</span> <span class="n">a</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">text</span> <span class="n">field</span><span class="o">.</span>
<span class="o">*/</span>
<span class="n">TSQL</span>       <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>       <span class="o">*</span><span class="n">query</span><span class="p">;</span>
<span class="n">ft_counter</span> <span class="o">*</span><span class="n">ctr</span><span class="p">;</span>
<span class="n">char</span>       <span class="o">*</span><span class="n">text</span><span class="p">;</span>
<span class="n">byte</span>       <span class="o">*</span><span class="n">thumbnail</span><span class="p">;</span>
<span class="n">size_t</span>      <span class="n">nthumbnail</span><span class="p">;</span>
<span class="n">char</span>       <span class="o">*</span><span class="n">imagefile</span><span class="p">;</span>
<span class="n">MMOFFS</span>     <span class="o">*</span><span class="n">mmo</span><span class="p">;</span>

   <span class="o">...</span>
                                      <span class="o">/*</span> <span class="n">setup</span> <span class="n">the</span> <span class="n">select</span> <span class="n">statement</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span>
      <span class="s2">&quot;select ctr,text,thumb,image from docs where text like </span><span class="si">%s</span><span class="s2">;&quot;</span><span class="p">))</span>
   <span class="p">{</span>
            <span class="o">/*</span> <span class="n">execute</span> <span class="n">the</span> <span class="n">select</span> <span class="k">with</span> <span class="n">the</span> <span class="n">supplied</span> <span class="n">Metamorph</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_exectsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">query</span><span class="p">))</span>
      <span class="p">{</span>
                                          <span class="o">/*</span> <span class="n">get</span> <span class="nb">all</span> <span class="n">resultant</span> <span class="n">rows</span> <span class="o">*/</span>
         <span class="k">while</span><span class="p">(</span><span class="n">n_gettsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2"> </span><span class="si">%s%o</span><span class="s2"> %p%n </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="o">&amp;</span><span class="n">ctr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">text</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mmo</span><span class="p">,</span><span class="o">&amp;</span><span class="n">thumbnail</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nthumbnail</span><span class="p">,</span>
                         <span class="o">&amp;</span><span class="n">imagefile</span><span class="p">))</span>
         <span class="p">{</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="o">...</span>
            <span class="o">/*</span> <span class="n">do</span> <span class="n">something</span> <span class="k">with</span> <span class="n">the</span> <span class="n">fields</span> <span class="p">(</span><span class="n">like</span> <span class="n">display</span> <span class="n">them</span><span class="p">)</span> <span class="o">*/</span>
            <span class="o">...</span>
            <span class="n">free</span><span class="p">(</span><span class="n">ctr</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
            <span class="n">freemmoffs</span><span class="p">(</span><span class="n">mmo</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">thumbnail</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">imagefile</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settsql</span><span class="p">()</span> <span class="ow">and</span> <span class="n">n_resulttsql</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;tstone.h&quot;</span>

<span class="nb">int</span> <span class="n">n_dotsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">stmt</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">stmt</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_dotsql()</span></code> combines the functionality of <code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code> and
<code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code> into one call. It takes the statement format string as
in <code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code> followed by input variable pointers as in
<code class="docutils literal notranslate"><span class="pre">n_exectsql()</span></code>. Any resultant rows are discarded.</p>
<p>It returns the number of rows that were processed on success or <code class="docutils literal notranslate"><span class="pre">-1</span></code>
on error.</p>
<p>This function is useful for performing one shot statements that don’t
generate any output or you don’t care about the output. Like creating or
dropping a table or inserting a single record.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span>
  <span class="n">This</span> <span class="n">example</span> <span class="n">creates</span> <span class="n">a</span> <span class="n">table</span> <span class="n">called</span> <span class="n">docs</span> <span class="k">with</span> <span class="n">the</span> <span class="n">following</span> <span class="n">fields</span><span class="p">:</span>

  <span class="n">Name</span>    <span class="n">Type</span>       <span class="n">Description</span>
  <span class="o">----</span>    <span class="o">----</span>       <span class="o">-----------</span>
  <span class="nb">id</span>      <span class="n">counter</span>    <span class="n">a</span> <span class="n">handy</span> <span class="n">unique</span> <span class="n">key</span> <span class="n">field</span>
  <span class="n">text</span>    <span class="n">varchar</span>    <span class="n">the</span> <span class="n">text</span> <span class="n">ocr</span><span class="s1">&#39;d off the image</span>
  <span class="n">thumb</span>   <span class="n">varbyte</span>    <span class="n">a</span> <span class="n">thumbnail</span> <span class="n">of</span> <span class="n">the</span> <span class="n">original</span> <span class="n">image</span>
  <span class="n">image</span>   <span class="n">indirect</span>   <span class="n">the</span> <span class="n">full</span> <span class="n">size</span> <span class="n">image</span>

  <span class="n">Then</span> <span class="n">it</span> <span class="n">inserts</span> <span class="n">one</span> <span class="n">row</span> <span class="n">into</span> <span class="n">it</span><span class="o">.</span>
<span class="o">*/</span>
<span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">text</span><span class="p">;</span>
<span class="n">byte</span>   <span class="o">*</span><span class="n">thumbnail</span><span class="p">;</span>
<span class="n">size_t</span>  <span class="n">nthumbnail</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">imagefile</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">nrows</span><span class="p">;</span>

   <span class="o">...</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_dotsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="s2">&quot;create table docs(id counter,text varchar(1000),</span>
                      <span class="n">thumbnail</span> <span class="n">varbyte</span><span class="p">,</span><span class="n">imagefile</span> <span class="n">indirect</span><span class="p">);</span><span class="s2">&quot;)&gt;=0)</span>
   <span class="p">{</span>
      <span class="o">...</span>
      <span class="n">nrows</span><span class="o">=</span><span class="n">n_dotsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span>
                     <span class="s2">&quot;insert into docs values (counter, </span><span class="si">%s</span><span class="s2">, %p%n, %&lt;);&quot;</span><span class="p">,</span>
                     <span class="n">text</span><span class="p">,</span><span class="n">thumbnail</span><span class="p">,</span><span class="n">nthumbnail</span><span class="p">,</span><span class="n">imagefile</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settsql</span><span class="p">(),</span> <span class="n">n_exectsql</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;tstone.h&quot;</span>

<span class="nb">int</span> <span class="n">n_resulttsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">flag</span><span class="p">)</span>
<span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">flag</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_resulttsql()</span></code> controls the reporting of resultant rows from SQL
<code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> statements. By default <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and
<code class="docutils literal notranslate"><span class="pre">DELETE</span></code> will not report back the affected rows. Calling this function
with <code class="docutils literal notranslate"><span class="pre">flag</span></code> set to <code class="docutils literal notranslate"><span class="pre">1</span></code> will enable the reporting of affected rows.
You then must use <code class="docutils literal notranslate"><span class="pre">n_gettsql()</span></code> to retrieve rows as with
<code class="docutils literal notranslate"><span class="pre">SELECT</span></code>s. <code class="docutils literal notranslate"><span class="pre">n_resulttsql()</span></code> must be called before <code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code>.</p>
<p>Pass <code class="docutils literal notranslate"><span class="pre">flag</span></code> as <code class="docutils literal notranslate"><span class="pre">0</span></code> to disable report of the affected rows.</p>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> statements always return matching rows, regardless of this
setting. <code class="docutils literal notranslate"><span class="pre">n_dotsql()</span></code> is unaffected by this call. Results are always
suppressed.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_resulttsql()</span></code> returns the previous <code class="docutils literal notranslate"><span class="pre">flag</span></code> setting. There is no
error return.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TSQL</span>   <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
<span class="n">long</span>    <span class="n">when</span><span class="p">;</span>
<span class="n">long</span>    <span class="n">date</span><span class="p">;</span>
<span class="n">char</span>   <span class="o">*</span><span class="n">query</span><span class="p">;</span>

   <span class="o">...</span>
                                 <span class="o">/*</span> <span class="n">delete</span> <span class="n">rows</span> <span class="n">without</span> <span class="n">seeing</span> <span class="n">them</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="s2">&quot;delete from history where Date&lt;</span><span class="si">%lu</span><span class="s2">;&quot;</span><span class="p">))</span>
   <span class="p">{</span>
      <span class="n">when</span><span class="o">=</span><span class="n">time</span><span class="p">((</span><span class="n">time_t</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">);</span>                <span class="o">/*</span> <span class="n">get</span> <span class="n">current</span> <span class="n">time</span> <span class="o">*/</span>
      <span class="n">when</span><span class="o">-=</span><span class="mi">7</span><span class="o">*</span><span class="mi">86400</span><span class="p">;</span>                             <span class="o">/*</span> <span class="n">subtract</span> <span class="mi">7</span> <span class="n">days</span> <span class="o">*/</span>
      <span class="n">n_exectsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">when</span><span class="p">);</span>                      <span class="o">/*</span> <span class="n">perform</span> <span class="n">deletion</span> <span class="o">*/</span>
   <span class="p">}</span>
   <span class="o">...</span>
                                        <span class="o">/*</span> <span class="n">delete</span> <span class="n">rows</span> <span class="ow">and</span> <span class="n">see</span> <span class="n">them</span> <span class="o">*/</span>
   <span class="n">n_resulttsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="s2">&quot;delete from history where Date&lt;</span><span class="si">%lu</span><span class="s2">;&quot;</span><span class="p">))</span>
   <span class="p">{</span>
      <span class="n">when</span><span class="o">=</span><span class="n">time</span><span class="p">((</span><span class="n">time_t</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">);</span>                <span class="o">/*</span> <span class="n">get</span> <span class="n">current</span> <span class="n">time</span> <span class="o">*/</span>
      <span class="n">when</span><span class="o">-=</span><span class="mi">7</span><span class="o">*</span><span class="mi">86400</span><span class="p">;</span>                             <span class="o">/*</span> <span class="n">subtract</span> <span class="mi">7</span> <span class="n">days</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_exectsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">when</span><span class="p">))</span>                   <span class="o">/*</span> <span class="n">perform</span> <span class="n">deletion</span> <span class="o">*/</span>
      <span class="p">{</span>
         <span class="k">while</span><span class="p">(</span><span class="n">n_gettsql</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%lu</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">date</span><span class="p">,</span><span class="o">&amp;</span><span class="n">query</span><span class="p">);</span>
         <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%lu</span><span class="s2"> </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">query</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">query</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settsql</span><span class="p">()</span>
</pre></div>
</div>
<p>The formatting codes placed in the <code class="docutils literal notranslate"><span class="pre">n_settsql()</span> <span class="pre">stmt</span></code> variable and the
<code class="docutils literal notranslate"><span class="pre">n_gettsql()</span> <span class="pre">format</span></code> variable deal with the same kinds of data. Each
code’s usage for both input and output will be discussed together. The
basic difference between input and output modes is as follows.</p>
<p>Output is from <code class="docutils literal notranslate"><span class="pre">n_gettsql()</span></code> to your variables. All output variables
are specified by address (like <code class="docutils literal notranslate"><span class="pre">scanf()</span></code>) so that they may be
re-pointed to the allocated data retrieved from the server. You must
<code class="docutils literal notranslate"><span class="pre">free()</span></code> the output variables when you are finished with the data or
your program will grow ever larger with each resultant row until the the
bounds of time and space are reached and the universe begins to tear at
the seams and finally explodes in a spectacularly fiery ball just
because you didn’t bother to free a few variables.</p>
<p>Input is from your variables to <code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code>. Input variables are
specified directly (like <code class="docutils literal notranslate"><span class="pre">printf()</span></code>) rather than by address. They are
not modified or freed by <code class="docutils literal notranslate"><span class="pre">n_settsql()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">b</span>
</pre></div>
</div>
<p>Communicates SQL byte fields via C byte variables. Provide <code class="docutils literal notranslate"><span class="pre">byte</span> <span class="pre">**</span></code>
for output and <code class="docutils literal notranslate"><span class="pre">byte</span> <span class="pre">*</span></code> for input. Typically used for raw binary data.
It assumes one byte on input since the length of your data can not be
determined. On output it gets as much data as is in the field. It is up
to you to know the length of it somehow. See <code class="docutils literal notranslate"><span class="pre">%p%n</span></code> for more robust
buffer handling.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">p</span><span class="o">%</span><span class="n">n</span>
</pre></div>
</div>
<p>Communicates any SQL field type via C byte variables. Provide
<code class="docutils literal notranslate"><span class="pre">byte</span> <span class="pre">**</span></code> and <code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">byte</span> <span class="pre">*</span></code> and <code class="docutils literal notranslate"><span class="pre">size_t</span></code>
for input. Typically used for raw binary data. Both <code class="docutils literal notranslate"><span class="pre">%p</span></code> and <code class="docutils literal notranslate"><span class="pre">%n</span></code>
must be provided and in that order. Therefore you must supply two
variables. The first is a <code class="docutils literal notranslate"><span class="pre">byte</span></code> pointer to the data buffer and the
second is a <code class="docutils literal notranslate"><span class="pre">size_t</span></code> that is the number of bytes in the buffer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">s</span>
</pre></div>
</div>
<p>Communicates SQL char and indirect fields via C char variables. Provide
<code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**</span></code> for output and <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*</span></code> for input. The data is a standard
<code class="docutils literal notranslate"><span class="pre">'\0'</span></code> terminated string. Accessing an indirect this way transfers the
name of the indirect file. See <code class="docutils literal notranslate"><span class="pre">%&lt;</span></code> and <code class="docutils literal notranslate"><span class="pre">%&gt;</span></code> to transfer indirect
file contents.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">lf</span>
</pre></div>
</div>
<p>Communicates SQL double fields via C double variables. Provide
<code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">double</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">lu</span>
</pre></div>
</div>
<p>Communicates SQL date fields via C long variables. Provide <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">*</span></code>
for output and <code class="docutils literal notranslate"><span class="pre">long</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">f</span>
</pre></div>
</div>
<p>Communicates SQL float fields via C float variables. Provide <code class="docutils literal notranslate"><span class="pre">float</span> <span class="pre">*</span></code>
for output and <code class="docutils literal notranslate"><span class="pre">float</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">d</span> <span class="ow">or</span> <span class="o">%</span><span class="n">ld</span>
</pre></div>
</div>
<p>Communicates SQL integer fields via C long variables. Provide <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">*</span></code>
for output and <code class="docutils literal notranslate"><span class="pre">long</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">hd</span>
</pre></div>
</div>
<p>Communicates SQL smallint fields via C short variables. Provide
<code class="docutils literal notranslate"><span class="pre">short</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">short</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">w</span>
</pre></div>
</div>
<p>Communicates SQL unsigned smallint fields via C word (16 bit) variables.
Provide <code class="docutils literal notranslate"><span class="pre">word</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">word</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">dw</span>
</pre></div>
</div>
<p>Communicates SQL unsigned integer fields via C dword (32 bit) variables.
Provide <code class="docutils literal notranslate"><span class="pre">dword</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">dword</span></code> for input.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="mi">64</span><span class="n">d</span>
</pre></div>
</div>
<p>Communicates SQL int64 fields via C EPI_INT64 (64 bit signed)
variables. Provide <code class="docutils literal notranslate"><span class="pre">EPI_INT64</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">EPI_INT64</span></code> for
input. INT64 support was added in Texis version 6.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="mi">64</span><span class="n">u</span>
</pre></div>
</div>
<p>Communicates SQL uint64 fields via C EPI_UINT64 (64 bit unsigned)
variables. Provide <code class="docutils literal notranslate"><span class="pre">EPI_UINT64</span> <span class="pre">*</span></code> for output and <code class="docutils literal notranslate"><span class="pre">EPI_UINT64</span></code> for
input. UINT64 support was added in Texis version 6.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%&lt;</span>
</pre></div>
</div>
<p>Communicates SQL indirect fields via C char variables and disk files.
This is for input only. Provide a <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*</span></code> variable that points to the
name of a file. The file will be uploaded to the server and be stored as
a Texis managed indirect.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%&gt;</span>
</pre></div>
</div>
<p>Communicates SQL indirect fields via C char variables and disk files.
This is for output only. Provide a <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**</span></code> variable. The contents of
this variable will be examined before retrieving the contents of the
indirect file from the server.</p>
<p>In all of the following cases your supplied filename will be replaced
with a generated and allocated filename that is where the contents of
the indirect file from the server were downloaded to on the local
machine. The third case is an exception to the allocated value rule.</p>
<p>If the variable points to <code class="docutils literal notranslate"><span class="pre">(char</span> <span class="pre">*)NULL</span></code> a temporary filename will be
generated with the standard C library call <code class="docutils literal notranslate"><span class="pre">tempnam()</span></code>.</p>
<p>If the variable points to the name of an existing directory on the local
machine the resulting filename will be that directory with the name of
the file on the server appended to it. (i.e. The file will wind up in
the specified directory).</p>
<p>Otherwise the variable is taken to be the exact name of the file to
place the file from the server in. Anything previously in the specified
file will be lost. In this case the resultant filename will be
untouched.</p>
<p>The contents of your variable will <em>not</em> be freed, just overwritten. If
it needs to be freed, you will have to keep another copy of it to free
after the transfer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">c</span>
</pre></div>
</div>
<p>Communicates SQL counter fields via C ft_counter variables. Provide a
<code class="docutils literal notranslate"><span class="pre">ft_counter</span> <span class="pre">**</span></code> for output and a <code class="docutils literal notranslate"><span class="pre">ft_counter</span> <span class="pre">*</span></code> for input.
<code class="docutils literal notranslate"><span class="pre">ft_counter</span></code> is a structure that contains two members called <code class="docutils literal notranslate"><span class="pre">date</span></code>
and <code class="docutils literal notranslate"><span class="pre">seq</span></code>. <code class="docutils literal notranslate"><span class="pre">date</span></code> is a <code class="docutils literal notranslate"><span class="pre">long</span></code> that contains the date in seconds
(see std. C <code class="docutils literal notranslate"><span class="pre">time()</span></code>) that the counter was created. <code class="docutils literal notranslate"><span class="pre">seq</span></code> is a
<code class="docutils literal notranslate"><span class="pre">ulong</span></code> that contains the sequence number for the particular second
described by <code class="docutils literal notranslate"><span class="pre">date</span></code>. The combination of these values provides a unique
id across every record in every table in a given database.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">ls</span>
</pre></div>
</div>
<p>Communicates SQL strlst fields via C char variables. Provide a
<code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">***</span></code> for output and a <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**</span></code> for input. The string list is
an allocated array of pointers to allocated strings. The list is
terminated with an allocated empty string (<code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">aD</span>
</pre></div>
</div>
<p>Communicates all remaining resultant fields via a C char variable. This
is for output only. Provide a <code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**</span></code>. All fields that have not
already been extracted will be packed together into a C string with the
character <code class="docutils literal notranslate"><span class="pre">D</span></code> between each field. Where <code class="docutils literal notranslate"><span class="pre">D</span></code> is any single character
except <code class="docutils literal notranslate"><span class="pre">\000</span></code>. Non-printable characters may be specified with octal
(<code class="docutils literal notranslate"><span class="pre">\ooo</span></code>) or hex (<code class="docutils literal notranslate"><span class="pre">\xhh</span></code>) notation (e.g.: tab would be <code class="docutils literal notranslate"><span class="pre">\011</span></code> in
octal and <code class="docutils literal notranslate"><span class="pre">\x09</span></code> in hex). Binary data that can be converted to human
readable form will be (e.g.: INTEGER FLOAT COUNTER). Everything after
the <code class="docutils literal notranslate"><span class="pre">%aD</span></code> code will be ignored since all the fields are now converted.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">o</span>
</pre></div>
</div>
<p>Communicates Metamorph hit offset information for the preceding field.
This is for output only. Provide a <code class="docutils literal notranslate"><span class="pre">MMOFFS</span> <span class="pre">**</span></code>. <code class="docutils literal notranslate"><span class="pre">MMOFFS</span></code> is the
following structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MMOFFS</span>             <span class="o">/*</span> <span class="n">Metamorph</span> <span class="n">hit</span> <span class="n">offsets</span>          <span class="o">*/</span>
<span class="p">{</span>
   <span class="nb">int</span> <span class="n">n</span><span class="p">;</span>          <span class="o">/*</span> <span class="n">number</span> <span class="k">if</span> <span class="n">off</span><span class="s1">&#39;s in array       */</span>
   <span class="n">MMOFFSE</span>
   <span class="p">{</span>
      <span class="n">long</span> <span class="n">start</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">byte</span> <span class="n">offset</span> <span class="n">of</span> <span class="n">start</span> <span class="n">of</span> <span class="n">region</span> <span class="o">*/</span>
      <span class="n">long</span> <span class="n">end</span><span class="p">;</span>    <span class="o">/*</span> <span class="n">one</span> <span class="n">past</span> <span class="n">end</span> <span class="n">of</span> <span class="n">region</span>         <span class="o">*/</span>
   <span class="p">}</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>         <span class="o">/*</span> <span class="n">array</span> <span class="n">of</span> <span class="n">subhit</span> <span class="n">offset</span> <span class="n">info</span>    <span class="o">*/</span>
   <span class="nb">int</span> <span class="n">nhits</span><span class="p">;</span>      <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">hit</span><span class="s1">&#39;s in in array    */</span>
   <span class="n">MMOFFSE</span> <span class="o">*</span><span class="n">hit</span><span class="p">;</span>   <span class="o">/*</span> <span class="n">array</span> <span class="n">of</span> <span class="n">hit</span> <span class="n">offset</span> <span class="n">info</span>       <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">MMOFFS-&gt;off</span></code> is an array of start and end offsets of subhits
(individual search terms) within the field. <code class="docutils literal notranslate"><span class="pre">MMOFFS-&gt;n</span></code> is the number
of entries in the off array. Each <code class="docutils literal notranslate"><span class="pre">off</span></code> is made of two members:
<code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">end</span></code>. Start is the byte offset of the subhit
within the field. End is the byte offset of the end of the subhit within
the field plus one (plus one makes <code class="docutils literal notranslate"><span class="pre">for()</span></code> loops easier to write). The
offs array contains subhits from all Metamorphs that may have been
applied to the field. Offsets are sorted in ascending order by start
offset.</p>
<p>Overall hit and delimiter offsets are contained in <code class="docutils literal notranslate"><span class="pre">MMOFFS-&gt;hit</span></code> in a
manner analogous to subhit info. <code class="docutils literal notranslate"><span class="pre">MMOFFS-&gt;nhits</span></code> is the number of
entries in the hit array and will always be a multiple of three. For
each Metamorph on a field there will be three entries. The first
contains the offsets of the overall hit (sentence, paragraph, etc…).
The second contains the offsets of the start delimiter. The third
contains the offsets of the end delimiter.</p>
<p><code class="docutils literal notranslate"><span class="pre">MMOFFS</span></code> must be freed with <code class="docutils literal notranslate"><span class="pre">freemmoffs(MMOFFS</span> <span class="pre">*)</span></code> instead of the
normal <code class="docutils literal notranslate"><span class="pre">free(void</span> <span class="pre">*)</span></code>. <code class="docutils literal notranslate"><span class="pre">freemmoffs(MMOFFS</span> <span class="pre">*)</span></code> can handle MMOFFSPN.
This will be <code class="docutils literal notranslate"><span class="pre">MMOFFSPN</span></code> <a class="footnote-reference brackets" href="#id18" id="id3">3</a> if there is no Metamorph data for the
field. This can happen for a number of reasons. If the search could be
completed in the index without needing to read the record, then there
will be no hit information. Also if you have ordered the output the hit
information can become invalid in the ordering, and the pointer will be
<code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settsql</span><span class="p">()</span> <span class="ow">and</span> <span class="n">n_gettsql</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="texis-specific-functions">
<h2>Texis specific functions<a class="headerlink" href="#texis-specific-functions" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;tstone.h&quot;</span>
<span class="n">FLDLST</span>
<span class="p">{</span>
 <span class="nb">int</span>    <span class="n">n</span><span class="p">;</span>            <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">each</span> <span class="n">of</span> <span class="n">following</span> <span class="n">lists</span> <span class="o">*/</span>
 <span class="nb">int</span>   <span class="o">*</span><span class="nb">type</span><span class="p">;</span>                           <span class="o">/*</span> <span class="n">types</span> <span class="n">of</span> <span class="n">field</span> <span class="p">(</span><span class="n">FTN_xxx</span><span class="p">)</span> <span class="o">*/</span>
 <span class="n">void</span> <span class="o">**</span><span class="n">data</span><span class="p">;</span>                                 <span class="o">/*</span> <span class="n">data</span> <span class="n">array</span> <span class="n">pointer</span> <span class="o">*/</span>
 <span class="nb">int</span>   <span class="o">*</span><span class="n">ndata</span><span class="p">;</span>                  <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">data</span> <span class="n">array</span> <span class="o">*/</span>
 <span class="n">char</span> <span class="o">**</span><span class="n">name</span><span class="p">;</span>                                      <span class="o">/*</span> <span class="n">name</span> <span class="n">of</span> <span class="n">field</span> <span class="o">*/</span>
<span class="p">};</span>
<span class="nb">int</span> <span class="n">n_regtexiscb</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">,</span>
                 <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">,</span><span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
<p>This function assigns the callback routine that the server is to call
each time it locates an item that matches the user’s query. The client
program can pass along a pointer to a “user” object to the register
function that will be in turn passed to the callback routine on each
invocation.</p>
<p>The callback routine also gets a <code class="docutils literal notranslate"><span class="pre">TEXIS</span></code> handle that can be used to
get further information about the hit (see <code class="docutils literal notranslate"><span class="pre">n_getsrchlst()</span></code>) and a
<code class="docutils literal notranslate"><span class="pre">FLDLST</span></code> handle that contains the <code class="docutils literal notranslate"><span class="pre">select</span></code>ed fields.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">FLDLST</span></code> is a structure containing parallel arrays of information
about the selected fields and a count of those fields. <code class="docutils literal notranslate"><span class="pre">FLDLST</span></code>
members:</p>
<p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">n</span></code> — The number of fields in the following lists.</p>
<p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">*type</span></code> — An array of types of the fields. Each element will be
one of the <code class="docutils literal notranslate"><span class="pre">FTN_xxxx</span></code> macros.</p>
<p><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">**data</span></code> — An array of data pointers. Each element will point to
the data for the field. The data for a field is an array of <code class="docutils literal notranslate"><span class="pre">type</span></code>s.</p>
<p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">*ndata</span></code> — An array of data counts. Each element says how many
elements are in the <code class="docutils literal notranslate"><span class="pre">data</span></code> array for this field.</p>
<p><code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">**name</span></code> — An array of strings containing the names of the
fields.</p>
<p><code class="docutils literal notranslate"><span class="pre">SRCHLST</span> <span class="pre">*sl</span></code> — An array of SRCHLSTs containing information Metamorph
searches, if any. Filled in, on request only, by <code class="docutils literal notranslate"><span class="pre">n_fillsrchlst()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">MMOFFS</span> <span class="pre">mmoff</span></code> — An array of Metamorph subhit offsets and lengths from
Metamorph searches, if any. Filled in, on request only, by
<code class="docutils literal notranslate"><span class="pre">n_fillsrchlst()</span></code>.</p>
<p>Possible types in <code class="docutils literal notranslate"><span class="pre">FLDLST-&gt;type</span></code> array:</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_BYTE</span></code> — An 8 bit <code class="docutils literal notranslate"><span class="pre">byte</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_CHAR</span></code> — A <code class="docutils literal notranslate"><span class="pre">char</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_DOUBLE</span></code> — A <code class="docutils literal notranslate"><span class="pre">double</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_DATE</span></code> — A <code class="docutils literal notranslate"><span class="pre">long</span></code> in the same form as that from the <code class="docutils literal notranslate"><span class="pre">time()</span></code>
system call.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_DWORD</span></code> — A 32 bit <code class="docutils literal notranslate"><span class="pre">dword</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_FLOAT</span></code> — A <code class="docutils literal notranslate"><span class="pre">float</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_INT</span></code> — An <code class="docutils literal notranslate"><span class="pre">int</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_INTEGER</span></code> — An <code class="docutils literal notranslate"><span class="pre">int</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_LONG</span></code> — A <code class="docutils literal notranslate"><span class="pre">long</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_INT64</span></code> — An <code class="docutils literal notranslate"><span class="pre">int64</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_UINT64</span></code> — A <code class="docutils literal notranslate"><span class="pre">uint64</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_SHORT</span></code> — A <code class="docutils literal notranslate"><span class="pre">short</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_SMALLINT</span></code> — A <code class="docutils literal notranslate"><span class="pre">short</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_WORD</span></code> — A 16 bit <code class="docutils literal notranslate"><span class="pre">word</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_INDIRECT</span></code> — A <code class="docutils literal notranslate"><span class="pre">char</span></code> string URL indicating the file that the
data for this field is stored in.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_COUNTER</span></code> — A <code class="docutils literal notranslate"><span class="pre">ft_counter</span></code> structure containing a unique serial
number.</p>
<p><code class="docutils literal notranslate"><span class="pre">FTN_STRLST</span></code> — A delimited list of strings.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">type</span></code> may also be <code class="docutils literal notranslate"><span class="pre">|</span></code>ed with <code class="docutils literal notranslate"><span class="pre">FTN_NotNullableFlag</span></code>
(formerly <code class="docutils literal notranslate"><span class="pre">DDNULLBIT</span></code>) and/or <code class="docutils literal notranslate"><span class="pre">DDVARBIT</span></code>. If <code class="docutils literal notranslate"><span class="pre">FTN_NotNullableFlag</span></code>
is set, it indicates that the field is not allowed to be NULL.
<code class="docutils literal notranslate"><span class="pre">DDVARBIT</span></code> indicated that the field is variable length instead of
fixed length. When handling result rows these bits can generally be
ignored.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_regtexiscb()</span></code> will return true if the registration was successful,
and will return false (0) on error.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;tstone.h&quot;</span>

<span class="c1">#define USERDATA my_data_structure</span>
<span class="n">USERDATA</span>
<span class="p">{</span>
 <span class="n">FILE</span>   <span class="o">*</span><span class="n">outfile</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">where</span> <span class="n">I</span> <span class="n">will</span> <span class="n">log</span> <span class="n">the</span> <span class="n">hits</span> <span class="o">*/</span>
 <span class="n">long</span>   <span class="n">hitcount</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">just</span> <span class="k">for</span> <span class="n">fun</span> <span class="o">*/</span>
<span class="p">};</span>

<span class="n">void</span>
<span class="n">dispnames</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span>                         <span class="o">/*</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">field</span> <span class="n">names</span> <span class="o">*/</span>
<span class="n">USERDATA</span> <span class="o">*</span><span class="n">ud</span><span class="p">;</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>
<span class="p">{</span>
 <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>

 <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>                                <span class="o">/*</span> <span class="n">every</span> <span class="n">field</span> <span class="o">*/</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &quot;</span><span class="p">,</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
 <span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">);</span>                                  <span class="o">/*</span> <span class="n">end</span> <span class="n">header</span> <span class="n">line</span> <span class="o">*/</span>
<span class="p">}</span>

<span class="n">void</span>
<span class="n">dispfields</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span>                 <span class="o">/*</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">fields</span> <span class="n">of</span> <span class="nb">any</span> <span class="nb">type</span> <span class="o">*/</span>
<span class="n">USERDATA</span> <span class="o">*</span><span class="n">ud</span><span class="p">;</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>
<span class="p">{</span>
 <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

 <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="nb">int</span>   <span class="nb">type</span><span class="o">=</span><span class="n">fl</span><span class="o">-&gt;</span><span class="nb">type</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                   <span class="o">/*</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">field</span> <span class="o">*/</span>
     <span class="n">void</span> <span class="o">*</span><span class="n">p</span>   <span class="o">=</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                 <span class="o">/*</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="o">*/</span>
     <span class="nb">int</span>   <span class="n">n</span>   <span class="o">=</span><span class="n">fl</span><span class="o">-&gt;</span><span class="n">ndata</span><span class="p">;</span>                     <span class="o">/*</span> <span class="n">how</span> <span class="n">many</span> <span class="n">elements</span> <span class="o">*/</span>
     <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="n">putchar</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">);</span>  <span class="o">/*</span> <span class="n">tab</span> <span class="n">between</span> <span class="n">fields</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">leading</span> <span class="o">*/</span>
     <span class="n">switch</span> <span class="p">(</span><span class="nb">type</span> <span class="o">&amp;</span> <span class="n">DDTYPEBITS</span><span class="p">)</span> <span class="o">/*</span> <span class="n">ignore</span> <span class="n">NULL</span> <span class="ow">and</span> <span class="n">VAR</span> <span class="n">bits</span> <span class="o">*/</span>
        <span class="p">{</span>
                        <span class="o">/*</span> <span class="n">loop</span> <span class="n">through</span> <span class="n">each</span> <span class="n">element</span> <span class="n">of</span> <span class="n">field</span> <span class="n">via</span> <span class="n">j</span> <span class="o">*/</span>
                                <span class="o">/*</span> <span class="n">cast</span> <span class="ow">and</span> <span class="nb">print</span> <span class="n">according</span> <span class="n">to</span> <span class="nb">type</span> <span class="o">*/</span>
         <span class="n">case</span> <span class="n">FTN_BYTE</span>    <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;0x</span><span class="si">%x</span><span class="s2"> &quot;</span><span class="p">,((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_INDIRECT</span><span class="p">:</span> <span class="o">/*</span><span class="n">nobreak</span><span class="p">;</span><span class="o">*/</span>
                            <span class="o">/*</span> <span class="n">just</span> <span class="nb">print</span> <span class="n">the</span> <span class="n">filename</span> <span class="k">as</span> <span class="n">a</span> <span class="n">string</span> <span class="o">*/</span>
         <span class="n">case</span> <span class="n">FTN_CHAR</span>    <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%c</span><span class="s2">&quot;</span>  <span class="p">,((</span><span class="n">char</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_DOUBLE</span>  <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%lf</span><span class="s2"> &quot;</span><span class="p">,((</span><span class="n">double</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_DWORD</span>   <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%lu</span><span class="s2"> &quot;</span><span class="p">,</span>
                                    <span class="p">(</span><span class="n">unsigned</span> <span class="n">long</span><span class="p">)((</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_FLOAT</span>   <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2"> &quot;</span> <span class="p">,((</span><span class="nb">float</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_INT</span>     <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="p">,((</span><span class="nb">int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_INTEGER</span> <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="p">,((</span><span class="nb">int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_LONG</span>    <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%ld</span><span class="s2"> &quot;</span><span class="p">,((</span><span class="n">long</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_SHORT</span>   <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="p">,((</span><span class="n">short</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_SMALLINT</span><span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="p">,((</span><span class="n">short</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_WORD</span>    <span class="p">:</span> <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                             <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%u</span><span class="s2"> &quot;</span> <span class="p">,</span>
                                    <span class="p">(</span><span class="n">unsigned</span> <span class="nb">int</span><span class="p">)((</span><span class="n">word</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)[</span><span class="n">j</span><span class="p">]);</span>
                            <span class="k">break</span><span class="p">;</span>
          <span class="o">/*</span> <span class="n">assume</span> <span class="n">exactly</span> <span class="n">one</span> <span class="n">element</span> <span class="n">on</span> <span class="n">FTN_DATE</span> <span class="k">for</span> <span class="n">this</span> <span class="n">example</span> <span class="o">*/</span>
         <span class="n">case</span> <span class="n">FTN_DATE</span>    <span class="p">:</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.25s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">ctime</span><span class="p">(</span><span class="n">p</span><span class="p">));</span><span class="o">/*</span> <span class="n">human</span> <span class="nb">format</span> <span class="o">*/</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_COUNTER</span> <span class="p">:</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%08lx%08lx</span><span class="s2">&quot;</span><span class="p">,((</span><span class="n">ft_counter</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">date</span><span class="p">,</span>
                                                <span class="p">((</span><span class="n">ft_counter</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">case</span> <span class="n">FTN_STRLST</span>  <span class="p">:</span> <span class="p">{</span>
                             <span class="n">size_t</span> <span class="n">nb</span><span class="o">=</span><span class="p">((</span><span class="n">ft_strlst</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nb</span><span class="p">;</span>
                             <span class="n">char</span> <span class="n">delim</span><span class="o">=</span><span class="p">((</span><span class="n">ft_strlst</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">delim</span><span class="p">;</span>
                             <span class="n">char</span> <span class="o">*</span><span class="n">b</span><span class="o">=</span><span class="p">((</span><span class="n">ft_strlst</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
                                <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="n">nb</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
                                <span class="p">{</span>
                                   <span class="k">if</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;</span><span class="se">\0</span><span class="s1">&#39;</span><span class="p">)</span> <span class="n">putchar</span><span class="p">(</span><span class="n">delim</span><span class="p">);</span>
                                   <span class="k">else</span>           <span class="n">putchar</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                            <span class="k">break</span><span class="p">;</span>
         <span class="n">default</span>          <span class="p">:</span> <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;unknowntype(</span><span class="si">%d</span><span class="s2">)&quot;</span><span class="p">,</span><span class="nb">type</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">int</span>
<span class="n">hit_handler</span><span class="p">(</span><span class="n">usr</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span>
<span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">my</span> <span class="n">user</span><span class="o">-</span><span class="n">data</span> <span class="n">pointer</span> <span class="o">*/</span>
<span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">Texis</span> <span class="n">API</span> <span class="n">handle</span> <span class="o">*/</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span> <span class="o">/*</span> <span class="n">The</span> <span class="n">field</span> <span class="nb">list</span> <span class="n">data</span> <span class="n">structure</span> <span class="o">*/</span>
<span class="p">{</span>
 <span class="n">USERDATA</span> <span class="o">*</span><span class="n">ud</span><span class="o">=</span><span class="p">(</span><span class="n">USERDATA</span> <span class="o">*</span><span class="p">)</span><span class="n">usr</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">cast</span> <span class="n">the</span> <span class="n">void</span> <span class="n">into</span> <span class="n">the</span> <span class="n">real</span> <span class="nb">type</span> <span class="o">*/</span>

 <span class="o">++</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">hitcount</span><span class="p">;</span>                      <span class="o">/*</span> <span class="n">add</span> <span class="n">one</span> <span class="n">to</span> <span class="n">the</span> <span class="n">hit</span> <span class="n">counter</span> <span class="o">*/</span>

 <span class="k">if</span><span class="p">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">hitcount</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>                        <span class="o">/*</span> <span class="n">before</span> <span class="n">the</span> <span class="n">first</span> <span class="n">hit</span> <span class="o">*/</span>
    <span class="n">dispnames</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">fl</span><span class="p">);</span>             <span class="o">/*</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">field</span> <span class="n">names</span> <span class="o">*/</span>
 <span class="n">dispfields</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">fl</span><span class="p">);</span>                    <span class="o">/*</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fields</span> <span class="o">*/</span>

 <span class="k">if</span><span class="p">(</span><span class="n">ud</span><span class="o">-&gt;</span><span class="n">hitcount</span><span class="o">&gt;=</span><span class="mi">100</span><span class="p">)</span><span class="o">/*</span> <span class="n">tell</span> <span class="n">the</span> <span class="n">server</span> <span class="n">to</span> <span class="n">stop</span> <span class="k">if</span> <span class="n">I</span><span class="s1">&#39;ve seen enough */</span>
    <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
 <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>          <span class="o">/*</span> <span class="n">tell</span> <span class="n">the</span> <span class="n">server</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">giving</span> <span class="n">me</span> <span class="n">more</span> <span class="n">hits</span> <span class="o">*/</span>
<span class="p">}</span>

<span class="nb">int</span>
<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
 <span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
 <span class="n">USERDATA</span> <span class="n">mydata</span><span class="p">;</span>
 <span class="o">...</span>
 <span class="n">mydata</span><span class="o">.</span><span class="n">outfile</span><span class="o">=</span><span class="p">(</span><span class="n">FILE</span> <span class="o">*</span><span class="p">)</span><span class="n">NULL</span><span class="p">;</span>
 <span class="n">mydata</span><span class="o">.</span><span class="n">hitcount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
 <span class="n">n_regtexiscb</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mydata</span><span class="p">,</span><span class="n">hit_handler</span><span class="p">);</span>
 <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example program <code class="docutils literal notranslate"><span class="pre">netex3.c</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;tstone.h&quot;</span>
<span class="n">SRCHLST</span>
<span class="p">{</span>
 <span class="nb">int</span> <span class="n">n</span><span class="p">;</span>                                <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">lst</span> <span class="o">*/</span>
 <span class="n">SRCH</span> <span class="n">lst</span><span class="p">[];</span>                          <span class="o">/*</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">Metamorph</span> <span class="n">searches</span> <span class="o">*/</span>
<span class="p">};</span>
<span class="n">MMOFFS</span>                                  <span class="o">/*</span> <span class="n">Metamorph</span> <span class="n">subhit</span> <span class="n">offsets</span> <span class="o">*/</span>
<span class="p">{</span>
   <span class="nb">int</span> <span class="n">n</span><span class="p">;</span>                               <span class="o">/*</span> <span class="n">number</span> <span class="k">if</span> <span class="n">off</span><span class="s1">&#39;s in array */</span>
   <span class="n">MMOFFSE</span>
   <span class="p">{</span>
      <span class="n">long</span> <span class="n">start</span><span class="p">;</span>                 <span class="o">/*</span> <span class="n">byte</span> <span class="n">offset</span> <span class="n">of</span> <span class="n">start</span> <span class="n">of</span> <span class="n">region</span> <span class="o">*/</span>
      <span class="n">long</span> <span class="n">end</span><span class="p">;</span>                           <span class="o">/*</span> <span class="n">one</span> <span class="n">past</span> <span class="n">end</span> <span class="n">of</span> <span class="n">region</span> <span class="o">*/</span>
   <span class="p">}</span> <span class="o">*</span><span class="n">off</span><span class="p">;</span>                                  <span class="o">/*</span> <span class="n">array</span> <span class="n">of</span> <span class="n">offset</span> <span class="n">info</span> <span class="o">*/</span>
<span class="p">};</span>
<span class="n">SRCHLST</span> <span class="o">*</span><span class="n">n_getsrchlst</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">SRCHLST</span> <span class="o">*</span><span class="n">n_freesrchlst</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCHLST</span> <span class="o">*</span><span class="n">sl</span><span class="p">);</span>
<span class="nb">int</span>      <span class="n">n_fillsrchlst</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">);</span>

<span class="n">SRCHI</span>
<span class="p">{</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">what</span><span class="p">;</span>                               <span class="o">/*</span> <span class="n">what</span> <span class="n">was</span> <span class="n">searched</span> <span class="k">for</span> <span class="o">*/</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">where</span><span class="p">;</span>                                     <span class="o">/*</span> <span class="n">what</span> <span class="n">was</span> <span class="n">found</span> <span class="o">*/</span>
 <span class="nb">int</span>   <span class="nb">len</span><span class="p">;</span>                               <span class="o">/*</span> <span class="n">length</span> <span class="n">of</span> <span class="n">where</span> <span class="n">buffer</span> <span class="o">*/</span>
<span class="p">};</span>
<span class="n">SRCHI</span>   <span class="o">*</span><span class="n">n_srchinfo</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCH</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span><span class="nb">int</span> <span class="n">i</span><span class="p">);</span>
<span class="n">SRCHI</span>   <span class="o">*</span><span class="n">n_freesrchi</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCHI</span> <span class="o">*</span><span class="n">si</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions may be used within the hit callback function to obtain
detailed information about any Metamorph queries that may have been used
in the query. <code class="docutils literal notranslate"><span class="pre">n_getsrchlst()</span></code> takes the TEXIS handle passed to the
hit callback function and returns a list of handles to all Metamorph
searches associated with the query. These handles may then be used in
calls to <code class="docutils literal notranslate"><span class="pre">n_srchinfo()</span></code>. <code class="docutils literal notranslate"><span class="pre">SRCHLSTPN</span></code> is returned on error.
<code class="docutils literal notranslate"><span class="pre">SRCHLST</span></code> members:</p>
<p><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">n</span></code> — The number of searches contained in <code class="docutils literal notranslate"><span class="pre">lst</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">SRCH</span> <span class="pre">lst[]</span></code> — The array of searches.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SRCHLST</span></code> returned by <code class="docutils literal notranslate"><span class="pre">n_getsrchlst()</span></code> should be freed by
calling <code class="docutils literal notranslate"><span class="pre">n_freesrchlst()</span></code> when it is no longer needed.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_fillsrchlst()</span></code> fills in the <code class="docutils literal notranslate"><span class="pre">SRCHLST</span> <span class="pre">*sl[]</span></code> and
<code class="docutils literal notranslate"><span class="pre">MMOFFS</span> <span class="pre">mmoff[]</span></code> arrays in the supplied <code class="docutils literal notranslate"><span class="pre">FLDLST</span></code>. This provides the
Metamorph search handles, if any, for each individual field. This
supercedes <code class="docutils literal notranslate"><span class="pre">n_getsrchlst()</span></code> because it is more generally useful. It
also provides a list of all subhit offsets for each individual field.
This greatly simplifies hit tagging if all you need is the offset
information about each subhit. <code class="docutils literal notranslate"><span class="pre">n_fillsrchlst()</span></code> always returns
non-zero meaning success.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MMOFFS-&gt;off</span></code> member is an array of start and end offsets of
subhits within the field. <code class="docutils literal notranslate"><span class="pre">MMOFFS-&gt;n</span></code> is the number of entries in the
off array. Each <code class="docutils literal notranslate"><span class="pre">off</span></code> is made of two members: <code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">start</span></code> and
<code class="docutils literal notranslate"><span class="pre">long</span> <span class="pre">end</span></code>. Start is the byte offset of the subhit within the field.
End is the byte offset of the end of the subhit within the field plus
one (plus one makes <code class="docutils literal notranslate"><span class="pre">for()</span></code> loops easier to write). The offs array
contains subhits from all Metamorphs that may have been applied to the
field. Offsets are sorted in ascending order by start offset. Overall
hit and delimiter offsets are not included in the <code class="docutils literal notranslate"><span class="pre">MMOFFS</span></code> list.
<code class="docutils literal notranslate"><span class="pre">MMOFFS</span></code> contains the offsets that would be returned with indices 3–n
of <code class="docutils literal notranslate"><span class="pre">n_srchinfo()</span></code>, but sorted.</p>
<p>Many queries do not need to apply Metamorph to the actual field as the
index is sufficient to decide if there is a hit or not, and so will not
return any hit information. If the query orders the results it is
possible that the engine will have finished using the Metamorph engine
before the results are returned to the user, and so the results are no
longer available. If you need accurate hit-offset information it is
suggested that you use the Metamorph API at the client side to search
the field returned.</p>
<p>The memory allocated by <code class="docutils literal notranslate"><span class="pre">n_fillsrchlst()</span></code> should not be freed because
it is managed automatically.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_srchinfo()</span></code> takes a search handle and the index of the sub-hit to
return information about. It returns a <code class="docutils literal notranslate"><span class="pre">SRCHI</span></code> pointer on success or
SRCHIPN on error or if the index is out of range. The index may be
controlled by a loop to get information about all parts of the hit.</p>
<p>Index values and what they return:</p>
<div class="line-block">
<div class="line">xxxxxx = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx = xxxxxxxxxxxxxxxxxxxxx Index
<code class="docutils literal notranslate"><span class="pre">SRCHI-&gt;what</span></code> points to <code class="docutils literal notranslate"><span class="pre">SRCHI-&gt;where</span></code> contains</div>
<div class="line">0 The original query The whole hit</div>
<div class="line">1 A regular expression The start delimiter</div>
<div class="line">2 A regular expression The end delimiter</div>
<div class="line">3-n The “set” being searched for The match</div>
<div class="line">as listed below</div>
</div>
<div class="line-block">
<div class="line">xxxxxxxxx = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx Set type
<code class="docutils literal notranslate"><span class="pre">SRCHI-&gt;what</span></code> points to</div>
<div class="line">REX A regular expression</div>
<div class="line">NPM The npm query expression</div>
<div class="line">PPM The root word of the list of words</div>
<div class="line">XPM The “approximate” string</div>
</div>
<p>Each <code class="docutils literal notranslate"><span class="pre">SRCHI</span></code> returned by <code class="docutils literal notranslate"><span class="pre">n_srchinfo()</span></code> should be freed by calling
<code class="docutils literal notranslate"><span class="pre">n_freesrchi()</span></code> when it is no longer needed.</p>
<p>The subhit offsets returned by <code class="docutils literal notranslate"><span class="pre">n_srchinfo()</span></code> are <em>not</em> sorted.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_xpminfo()</span></code> and its example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;tstone.h&quot;</span>
<span class="n">XPMI</span> <span class="o">*</span><span class="n">n_xpminfo</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">SRCH</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span><span class="nb">int</span> <span class="n">index</span><span class="p">);</span>
<span class="n">XPMI</span> <span class="o">*</span><span class="n">n_freexpmi</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">XPMI</span> <span class="o">*</span><span class="n">xi</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions may be used within the hit callback function to obtain
detailed information about any search terms that may have used the
approximate pattern matcher (XPM). <code class="docutils literal notranslate"><span class="pre">n_xpminfo()</span></code> is called with the
index of the desired XPM.</p>
<p>It returns a structure containing everything about that XPM. It returns
XPMIPN <a class="footnote-reference brackets" href="#id19" id="id4">4</a> if index is out of bounds.</p>
<p>To get all XPM subhits put <code class="docutils literal notranslate"><span class="pre">n_xpminfo()</span></code> in a loop with index starting
at zero and incrementing until <code class="docutils literal notranslate"><span class="pre">XPMIPN</span></code> is returned.</p>
<p>Each valid structure returned by <code class="docutils literal notranslate"><span class="pre">n_xpminfo()</span></code> should be freed by
calling <code class="docutils literal notranslate"><span class="pre">n_freexpmi()</span></code> when it is no longer needed.</p>
<p>The XPMI structure contains the following members:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XPMI</span>                                                    <span class="o">/*</span> <span class="n">XPM</span> <span class="n">Info</span> <span class="o">*/</span>
<span class="p">{</span>
 <span class="n">word</span>  <span class="n">thresh</span><span class="p">;</span>             <span class="o">/*</span> <span class="n">threshold</span> <span class="n">above</span> <span class="n">which</span> <span class="n">a</span> <span class="n">hit</span> <span class="n">can</span> <span class="n">occur</span> <span class="o">*/</span>
 <span class="n">word</span>  <span class="n">maxthresh</span><span class="p">;</span>                          <span class="o">/*</span> <span class="n">exact</span> <span class="n">match</span> <span class="n">threshold</span> <span class="o">*/</span>
 <span class="n">word</span>  <span class="n">thishit</span><span class="p">;</span>                             <span class="o">/*</span> <span class="n">this</span> <span class="n">hit</span><span class="s1">&#39;s threshold */</span>
 <span class="n">word</span>  <span class="n">maxhit</span><span class="p">;</span>                      <span class="o">/*</span> <span class="nb">max</span> <span class="n">threshold</span> <span class="n">located</span> <span class="n">so</span> <span class="n">far</span> <span class="o">*/</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">maxstr</span><span class="p">;</span>                    <span class="o">/*</span> <span class="n">string</span> <span class="n">of</span> <span class="n">highest</span> <span class="n">value</span> <span class="n">so</span> <span class="n">far</span> <span class="o">*/</span>
 <span class="n">char</span> <span class="o">*</span><span class="n">srchs</span><span class="p">;</span>                            <span class="o">/*</span> <span class="n">string</span> <span class="n">being</span> <span class="n">search</span> <span class="k">for</span> <span class="o">*/</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Don’t expect <code class="docutils literal notranslate"><span class="pre">XPMI.thresh</span></code> to be the percentage entered in the query
passed to <code class="docutils literal notranslate"><span class="pre">n_setqry()</span></code>. It is an absolute number calculated from that
percentage and the search string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>
<span class="n">hit_handler</span><span class="p">(</span><span class="n">usr</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">fl</span><span class="p">)</span>
<span class="n">void</span> <span class="o">*</span><span class="n">usr</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">my</span> <span class="n">user</span><span class="o">-</span><span class="n">data</span> <span class="n">pointer</span> <span class="o">*/</span>
<span class="n">TEXIS</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">Texis</span> <span class="n">API</span> <span class="n">handle</span> <span class="o">*/</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span> <span class="o">/*</span> <span class="n">The</span> <span class="n">field</span> <span class="nb">list</span> <span class="n">data</span> <span class="n">structure</span> <span class="o">*/</span>
<span class="p">{</span>
 <span class="o">...</span>
 <span class="n">MYAPP</span>   <span class="o">*</span><span class="n">ts</span><span class="o">=</span><span class="p">(</span><span class="n">MYAPP</span> <span class="o">*</span><span class="p">)</span><span class="n">usr</span><span class="p">;</span>
 <span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="o">=</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">se</span><span class="p">;</span>
 <span class="n">SRCHLST</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
 <span class="n">SRCHI</span>   <span class="o">*</span><span class="n">si</span><span class="p">;</span>
 <span class="n">XPMI</span>    <span class="o">*</span><span class="n">xi</span><span class="p">;</span>
 <span class="nb">int</span>      <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

 <span class="o">...</span>
 <span class="n">sl</span><span class="o">=</span><span class="n">n_getsrchlst</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">);</span>        <span class="o">/*</span> <span class="n">get</span> <span class="nb">list</span> <span class="n">of</span> <span class="n">Metamorphs</span> <span class="k">for</span> <span class="n">query</span> <span class="o">*/</span>
 <span class="k">if</span><span class="p">(</span><span class="n">sl</span><span class="o">!=</span><span class="n">SRCHLSTPN</span><span class="p">)</span>
    <span class="p">{</span>
     <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>                     <span class="o">/*</span> <span class="k">for</span> <span class="n">each</span> <span class="n">Metamorph</span> <span class="o">*/</span>
         <span class="p">{</span>
          <span class="n">SRCH</span> <span class="o">*</span><span class="n">sr</span><span class="o">=</span> <span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>                           <span class="o">/*</span> <span class="n">alias</span> <span class="o">*/</span>
                                          <span class="o">/*</span> <span class="n">loop</span> <span class="n">thru</span> <span class="nb">all</span> <span class="n">sub</span><span class="o">-</span><span class="n">hits</span> <span class="o">*/</span>
            <span class="o">/*</span> <span class="n">the</span> <span class="n">zero</span> <span class="n">index</span> <span class="k">for</span> <span class="n">n_srchinfo</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">hit</span>       <span class="o">*/</span>
            <span class="o">/*</span> <span class="n">the</span> <span class="n">one</span>  <span class="n">index</span> <span class="k">for</span> <span class="n">n_srchinfo</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">start</span> <span class="n">delimiter</span> <span class="o">*/</span>
            <span class="o">/*</span> <span class="n">the</span> <span class="n">two</span>  <span class="n">index</span> <span class="k">for</span> <span class="n">n_srchinfo</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">end</span> <span class="n">delimiter</span>   <span class="o">*/</span>
            <span class="o">/*</span> <span class="n">the</span> <span class="n">remaining</span> <span class="n">indices</span> <span class="n">are</span> <span class="n">the</span> <span class="n">subhits</span>                <span class="o">*/</span>
          <span class="k">for</span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;(</span><span class="n">si</span><span class="o">=</span><span class="n">n_srchinfo</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">!=</span><span class="n">SRCHIPN</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
              <span class="p">{</span>
               <span class="n">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>              <span class="o">/*</span> <span class="n">scratch</span> <span class="n">buffer</span> <span class="n">pointers</span> <span class="o">*/</span>
               <span class="n">switch</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
               <span class="p">{</span>
                <span class="n">case</span> <span class="mi">0</span> <span class="p">:</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot; HIT    (</span><span class="si">%s</span><span class="s2">):</span><span class="si">%d</span><span class="s2">:&quot;</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">what</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="nb">len</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="n">case</span> <span class="mi">1</span> <span class="p">:</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot; S-DELIM(</span><span class="si">%s</span><span class="s2">):</span><span class="si">%d</span><span class="s2">:&quot;</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">what</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="nb">len</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="n">case</span> <span class="mi">2</span> <span class="p">:</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot; E-DELIM(</span><span class="si">%s</span><span class="s2">):</span><span class="si">%d</span><span class="s2">:&quot;</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">what</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="nb">len</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="n">default</span><span class="p">:</span><span class="n">printf</span><span class="p">(</span><span class="s2">&quot; SUB-HIT(</span><span class="si">%s</span><span class="s2">):</span><span class="si">%d</span><span class="s2">:&quot;</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">what</span><span class="p">,</span><span class="n">si</span><span class="o">-&gt;</span><span class="nb">len</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
               <span class="p">}</span>
               <span class="k">for</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">si</span><span class="o">-&gt;</span><span class="n">where</span><span class="p">,</span><span class="n">e</span><span class="o">=</span><span class="n">p</span><span class="o">+</span><span class="n">si</span><span class="o">-&gt;</span><span class="nb">len</span><span class="p">;</span><span class="n">p</span><span class="o">&lt;</span><span class="n">e</span><span class="p">;</span><span class="n">p</span><span class="o">++</span><span class="p">)</span>
                   <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">&lt;</span><span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="o">!=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                      <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">x</span><span class="si">%02x</span><span class="s2">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
                   <span class="k">else</span>
                      <span class="n">putchar</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
               <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
               <span class="n">n_freesrchi</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">si</span><span class="p">);</span>            <span class="o">/*</span> <span class="n">free</span> <span class="nb">any</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">si</span> <span class="o">*/</span>
              <span class="p">}</span>
          <span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;(</span><span class="n">xi</span><span class="o">=</span><span class="n">n_xpminfo</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">!=</span><span class="n">XPMIPN</span><span class="p">;</span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
             <span class="p">{</span>                                    <span class="o">/*</span> <span class="n">loop</span> <span class="n">thru</span> <span class="n">XPMs</span> <span class="o">*/</span>
              <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;XPM: </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">: thresh </span><span class="si">%u</span><span class="s2">, maxthresh </span><span class="si">%u</span><span class="s2">, thishit </span><span class="si">%u</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">xi</span><span class="o">-&gt;</span><span class="n">srchs</span><span class="p">,</span><span class="n">xi</span><span class="o">-&gt;</span><span class="n">thresh</span><span class="p">,</span><span class="n">xi</span><span class="o">-&gt;</span><span class="n">maxthresh</span><span class="p">,</span><span class="n">xi</span><span class="o">-&gt;</span><span class="n">thishit</span><span class="p">);</span>
              <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   : maxhit </span><span class="si">%u</span><span class="s2">, maxstr </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">xi</span><span class="o">-&gt;</span><span class="n">maxhit</span><span class="p">,</span><span class="n">xi</span><span class="o">-&gt;</span><span class="n">maxstr</span><span class="p">);</span>
              <span class="n">n_freexpmi</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">xi</span><span class="p">);</span>                  <span class="o">/*</span> <span class="n">free</span> <span class="n">mem</span> <span class="ow">in</span> <span class="n">xi</span> <span class="o">*/</span>
             <span class="p">}</span>
         <span class="p">}</span>
     <span class="n">n_freesrchlst</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">sl</span><span class="p">);</span>
    <span class="p">}</span>
 <span class="o">...</span>

 <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>          <span class="o">/*</span> <span class="n">tell</span> <span class="n">the</span> <span class="n">server</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">giving</span> <span class="n">me</span> <span class="n">more</span> <span class="n">hits</span> <span class="o">*/</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The example program <code class="docutils literal notranslate"><span class="pre">netex3.c</span></code>, <code class="docutils literal notranslate"><span class="pre">n_reghitcb()</span></code>, <code class="docutils literal notranslate"><span class="pre">n_getsrchlst()</span></code>,
<code class="docutils literal notranslate"><span class="pre">n_srchinfo()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;tstone.h&quot;</span>
<span class="nb">int</span> <span class="n">n_getindexcount</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">);</span>
</pre></div>
</div>
<p>This function will return the count of rows to be read from the index
for the most recently prepared statement, if available.</p>
<p>The return from this function is only valid under certain circumstances,
which are when the index has been scanned to get a list of potentially
matching records. In a join, the return value will be the number of
matches in the inner table corresponding to the current outer row, not
the number of outer table matches. The actual number of records returned
may be significantly less if post processing is done to resolve some of
the where clause.</p>
<p>The default behaviour of Texis with a single relational operator and an
index on the field is to walk the index as the rows are returned, which
is faster at getting the initial rows out. Since it does not get all the
matching rows from the index first, n_getindexcount() will return 0.
This behaviour can be changed with the bubble property.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">::</span>
</pre></div>
</div>
<blockquote>
<div><p>char <a href="#id5"><span class="problematic" id="id6">*</span></a>url=n_newindirect(SERVER <a href="#id7"><span class="problematic" id="id8">*</span></a>se,char <a href="#id9"><span class="problematic" id="id10">*</span></a>database,char <a href="#id11"><span class="problematic" id="id12">*</span></a>table,char <a href="#id13"><span class="problematic" id="id14">*</span></a>fn);</p>
</div></blockquote>
<p>This functions allow you to manipulate indirect fields within a Texis
database.</p>
<p><code class="docutils literal notranslate"><span class="pre">newindirect()</span></code> generates a URL that can be used to store data on the
server. If <code class="docutils literal notranslate"><span class="pre">fn</span></code> is <code class="docutils literal notranslate"><span class="pre">NULL</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> it will create a URL which can
be used to store data in that is owned by Texis. If <code class="docutils literal notranslate"><span class="pre">fn</span></code> is not
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> and not <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> and is not a URL already then it will be made
into a URL owned by you. If fn is a full path, it will be respected.
Otherwise the standard path of indirect files for the table will be
prepended.</p>
<p><code class="docutils literal notranslate"><span class="pre">newindirect()</span></code> returns a URL that can be stored into. The URL that is
returned is an allocated string that <strong>MUST</strong> be freed by the caller.</p>
<p>The URLs returned by this function may then be used as the field
contents of indirect fields.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_rcopyto()</span></code>, <code class="docutils literal notranslate"><span class="pre">n_rcopyfrom()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_rcopyto</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">remotedest</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">localsrc</span><span class="p">);</span>
<span class="nb">int</span> <span class="n">n_rcopyfrom</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">localdest</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">remotesrc</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions provide the ability to copy files between client and
server. They are useful for inserting and retrieving INDIRECT fields. An
indirect field will usually point to a file on the same machine as the
server. So the existing connection may be used to transfer the file.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_rcopyto()</span></code> copies a file from the client to the server.
<code class="docutils literal notranslate"><span class="pre">n_rcopyfrom()</span></code> copies a file from the server to the client. In both
cases the second argument is the name of the file to create and the
third argument is the file to read from.</p>
<p>Both functions return zero on error and non-zero on success.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/* insert a row with an indirect while creating the indirect file */

SERVER *se;
char *database, *table;
char *url, *remotefn, *localfn;
char *description;

   ...
   database=...
   table=...
   ...
   n_setdatabase(se,database);
   ...
   localfn=...
   description=...
   ...
   url=n_newindirect(se,database,table,(char *)NULL);
   remotefn=urlfn(url);
   if(!n_rcopyto(se,remotefn,localfn))
      puts(&quot;error&quot;);
   n_texis(se,&quot;insert into %s values(&#39;%s&#39;,&#39;%s&#39;);&quot;,
           table,description,remotefn);
   free(remotefn);
   free(url);
   ...
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/* query a table with an indirect field and download the file */

int
hit_handler(usr,tx,fl)
void *usr;  /* my user-data pointer */
TEXIS *tx;  /* Texis API handle */
FLDLST *fl; /* The field list data structure */
{
 USERDATA *myd=(USERDATA *)usr; /* cast the void into the real type */
 char *description, *remotefn;

      /* I know the resultant data types because I wrote the SELECT */
 description=(char *)fl-&gt;data[0];
 remotefn   =(char *)fl-&gt;data[1];
 printf(&quot;%s:\n&quot;,description);              /* print the description */
 if(!n_rcopyfrom(myd-&gt;se,&quot;/tmp/scratch&quot;,remotefn)) /* get text file */
    puts(&quot;error&quot;);
 displayfile(&quot;/tmp/scratch&quot;);/* fictitious function to display a file */
 return(1);          /* tell the server to keep giving me more hits */
}

main()
{
 USERDATA mydata;

   mydata.se=...
   mydata.database=...
   mydata.table=...
   ...
   n_regtexiscb(mydata.se,&amp;mydata,hit_handler);
   n_setdatabase(mydata.se,mydata.database);
   ...
   n_texis(mydata.se,
     &quot;select description,text from %s where text like &#39;power struggle&#39;&quot;,
     mydata.table);
   ...
}
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">n_newindirect()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>   <span class="n">n_setdefaults</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">)</span>
<span class="nb">int</span>   <span class="n">n_setdatabase</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="nb">str</span> <span class="n">dbname</span><span class="p">)</span>
<span class="nb">str</span>   <span class="n">n_getdatabase</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">)</span>
</pre></div>
</div>
<p>This collection of functions provide the needed control over how a
<strong>Texis</strong> server will behave. They are to be used prior to a call to
<code class="docutils literal notranslate"><span class="pre">n_texis()</span></code>. All of the functions have a common first argument which
is the omnipresent <code class="docutils literal notranslate"><span class="pre">SERVER</span> <span class="pre">*</span></code>. If a <code class="docutils literal notranslate"><span class="pre">set</span></code> function returns an
<code class="docutils literal notranslate"><span class="pre">int</span></code>, the value 0 means failure and <code class="docutils literal notranslate"><span class="pre">not</span></code> 0 means the operation was
successful. Those functions that have a <code class="docutils literal notranslate"><span class="pre">void</span></code> return value return
nothing. If a <code class="docutils literal notranslate"><span class="pre">get</span></code> function returns a pointer type, the value
<code class="docutils literal notranslate"><span class="pre">(type</span> <span class="pre">*)NULL</span></code> indicates a problem getting memory. Otherwise the
pointer should be freed when no longer needed.</p>
<dl class="simple">
<dt>void n_setdefaults(SERVER *se)</dt><dd><p>resets all server parameters to their initial state.</p>
</dd>
<dt>int n_setdatabase(SERVER *se,str dbname)</dt><dd><p>sets <code class="docutils literal notranslate"><span class="pre">dbname</span></code> as the name of the <strong>Texis</strong> database that is to be
queried against.</p>
</dd>
<dt>str n_getdatabase(SERVER *se)</dt><dd><p>gets the name of the <strong>Texis</strong> database that is to be queried
against.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_texis</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">queryformat</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
</pre></div>
</div>
<p>This function comprises the real work that is to be performed by the
network Texis server. To initiate the actual search the program makes a
call to the <code class="docutils literal notranslate"><span class="pre">n_texis()</span></code> function. The server will begin to call the
client’s callback routine that was set in the <code class="docutils literal notranslate"><span class="pre">n_regtexiscb()</span></code> call.
The <code class="docutils literal notranslate"><span class="pre">n_texis()</span></code> function will return 0 on error or true if all goes
well. <em>NOTE: It is not considered an error for there to be zero hits
located by a search. A client’s callback routine will never be invoked
in this instance.</em></p>
<p>The <code class="docutils literal notranslate"><span class="pre">queryformat</span></code> argument is a <code class="docutils literal notranslate"><span class="pre">printf()</span></code> style format string that
will be filled in by any subsequent arguments and then executed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;sys/types.h&gt;
#include &quot;tstone.h&quot;
main(argc,argv)
int argc;
char **argv;
{
 SERVER *se;
 char buf[80];
 USERDATA mydata;

 ...
 n_regtexiscb(se,mydata,hit_handler);         /* setup hit callback */
 n_setdatabase(se,argv[1]);               /* set database to search */
 while(gets(buf)!=(char *)NULL)                 /* crude user input */
    if(!n_texis(se,&quot;%s;&quot;,buf))     /* add required &#39;;&#39; for the user */
         puts(&quot;ERROR in n_texis&quot;);
 ...
}
</pre></div>
</div>
<p>Your system’s <code class="docutils literal notranslate"><span class="pre">printf()</span></code> man page for the format string <code class="docutils literal notranslate"><span class="pre">%</span></code> codes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settexisparam</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TX</span> <span class="o">*</span><span class="n">n_opentx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">);</span>
<span class="n">TX</span> <span class="o">*</span><span class="n">n_duptx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">TX</span> <span class="o">*</span><span class="n">n_closetx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions provide an alternative to <code class="docutils literal notranslate"><span class="pre">n_texis()</span></code>. They allow the
same style of SQL statements via <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code>, but maintain the
connection to the database for performing multiple queries without
constant reopens. This improves the efficiency of executing multiple
statements against the same database.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_opentx()</span></code> opens the database specified in the last call to
<code class="docutils literal notranslate"><span class="pre">n_setdatabase()</span></code>. It returns a valid TX pointer on success or
<code class="docutils literal notranslate"><span class="pre">TXPN</span></code> on failure. <code class="docutils literal notranslate"><span class="pre">TXPN</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">(TX</span> <span class="pre">*)NULL</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_duptx()</span></code> creates a new TX pointer to the same database as a
currently valid handle. This saves much of the overhead of opening a new
connection to the database. The returned handle is a clean TX handle,
and will not have a copy of the SQL statement from the copied handle. It
returns a valid TX pointer on success or <code class="docutils literal notranslate"><span class="pre">TXPN</span></code> on failure. <code class="docutils literal notranslate"><span class="pre">TXPN</span></code>
is an alias for <code class="docutils literal notranslate"><span class="pre">(TX</span> <span class="pre">*)NULL</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_closetx()</span></code> closes the previously opened database. It always returns
<code class="docutils literal notranslate"><span class="pre">TXPN</span></code>.</p>
<p>SQL statements are setup and executed with <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code>, <code class="docutils literal notranslate"><span class="pre">n_runtx()</span></code>,
and <code class="docutils literal notranslate"><span class="pre">n_gettx()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settx</span><span class="p">(),</span> <span class="n">n_runtx</span><span class="p">(),</span> <span class="ow">and</span> <span class="n">n_gettx</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TX</span>  <span class="o">*</span><span class="n">n_settx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">queryformat</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="nb">int</span>  <span class="n">n_runtx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions perform SQL statement setup and execution for databases
opened with <code class="docutils literal notranslate"><span class="pre">n_opentx()</span></code>. <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code> takes a <code class="docutils literal notranslate"><span class="pre">TX</span></code> pointer from
<code class="docutils literal notranslate"><span class="pre">n_opentx()</span></code>, a printf style format string, and the arguments to fill
in that format string with.</p>
<p>The query will be constructed using the format string and arguments,
parsed, and prepared for execution. <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code> will return the same
<code class="docutils literal notranslate"><span class="pre">TX</span></code> passed to it on success. It will return <code class="docutils literal notranslate"><span class="pre">TXPN</span></code> on error.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_runtx()</span></code> will execute the statement prepared with <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code>. At
this point what you said will begin to happen and your callback will be
called as appropriate. When this function returns execution is complete
and another <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code> should be performed before running again. It
will return zero on error and non-zero on success.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>

   <span class="o">...</span>
   <span class="k">if</span><span class="p">((</span><span class="n">tx</span><span class="o">=</span><span class="n">n_opentx</span><span class="p">())</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>      <span class="o">/*</span> <span class="n">initialize</span> <span class="n">database</span> <span class="n">connection</span> <span class="o">*/</span>
   <span class="p">{</span>
      <span class="o">...</span>
                                                     <span class="o">/*</span> <span class="n">setup</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_settx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span>
                 <span class="s2">&quot;select NAME from SYSTABLES where CREATOR!=&#39;texis&#39;;&quot;</span>
                <span class="p">)</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>
         <span class="n">n_runtx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">);</span>                           <span class="o">/*</span> <span class="n">execute</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="o">...</span>
                                             <span class="o">/*</span> <span class="n">setup</span> <span class="n">another</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_settx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span>
                <span class="s2">&quot;select NAME,TYPE from SYSCOLUMNS where TBNAME=&#39;image&#39;;&quot;</span>
                <span class="p">)</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>
         <span class="n">n_runtx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">);</span>                         <span class="o">/*</span> <span class="n">execute</span> <span class="n">a</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="o">...</span>
      <span class="n">n_closetx</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>                   <span class="o">/*</span> <span class="n">close</span> <span class="n">database</span> <span class="n">connection</span> <span class="o">*/</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_opentx</span><span class="p">(),</span> <span class="n">n_gettx</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_preptx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span><span class="n">char</span> <span class="o">*</span><span class="n">queryfmt</span><span class="p">,</span><span class="o">...</span><span class="p">);</span>
<span class="nb">int</span> <span class="n">n_exectx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">p_se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
</pre></div>
</div>
<p>These functions provide an efficient way to perform the same SQL
statement multiple times with varying parameter data.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_preptx()</span></code> will perform SQL statement setup. It takes a <code class="docutils literal notranslate"><span class="pre">TX</span></code>
pointer from <code class="docutils literal notranslate"><span class="pre">n_opentx()</span></code>, a printf style format string, and the
arguments to fill in that format string with.</p>
<p>The query will be constructed using the format string and arguments,
parsed, and prepared for execution. <code class="docutils literal notranslate"><span class="pre">n_preptx()</span></code> will return non-zero
on success. It will return zero on error.</p>
<p><code class="docutils literal notranslate"><span class="pre">n_exectx()</span></code> will begin execution of the SQL statement. It will return
non-zero on success and zero on error. <code class="docutils literal notranslate"><span class="pre">n_runtx()</span></code> or <code class="docutils literal notranslate"><span class="pre">n_gettx()</span></code> or
<code class="docutils literal notranslate"><span class="pre">n_flushtx()</span></code> would then be called to handle the results of the
statement as with <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code>.</p>
<p>Once a SQL statement is prepared with <code class="docutils literal notranslate"><span class="pre">n_preptx()</span></code> it may be executed
multiple times with <code class="docutils literal notranslate"><span class="pre">n_exectx()</span></code>. Typically the parameter data is
changed between executions using the <code class="docutils literal notranslate"><span class="pre">n_paramtx()</span></code> function.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SERVER *se;
TX     *tx;
long    date;
char   *title;
char   *article;
int     tlen, alen, dlen;

   ...
   if(!n_preptx(se,tx,&quot;insert into docs values(counter,?,?,?);&quot;))
      { puts(&quot;n_preptx Failed&quot;); return(0); }
   for( each record to insert )
   {
      ...
      date=...
      dlen=sizeof(date);
      title=...
      tlen=strlen(title);
      article=...
      alen=strlen(article);
      if(!n_paramtx(se,tx,1,&amp;date  ,&amp;dlen,SQL_C_LONG,SQL_DATE       ) ||
         !n_paramtx(se,tx,2,title  ,&amp;tlen,SQL_C_CHAR,SQL_LONGVARCHAR) ||
         !n_paramtx(se,tx,3,article,&amp;alen,SQL_C_CHAR,SQL_LONGVARCHAR));
         { puts(&quot;n_paramtx Failed&quot;); return(0); }
      if(!n_exectx(se,tx))
         { puts(&quot;n_exectx Failed&quot;); return(0); }
      n_flushtx(se,tx);
   }
   ...
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SERVER *se;
TX     *tx;
char   *query;
int     qlen;
FLDLST *fl;

   ...
   if(!n_preptx(se,tx,
         &quot;select id,Title from docs where Article like ?;&quot;))
      { puts(&quot;n_preptx Failed&quot;); return(0); }
   for( each Article query to execute )
   {
      query=...
      qlen=strlen(query);
      if(!n_paramtx(se,tx,1,query,&amp;qlen,SQL_C_CHAR,SQL_LONGVARCHAR))
         { puts(&quot;n_paramtx Failed&quot;); return(0); }
      if(!n_exectx(se,tx))
         { puts(&quot;n_exectx Failed&quot;); return(0); }
      while((fl=n_gettx(se,tx))!=FLDLSTPN)
      {
         ...
         freefldlst(fl);
      }
   }
   ...
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_paramtx</span><span class="p">(),</span> <span class="n">n_opentx</span><span class="p">(),</span> <span class="n">n_gettx</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FLDLST</span> <span class="o">*</span><span class="n">n_gettx</span><span class="p">(</span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">,</span><span class="n">TX</span> <span class="o">*</span><span class="n">tx</span><span class="p">);</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">freefldlst</span><span class="p">(</span><span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">);</span>
</pre></div>
</div>
<p>This function provides a non-callback version of SQL execution.
<code class="docutils literal notranslate"><span class="pre">n_gettx()</span></code> returns a <code class="docutils literal notranslate"><span class="pre">FLDLST</span></code> pointer which is the same as would
normally be passed to a callback function. You process it just as you
would in a callback.</p>
<p>Continue calling <code class="docutils literal notranslate"><span class="pre">n_gettx()</span></code> to get subsequent result rows.
<code class="docutils literal notranslate"><span class="pre">n_gettx()</span></code> will return <code class="docutils literal notranslate"><span class="pre">FLDLSTPN</span></code> when there are no more result
rows.</p>
<p>Each returned <code class="docutils literal notranslate"><span class="pre">FLDLST</span></code> must be freed using the <code class="docutils literal notranslate"><span class="pre">freefldlst()</span></code> when
it is no longer needed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>

   <span class="o">...</span>
   <span class="k">if</span><span class="p">((</span><span class="n">tx</span><span class="o">=</span><span class="n">n_opentx</span><span class="p">())</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>      <span class="o">/*</span> <span class="n">initialize</span> <span class="n">database</span> <span class="n">connection</span> <span class="o">*/</span>
   <span class="p">{</span>
      <span class="o">...</span>
                                                     <span class="o">/*</span> <span class="n">setup</span> <span class="n">query</span> <span class="o">*/</span>
      <span class="k">if</span><span class="p">(</span><span class="n">n_settx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span>
                 <span class="s2">&quot;select NAME from SYSTABLES where CREATOR!=&#39;texis&#39;;&quot;</span>
                <span class="p">)</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>
         <span class="k">while</span><span class="p">((</span><span class="n">fl</span><span class="o">=</span><span class="n">n_gettx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">))</span><span class="o">!=</span><span class="n">FLDLSTPN</span><span class="p">)</span><span class="o">/*</span> <span class="n">get</span> <span class="nb">next</span> <span class="n">result</span> <span class="n">row</span> <span class="o">*/</span>
         <span class="p">{</span>
            <span class="n">dispfields</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>            <span class="o">/*</span> <span class="n">display</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fields</span> <span class="o">*/</span>
            <span class="n">freefldlst</span><span class="p">(</span><span class="n">fl</span><span class="p">);</span>                      <span class="o">/*</span> <span class="n">free</span> <span class="n">the</span> <span class="n">memory</span> <span class="o">*/</span>
         <span class="p">}</span>
      <span class="o">...</span>
      <span class="n">n_closetx</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>                   <span class="o">/*</span> <span class="n">close</span> <span class="n">database</span> <span class="n">connection</span> <span class="o">*/</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_settx</span><span class="p">(),</span> <span class="n">n_runtx</span><span class="p">(),</span> <span class="n">n_regtexiscb</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_settexisparam</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">ipar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">len</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">sqltype</span><span class="p">)</span>
<span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">ipar</span><span class="p">;</span>
<span class="n">void</span>    <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="nb">int</span>     <span class="o">*</span><span class="nb">len</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">ctype</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">sqltype</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">n_paramtx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">ipar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="nb">len</span><span class="p">,</span> <span class="n">ctype</span><span class="p">,</span> <span class="n">sqltype</span><span class="p">)</span>
<span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>      <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">ipar</span><span class="p">;</span>
<span class="n">void</span>    <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="nb">int</span>     <span class="o">*</span><span class="nb">len</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">ctype</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">sqltype</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">n_resetparamtx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
<span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>  <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
</pre></div>
</div>
<p>These functions allow you to pass arbitrarily large or complex data into
a SQL statement. Sometimes there is data that won’t work in the confines
of the simple C string that comprises an SQL statement. Large text
fields or binary data for example.</p>
<p>Call <code class="docutils literal notranslate"><span class="pre">n_settexisparam()</span></code> to setup the parameter data before calling
<code class="docutils literal notranslate"><span class="pre">n_texis()</span></code> or <code class="docutils literal notranslate"><span class="pre">n_settx()</span></code> to prepare the SQL statement. Call
<code class="docutils literal notranslate"><span class="pre">n_paramtx()</span></code> to setup parameters after <code class="docutils literal notranslate"><span class="pre">n_preptx()</span></code> and before
<code class="docutils literal notranslate"><span class="pre">n_exectx()</span></code>. If you have a statement you have already executed once,
and you want to execute again with different data, which may have
parameters unset which were previously unset you can call
<code class="docutils literal notranslate"><span class="pre">n_resetparamtx()</span></code>. This is not neccessary if you will explicitly set
all the parameters. Place a question mark (<code class="docutils literal notranslate"><span class="pre">?</span></code>) in the SQL statement
where you would otherwise place the data.</p>
<p>These are the parameters:</p>
<dl class="simple">
<dt>SERVER *se</dt><dd><p>The open server connection.</p>
</dd>
<dt>TX *tx</dt><dd><p>The prepared SQL statement (<code class="docutils literal notranslate"><span class="pre">n_paramtx()</span></code> only).</p>
</dd>
<dt>int ipar</dt><dd><p>The number of the parameter, starting at 1.</p>
</dd>
<dt>void *buf</dt><dd><p>A pointer to the data to be transmitted.</p>
</dd>
<dt>int *len</dt><dd><p>A pointer to the length of the data. This can be <code class="docutils literal notranslate"><span class="pre">(int</span> <span class="pre">*)NULL</span></code> to
use the default length, which assumes a <code class="docutils literal notranslate"><span class="pre">'\0'</span></code> terminated string
for character data.</p>
</dd>
<dt>int ctype</dt><dd><p>The type of the data. For text use SQL_C_CHAR.</p>
</dd>
<dt>int sqltype</dt><dd><p>The type of the field being inserted into. For varchar use
SQL_LONGVARCHAR.</p>
</dd>
</dl>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 29%" />
<col style="width: 28%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field type</p></th>
<th class="head"><p>sqltype</p></th>
<th class="head"><p>ctype</p></th>
<th class="head"><p>C type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>varchar</p></td>
<td><p>SQL_LONGVARCHAR</p></td>
<td><p>SQL_C_CHAR</p></td>
<td><p>char</p></td>
</tr>
<tr class="row-odd"><td><p>varbyte</p></td>
<td><p>SQL_BINARY</p></td>
<td><p>SQL_C_BINARY</p></td>
<td><p>byte</p></td>
</tr>
<tr class="row-even"><td><p>date</p></td>
<td><p>SQL_DATE</p></td>
<td><p>SQL_C_LONG</p></td>
<td><p>long</p></td>
</tr>
<tr class="row-odd"><td><p>integer</p></td>
<td><p>SQL_INTEGER</p></td>
<td><p>SQL_C_INTEGER</p></td>
<td><p>long</p></td>
</tr>
<tr class="row-even"><td><p>smallint</p></td>
<td><p>SQL_SMALLINT</p></td>
<td><p>SQL_C_SHORT</p></td>
<td><p>short</p></td>
</tr>
<tr class="row-odd"><td><p>float</p></td>
<td><p>SQL_FLOAT</p></td>
<td><p>SQL_C_FLOAT</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-even"><td><p>double</p></td>
<td><p>SQL_DOUBLE</p></td>
<td><p>SQL_C_DOUBLE</p></td>
<td><p>double</p></td>
</tr>
<tr class="row-odd"><td><p>varind</p></td>
<td><p>SQL_LONGVARCHAR</p></td>
<td><p>SQL_C_CHAR</p></td>
<td><p>char</p></td>
</tr>
<tr class="row-even"><td><p>counter</p></td>
<td><p>SQL_COUNTER</p></td>
<td><p>SQL_C_COUNTER</p></td>
<td><p>ft_counter</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SERVER *se;
TX     *tx;
char   *description;
char   *article;
int     len;

   ...
   description=&quot;a really large article&quot;;
   article=...
   len=...
   if(!n_settexisparam(se,1,article,&amp;len, SQL_C_CHAR, SQL_LONGVARCHAR))
      puts(&quot;n_settexisparam failed&quot;);
   else
   if(!n_texis(se,&quot;insert into docs values(&#39;%s&#39;,?);&quot;,description))
      puts(&quot;insert failed&quot;);
   ...
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>SERVER *se;
TX     *tx;
char   *description;
char   *article;
int     lend, lena;

   if(!n_preptx(se,tx,&quot;insert into docs values(?,?);&quot;))
      { puts(&quot;n_preptx Failed&quot;); return(0); }
   ...
   description=&quot;a really large article&quot;;
   lend=strlen(description);
   article=...
   lena=strlen(article);
   if(!n_paramtx(se,tx,1,description,&amp;lend,SQL_C_CHAR,SQL_LONGVARCHAR)||
      !n_paramtx(se,tx,2,article    ,&amp;lena,SQL_C_CHAR,SQL_LONGVARCHAR));
      { puts(&quot;n_paramtx Failed&quot;); return(0); }
   if(!n_exectx(se,tx))
      { puts(&quot;n_exectx Failed&quot;); return(0); }
   ...
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_flushtx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">);</span>
<span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>      <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
</pre></div>
</div>
<p>This function flushes any remaining results from the current SQL
statement. Execution of the statement is finished however. This is
useful for ignoring the output of <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> and <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> statements.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>

   <span class="o">...</span>
                                                     <span class="o">/*</span> <span class="n">setup</span> <span class="n">query</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span>
              <span class="s2">&quot;delete from customer where lastorder&lt;&#39;1990-01-01&#39;;&quot;</span>
             <span class="p">)</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>
      <span class="n">n_flushtx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">);</span>                        <span class="o">/*</span> <span class="n">ignore</span> <span class="n">result</span> <span class="nb">set</span> <span class="o">*/</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n_flushtx2</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">nrows</span><span class="p">,</span><span class="nb">max</span><span class="p">);</span>
<span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>      <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">nrows</span><span class="p">;</span>
<span class="nb">int</span>     <span class="nb">max</span><span class="p">;</span>
</pre></div>
</div>
<p>This function flushes up to nrows results from the specified SQL
statement. This is useful for skipping a number of records from a
<code class="docutils literal notranslate"><span class="pre">SELECT</span></code>. The max is an suggestion to the SQL engine of how many
records you intend to read.</p>
<p>The return will be the number of records actually flushed if successful,
or if an error occurred then the return will be a negative number of (-1
- rowsflushed). Reaching the end of the results is not considered an
error, and will result in a return less than nrows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>

   <span class="o">...</span>
                                                     <span class="o">/*</span> <span class="n">setup</span> <span class="n">query</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span>
              <span class="s2">&quot;select name from customer where lastorder&lt;&#39;1990-01-01&#39;;&quot;</span>
             <span class="p">)</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>
      <span class="n">n_flushtx2</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>           <span class="o">/*</span> <span class="n">ignore</span> <span class="n">first</span> <span class="mi">10</span> <span class="n">results</span> <span class="o">*/</span>
   <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MMOFFS</span> <span class="o">*</span><span class="n">n_offstx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">fieldname</span><span class="p">);</span>
<span class="n">SERVER</span>  <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>      <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
<span class="n">char</span>    <span class="o">*</span><span class="n">fieldname</span><span class="p">;</span>
</pre></div>
</div>
<p>This function returns any and all Metamorph subhit offsets for the named
field. It returns <code class="docutils literal notranslate"><span class="pre">MMOFFSPN</span></code> <a class="footnote-reference brackets" href="#id20" id="id15">5</a> if there are none. See
<code class="docutils literal notranslate"><span class="pre">n_fillsrchlst()</span></code> for a description of the <code class="docutils literal notranslate"><span class="pre">MMOFFS</span></code> structure, and
why there may be no hit information. The returned structure must be
freed with <code class="docutils literal notranslate"><span class="pre">freemmoffs()</span></code> when no longer needed. It is safe to pass
<code class="docutils literal notranslate"><span class="pre">MMOFFSPN</span></code> to <code class="docutils literal notranslate"><span class="pre">freemmoffs()</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVER</span> <span class="o">*</span><span class="n">se</span><span class="p">;</span>
<span class="n">TX</span>     <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
<span class="n">FLDLST</span> <span class="o">*</span><span class="n">fl</span><span class="p">;</span>
<span class="n">MMOFFS</span> <span class="o">*</span><span class="n">mmo</span><span class="p">;</span>

   <span class="o">...</span>
                                                     <span class="o">/*</span> <span class="n">setup</span> <span class="n">query</span> <span class="o">*/</span>
   <span class="k">if</span><span class="p">(</span><span class="n">n_settx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span>
       <span class="s2">&quot;select desc,text from docs where text like &#39;power struggle&#39;;&quot;</span><span class="p">,</span>
       <span class="p">)</span><span class="o">!=</span><span class="n">TXPN</span><span class="p">)</span>
      <span class="k">while</span><span class="p">((</span><span class="n">fl</span><span class="o">=</span><span class="n">n_gettx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">))</span><span class="o">!=</span><span class="n">FLDLSTPN</span><span class="p">)</span>   <span class="o">/*</span> <span class="n">get</span> <span class="nb">next</span> <span class="n">result</span> <span class="n">row</span> <span class="o">*/</span>
      <span class="p">{</span>
         <span class="n">mmo</span><span class="o">=</span><span class="n">n_offstx</span><span class="p">(</span><span class="n">se</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="s2">&quot;text&quot;</span><span class="p">);</span> <span class="o">/*</span> <span class="n">get</span> <span class="n">Metamorph</span> <span class="n">info</span> <span class="k">for</span> <span class="n">text</span> <span class="o">*/</span>
         <span class="n">dispfields</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span><span class="n">mmo</span><span class="p">);</span><span class="o">/*</span> <span class="n">display</span> <span class="n">the</span> <span class="n">fields</span><span class="p">,</span> <span class="n">hilighting</span> <span class="n">subhits</span> <span class="o">*/</span>
         <span class="n">freemmoffs</span><span class="p">(</span><span class="n">mmo</span><span class="p">);</span>                    <span class="o">/*</span> <span class="n">free</span> <span class="n">Metamorph</span> <span class="n">info</span> <span class="o">*/</span>
      <span class="p">}</span>
   <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="modifying-the-server">
<h2>Modifying the server<a class="headerlink" href="#modifying-the-server" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;dbquery.h&quot;</span>

<span class="n">void</span> <span class="n">adduserfuncs</span><span class="p">(</span><span class="n">fo</span><span class="p">)</span>
<span class="n">FLDOP</span> <span class="o">*</span><span class="n">fo</span><span class="p">;</span>
</pre></div>
</div>
<p>This section describes how to add user defined types and functions to
the texis server. The file aufex.c in the api directory provides an
outline of how to do this. The server calls the function adduserfuncs
which gives you the opportunity to add data types, operators and
functions to the server. There are three functions that are used for
adding to the server. They are dbaddtype, foaddfuncs and fosetop.</p>
<p>Once you have created your own version of aufex.c you need to compile
and link this file with the rest of the daemon objects. You must make
sure that this file is linked before the libraries to make sure your
function gets called. An example makefile is also included in the api
directory which shows the needed objects and include paths to make a new
daemon. After a new daemon has been created, make sure that it is
running and not the standard daemon. See the documentation on texisd to
see how to invoke it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">dbaddtype</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
<span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="nb">int</span> <span class="nb">type</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">size</span><span class="p">;</span>
</pre></div>
</div>
<dl class="simple">
<dt>name</dt><dd><p>the new name for the type. It should not start with the string
“var”, as that is reserved for declaring the variable size form of
the datatype.</p>
</dd>
<dt>type</dt><dd><p>an integer which is used to refer to the type in functions etc. For
a user added type this number should be between 32 and 63 inclusive.
This number should be unique.</p>
</dd>
<dt>size</dt><dd><p>the size of one element of the datatype. When one item of this type
is written to the database, at least size bytes will be transferred.</p>
</dd>
</dl>
<p>The function will return 0 if successful, and -1 if there is no room for
more datatypes, or if a type with a different name already exists with
the same type number.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">tagTIMESTAMP</span>
<span class="p">{</span>
   <span class="n">short</span>           <span class="n">year</span><span class="p">;</span>
   <span class="n">unsigned</span> <span class="n">short</span>  <span class="n">month</span><span class="p">;</span>
   <span class="n">unsigned</span> <span class="n">short</span>  <span class="n">day</span><span class="p">;</span>
   <span class="n">unsigned</span> <span class="n">short</span>  <span class="n">hour</span><span class="p">;</span>
   <span class="n">unsigned</span> <span class="n">short</span>  <span class="n">minute</span><span class="p">;</span>
   <span class="n">unsigned</span> <span class="n">short</span>  <span class="n">second</span><span class="p">;</span>
   <span class="n">unsigned</span> <span class="n">long</span>   <span class="n">fraction</span><span class="p">;</span>
<span class="p">}</span> <span class="n">TIMESTAMP</span><span class="p">;</span>

<span class="n">dbaddtype</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;dbquery.h&quot;</span>

<span class="nb">int</span> <span class="n">foaddfuncs</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">FLDOP</span> <span class="o">*</span><span class="n">fo</span><span class="p">;</span>
<span class="n">FLDFUNC</span> <span class="o">*</span><span class="n">ff</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">n</span><span class="p">;</span>
</pre></div>
</div>
<p>Foaddfuncs adds a function to the math unit of Texis. The function can
take up to five arguments, and returns a single argument. The function
will be called with pointers to FLD structures. The return values should
be stuffed into the pointer to the first argument.</p>
<p>The math unit takes care of all the required stack manipulation, so no
stack manipulation is required in the function. The math unit will
always pass the maximum number of arguments to the function.</p>
<p>Foaddfuncs takes an array of function descriptions as one of its
arguments. The functions description function looks like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="p">{</span>
   <span class="n">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>                                  <span class="o">/*</span> <span class="n">name</span> <span class="n">of</span> <span class="n">function</span> <span class="o">*/</span>
   <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)();</span>                                        <span class="o">/*</span> <span class="n">handler</span> <span class="o">*/</span>
   <span class="nb">int</span>   <span class="n">minargs</span><span class="p">;</span>                 <span class="o">/*</span> <span class="n">minimum</span> <span class="c1"># of arguments allowed */</span>
   <span class="nb">int</span>   <span class="n">maxargs</span><span class="p">;</span>                 <span class="o">/*</span> <span class="n">maximum</span> <span class="c1"># of arguments allowed */</span>
   <span class="nb">int</span>   <span class="n">rettype</span><span class="p">;</span>                                    <span class="o">/*</span> <span class="k">return</span> <span class="nb">type</span> <span class="o">*/</span>
   <span class="nb">int</span>   <span class="n">types</span><span class="p">[</span><span class="n">MAXFLDARGS</span><span class="p">];</span>   <span class="o">/*</span> <span class="n">argument</span> <span class="n">types</span><span class="p">,</span> <span class="mi">0</span> <span class="n">means</span> <span class="n">don</span><span class="s1">&#39;t care */</span>
<span class="p">}</span> <span class="n">FLDFUNC</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt>fo</dt><dd><p>The math unit to add to.</p>
</dd>
<dt>ff</dt><dd><p>Array of function descriptions to be added.</p>
</dd>
<dt>n</dt><dd><p>The number of functions being added.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>
<span class="n">fsqr</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">FLD</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
<span class="p">{</span>
   <span class="nb">int</span>     <span class="n">x</span><span class="p">;</span>
   <span class="n">size_t</span>  <span class="n">sz</span><span class="p">;</span>

   <span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">ft_int</span> <span class="o">*</span><span class="p">)</span><span class="n">getfld</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sz</span><span class="p">);</span>      <span class="o">/*</span> <span class="n">Get</span> <span class="n">the</span> <span class="n">number</span> <span class="o">*/</span>
   <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="p">;</span>                              <span class="o">/*</span> <span class="n">Square</span> <span class="n">it</span> <span class="o">*/</span>
   <span class="n">putfld</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>                    <span class="o">/*</span> <span class="n">Put</span> <span class="n">the</span> <span class="n">result</span> <span class="o">*/</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">FLDFUNC</span>  <span class="n">dbfldfuncs</span><span class="p">[]</span><span class="o">=</span>
<span class="p">{</span>
   <span class="p">{</span><span class="s2">&quot;sqr&quot;</span><span class="p">,</span>   <span class="n">fsqr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FTN_INT</span><span class="p">,</span> <span class="n">FTN_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>
<span class="c1">#define NFLDFUNCS (sizeof(dbfldfuncs)/sizeof(dbfldfuncs[0]))</span>

<span class="n">foaddfuncs</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="n">dbfldfuncs</span><span class="p">,</span> <span class="n">NFLDFUNCS</span><span class="p">);</span>
</pre></div>
</div>
<p>This will add a function to square an integer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;dbquery.h&quot;</span>

<span class="nb">int</span> <span class="n">fosetop</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">ofunc</span><span class="p">)</span>
<span class="n">FLDOP</span> <span class="o">*</span><span class="n">fo</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">type1</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">type2</span><span class="p">;</span>
<span class="n">fop_type</span> <span class="n">func</span><span class="p">;</span>
<span class="n">fop_type</span> <span class="o">*</span><span class="n">ofunc</span><span class="p">;</span>
</pre></div>
</div>
<p>Fosetop changes a binary operator in the math unit of Texis. The
function func will be called for all operations on (type1, type2). If
the function does not know how to handle the specific operation, and
ofunc is not NULL, ofunc can be called to hande the operation.</p>
<p>The function being called should look like</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>
<span class="n">func</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="n">FLD</span> <span class="o">*</span><span class="n">f1</span><span class="p">;</span>
<span class="n">FLD</span> <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
<span class="n">FLD</span> <span class="o">*</span><span class="n">f3</span><span class="p">;</span>
<span class="nb">int</span> <span class="n">op</span><span class="p">;</span>
<span class="p">{</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Parameters</strong></p>
<dl class="simple">
<dt>fo</dt><dd><p>The math unit to change.</p>
</dd>
<dt>type1</dt><dd><p>The type of the first operand.</p>
</dd>
<dt>type2</dt><dd><p>The type of the second operand.</p>
</dd>
<dt>func</dt><dd><p>Pointer to the function to perform the operation.</p>
</dd>
<dt>ofunc</dt><dd><p>Pointer to pointer to function. The pointer to function will be
stuffed with the old function to perform the operation. This can be
used to add some cases, and keep the old functionality in others.
The return value should be 0 for success. The result of the
operation should be put in f3.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;sys/types.h&gt;</span>
<span class="c1">#include &quot;dbquery.h&quot;</span>

<span class="n">fop_type</span> <span class="n">o_ftich</span><span class="p">;</span>          <span class="o">/*</span> <span class="n">the</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">handler</span> <span class="o">*/</span>

<span class="nb">int</span>
<span class="n">n_ftich</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
<span class="n">FLD</span>     <span class="o">*</span><span class="n">f1</span><span class="p">;</span>
<span class="n">FLD</span>     <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
<span class="n">FLD</span>     <span class="o">*</span><span class="n">f2</span><span class="p">;</span>
<span class="nb">int</span>     <span class="n">op</span><span class="p">;</span>
<span class="p">{</span>
        <span class="n">TIMESTAMP</span>       <span class="o">*</span><span class="n">ts</span><span class="p">;</span>
        <span class="n">double</span>          <span class="n">d</span><span class="p">;</span>
        <span class="nb">int</span>             <span class="n">n</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">!=</span> <span class="n">FOP_ASN</span><span class="p">)</span>      <span class="o">/*</span> <span class="n">We</span> <span class="n">only</span> <span class="n">know</span> <span class="n">about</span> <span class="n">assignment</span><span class="o">.</span> <span class="o">*/</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">o_ftich</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">o_ftich</span><span class="p">)(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">op</span><span class="p">));</span>
                <span class="k">else</span>
                        <span class="k">return</span> <span class="n">FOP_EINVAL</span><span class="p">;</span>

        <span class="o">/*</span> <span class="n">Set</span> <span class="n">up</span> <span class="n">the</span> <span class="k">return</span> <span class="n">field</span><span class="o">.</span> <span class="o">*/</span>
        <span class="n">f3</span><span class="o">-&gt;</span><span class="nb">type</span> <span class="o">=</span> <span class="n">FTN_TIMESTAMP</span><span class="p">;</span>
        <span class="n">f3</span><span class="o">-&gt;</span><span class="n">elsz</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">);</span>
        <span class="n">f3</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">);</span>
        <span class="n">f3</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">f3</span><span class="o">-&gt;</span><span class="n">alloced</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">void</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>

                <span class="n">v</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">));</span>
                <span class="n">setfld</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">));</span>
                <span class="n">f3</span><span class="o">-&gt;</span><span class="n">alloced</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">);</span>
        <span class="p">}</span>

<span class="o">/*</span> <span class="n">First</span> <span class="mi">0</span> <span class="n">out</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">elements</span> <span class="o">*/</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">getfld</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">year</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">month</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">day</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">hour</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">minute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ts</span><span class="o">-&gt;</span><span class="n">fraction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="o">/*</span> <span class="n">Now</span> <span class="n">read</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">values</span> <span class="o">*/</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">getfld</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">NULL</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%hu</span><span class="s2">/</span><span class="si">%hu</span><span class="s2">/</span><span class="si">%hd</span><span class="s2"> </span><span class="si">%hu</span><span class="s2">:</span><span class="si">%hu</span><span class="s2">:</span><span class="si">%hu%lf</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">month</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">day</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">year</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">hour</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">minute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>

<span class="o">/*</span> <span class="n">Convert</span> <span class="nb">any</span> <span class="n">fractional</span> <span class="n">seconds</span> <span class="n">into</span> <span class="n">the</span> <span class="n">appropriate</span> <span class="n">number</span>
   <span class="n">of</span> <span class="n">billionths</span> <span class="n">of</span> <span class="n">a</span> <span class="n">second</span><span class="o">.</span>
<span class="o">*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">ts</span><span class="o">-&gt;</span><span class="n">fraction</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*</span> <span class="mi">1000000000</span> <span class="p">;</span>
<span class="p">}</span>

 <span class="o">.</span>
 <span class="o">.</span>
 <span class="o">.</span>
        <span class="n">fosetop</span><span class="p">(</span><span class="n">fo</span><span class="p">,</span> <span class="n">FTN_TIMESTAMP</span><span class="p">,</span> <span class="n">FTN_CHAR</span><span class="p">,</span> <span class="n">n_ftich</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">o_ftich</span><span class="p">);</span>
 <span class="o">.</span>
 <span class="o">.</span>
 <span class="o">.</span>
</pre></div>
</div>
<p>This example adds an operator to allow the assignment of a TIMESTAMP
field from a character string. See dbaddtype for the definition of
TIMESTAMP.</p>
<dl class="footnote brackets">
<dt class="label" id="id16"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">SERVERPN</span></code> is a synonym for <code class="docutils literal notranslate"><span class="pre">(SERVER*)NULL</span></code></p>
</dd>
<dt class="label" id="id17"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">TSQLPN</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">(TSQL</span> <span class="pre">*)NULL</span></code>.</p>
</dd>
<dt class="label" id="id18"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">MMOFFSPN</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">(MMOFFS</span> <span class="pre">*)NULL</span></code></p>
</dd>
<dt class="label" id="id19"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">XPMIPN</span></code> is a synonym for <code class="docutils literal notranslate"><span class="pre">(XPMI*)NULL</span></code></p>
</dd>
<dt class="label" id="id20"><span class="brackets"><a class="fn-backref" href="#id15">5</a></span></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">MMOFFSPN</span></code> is an alias for <code class="docutils literal notranslate"><span class="pre">(MMOFFS</span> <span class="pre">*)NULL</span></code></p>
</dd>
</dl>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Moat Crossing Systems.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>